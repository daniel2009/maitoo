var jw_commodity_rate=0;
var lowest_weight_value=0;
var price_carry_flag=0;
var tran_price_table;
var mux_tran_box_rate=0;
var tran_price_carry_flag=0;//默认转运计算方法
var premium_max_value=0;//保险的最大赔偿的额度
var premium_rate=0;//保险比例
var print_orders_for_low_state=0;
var cur_usa_cn=0;//当前汇率

//获取转运价格表
function get_tranpricetable() {
	$.ajax({
		type : "post",
		url : "../tranprice/get_all",
		success : function(response) {
			var code = response.code;

			if ("200" == code) {

				if (response.data != null) {
					tran_price_table=response.data;
				} else {

				}
			} else {

			}
			
		}
	});
}

function getglobalargs_commrate() {
	var flags = "jw_commodity_rate,lowest_weight_value_flag,price_carry_flag,mux_tran_box_rate,tran_price_carry_flag,premium_max_value,premium_rate,print_orders_for_low_state,cur_usa_cn";//获取商品进位值
	$.ajax({
		type : "post",
		url : admin_globalargs_getcontents_url,
		data : {
			"flags" : flags
		},
		success : function(response) {
			var code = response.code;

			if ("200" == code) {

				if (response.data != null) {
					jw_commodity_rate=response.data[0];	//商品的进位价格
					lowest_weight_value=response.data[1];//商品的最小重量
					price_carry_flag=response.data[2];//商品的进位类型
					mux_tran_box_rate=response.data[3];//转运包裹的分合箱手续费用
					tran_price_carry_flag=response.data[4];//转运价格计算方法
					premium_max_value=response.data[5];//保险的最大额度
					premium_rate=response.data[6];//保险的比例
					print_orders_for_low_state=response.data[7];//表示是否可以打印未付款运单
					cur_usa_cn=response.data[8];//当前汇率
					//alert(jw_commodity_rate);
				} else {

				}
			} else {

			}
			
		}
	});
}
//保险额度计算
function countpremiummoney_user()
{
	var rate=premium_rate;
	if((rate=="0")||(removenull(rate)==null))
	{
		return false;
	}
	rate = parseFloat(rate);
	if (isNaN(rate))
	{
		return false;
	}
	var premium1=parseFloat($(":text[name='premium']").val());
	if(isNaN(premium1))
	{
		return false;
	}
	if(premium1>0)
	{}
	else if(premium1<0)
	{
		alert("保险不能小于0!");
		return false;
	}
	else
	{
		return false;
	}
	var premiumt=parseFloat(premium1/rate);
	if (isNaN(premiumt))
	{
		return false;
	}
	if(parseFloat(premium_max_value)!="NaN")
	{
		if(premiumt>parseFloat(premium_max_value))
		{
			alert("最大保险额度不能超过"+premium_max_value+"美元!");
			$(":text[name='premium']").val(premium_max_value*rate);
			$(":text[name='premiumtotal']").val(premium_max_value);
		}
		else 
		{
			$(":text[name='premiumtotal']").val(premiumt);
		}
	}
	else
	{
		$(":text[name='premiumtotal']").val(premiumt);
	}
	
}
function orderModifyCalcFreight() {
	// var type = $(":hidden[name='type']").val();
	// var maxPrice=0.00;
	countpremiummoney_user();
	var userType = $(":hidden[name='userType']").val();
	var moneyType = "price";
	if (userType == "0") {
		//moneyType = "price";
		//kai 20151123 普通会员按门市价钱来算
		//moneyType = "price";
		moneyType = "msPrice";
	} else if (userType == "1") {
		moneyType = "msPrice";
	} else if (userType == "2") {
		moneyType = "vipOnePrice";
	} else if (userType == "3") {
		moneyType = "vipTwoPrice";
	} else if (userType == "4") {
		moneyType = "vipThreePrice";
	} else {
		moneyType = "price";
	}
	var commodityPrice = 0.00;
	var commodityweighttotal = 0.00;
	var commodityjwweighttotal=0.00;
	var additiveweight=0.00;//附加重量
	var lowestprice=0.00;
	var highestprice=0.00;
	$("select[name='commodityId']").each(
			function() {
				
				//先进位计算
				var jwweight=$(this).parent().parent().find(":text[name='jwweight']").val();
				//alert(jwweight);
				jwweight=parseFloat(jwweight);
				var j=parseInt(jwweight);
				//alert(j);
				if((price_carry_flag=="1")||(price_carry_flag=="2")||(price_carry_flag=="3")||(price_carry_flag=="4"))
				{
					if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
					{
						if((jwweight-j)>jw_commodity_rate)
						{
							$(this).parent().parent().find(":text[name='sjweight']").val(j+1);
						}
						else
						{
							
							if((price_carry_flag=="3")||(price_carry_flag=="4"))//不退位
							{
								$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
							}
							else
							{
								$(this).parent().parent().find(":text[name='sjweight']").val(j);
							}
							//$(this).parent().parent().find(":text[name='sjweight']").val(j);
						}
					}
					else
					{
						$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
					}
				}
				else
				{
					$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
				}
				
				if(lowestprice!=0.00)
				{
					if(lowestprice>parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				if(highestprice!=0.00)
				{
					if(highestprice<parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				
				var sjweight = $(this).parent().parent().find(
				":text[name='sjweight']").val();
				commodityPrice = commodityPrice
						+ parseFloat($(this).find("option:selected").attr(
								moneyType)) * sjweight;
				// kai 20150912
				commodityweighttotal = commodityweighttotal
						+ parseFloat(sjweight);
				
				commodityjwweighttotal = commodityjwweighttotal
				+ parseFloat(jwweight);
			});
	
	
	if(commodityweighttotal<parseFloat(lowest_weight_value))
	{
		if((price_carry_flag!="0"))
		{
			additiveweight=parseFloat(lowest_weight_value)-commodityweighttotal;
			commodityweighttotal=parseFloat(lowest_weight_value);
		}
	}
	else
	{
		//表示商品总重量按照jw_commodity_rate进位，进位重量按价格最高的商品计算。
		//表示商品总重量按照jw_commodity_rate进位，进位重量按照商品价格最低的来进行计算。
		if((price_carry_flag=="5")||(price_carry_flag=="6")||(price_carry_flag=="7")||(price_carry_flag=="8"))
		{
			var j=parseInt(commodityweighttotal);
			if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
			{
				//alert("1");
				if((commodityweighttotal-j)>jw_commodity_rate)
				{
					additiveweight=j+1-commodityweighttotal;
					commodityweighttotal=j+1;
					
				}
				else
				{
					if((price_carry_flag=="5")||(price_carry_flag=="6"))//退位计算
					{
						additiveweight=j-commodityweighttotal;//退位计算
						commodityweighttotal=j;
					}
					else if((price_carry_flag=="7")||(price_carry_flag=="8"))//按实际计算
					{
						
					}
					else
					{
						
					}
				}
			}
			else
			{
				commodityweighttotal=commodityjwweighttotal;
			}
			
		}
	}
	
	$(":text[name='sum_weight']").val(commodityjwweighttotal.toString());
	$(":text[name='weight']").val(commodityweighttotal.toString());
	
	var weight = parseFloat($(":text[name='weight']").val());
	var tariff = parseFloat($(":text[name='tariff']").val());
	var other = parseFloat($(":text[name='other']").val());
	//var premium = parseFloat($(":hidden[name='premium']").val());
	var premium = parseFloat($(":text[name='premium']").val());
	if (premium == "NaN") {
		premium = parseFloat($(":hidden[name='premium']").val());
	}
	
	var length = parseFloat($(":text[name='length']").val());
	var width = parseFloat($(":text[name='width']").val());
	var height = parseFloat($(":text[name='height']").val());
	
	
	
	var addtivePrice = parseFloat($(":text[name='addtivePrice']").val());
	if(additiveweight<=-1)
	{
		additiveweight=0;
	}
	if((price_carry_flag=="1")||(price_carry_flag=="3"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}//2：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最低价计算。
	else if((price_carry_flag=="2")||(price_carry_flag=="4"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	else if((price_carry_flag=="5")||(price_carry_flag=="7"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}
	else if((price_carry_flag=="6")||(price_carry_flag=="8"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	
	
	var totalMoney = commodityPrice + tariff + other+addtivePrice+ premium + length * width
			* height / 166;
	// kai 20150912
	
	var f_x = parseFloat(totalMoney);
	if (isNaN(commodityPrice)) {
		alert('商品类型中的重量填写错误！');
		return false;
	}
	if (isNaN(weight)) {
		alert('重量输入错误！');
		return false;
	}

	if (isNaN(length * width * height / 166)) {
		alert('长宽高输入错误！');
		return false;
	}
	if (isNaN(f_x)) {
		alert('计算总价钱错误，可能是参数填写错误！');
		return false;
	}
	var f_x = Math.round(totalMoney * 100) / 100;

	var s_x = f_x.toString();
	var pos_decimal = s_x.indexOf('.');
	if (pos_decimal < 0) {
		pos_decimal = s_x.length;
		s_x += '.';
	}
	while (s_x.length <= pos_decimal + 2) {
		s_x += '0';
	}
	$(":text[name='totalmoney']").val(s_x);
}

function msOrderCalcFreight() {
	// var maxPrice=0.00;
	countpremiummoney_user();
	var userType = $(":hidden[name='userType']").val();
	var moneyType = "price";
	
	if (userType == "0") {
		//kai 20151123 普通会员按门市价钱来算
		//moneyType = "price";
		moneyType = "msPrice";
	} else if (userType == "1") {
		moneyType = "msPrice";
	} else if (userType == "2") {
		moneyType = "vipOnePrice";
	} else if (userType == "3") {
		moneyType = "vipTwoPrice";
	} else if (userType == "4") {
		moneyType = "vipThreePrice";
	} else {
		moneyType = "price";
	}
	var commodityPrice = 0.00;
	var commodityweighttotal = 0.00;
	var commodityjwweighttotal=0.00;
	var additiveweight=0.00;//附加重量
	var lowestprice=0.00;
	var highestprice=0.00;
	$("select[name='commodityName']").each(
			function() {
				//先进位计算
				var jwweight=$(this).parent().find(":text[name='jwweight']").val();
				//alert(jwweight);
				jwweight=parseFloat(jwweight);
				var j=parseInt(jwweight);
				//alert(j);
				
				//alert(jw_commodity_rate);
				//退位计算
				if((price_carry_flag=="1")||(price_carry_flag=="2")||(price_carry_flag=="3")||(price_carry_flag=="4"))
				{
					if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
					{
						//alert("1");
						if((jwweight-j)>jw_commodity_rate)
						{
							$(this).parent().find(":text[name='sjweight']").val(j+1);
						}
						else
						{
							if((price_carry_flag=="3")||(price_carry_flag=="4"))//不退位
							{
								$(this).parent().find(":text[name='sjweight']").val(jwweight);
							}
							else
							{
								$(this).parent().find(":text[name='sjweight']").val(j);
							}
							
						}
					}
					else
					{
						$(this).parent().find(":text[name='sjweight']").val(jwweight);
					}
				}
				else
				{
					$(this).parent().find(":text[name='sjweight']").val(jwweight);
				}
				
				var sjweight = $(this).parent().find(":text[name='sjweight']")
				.val();
			
				//保存商品的最低价格和最高价格
				if(lowestprice!=0.00)
				{
					if(lowestprice>parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				if(highestprice!=0.00)
				{
					if(highestprice<parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				commodityPrice = commodityPrice
						+ parseFloat($(this).find("option:selected").attr(
								moneyType)) * sjweight;
				// maxPrice = maxPrice>msPrice?maxPrice:msPrice;
				// kai 20150913
				
				commodityweighttotal = commodityweighttotal
						+ parseFloat(sjweight);
				commodityjwweighttotal = commodityjwweighttotal
				+ parseFloat(jwweight);
				
				
				
			});

	// kai 20150913
	//如果商品小于最低重量，将按最低重量来计算
	if(commodityweighttotal<parseFloat(lowest_weight_value))
	{
		if((price_carry_flag!="0"))
		{
			additiveweight=parseFloat(lowest_weight_value)-commodityweighttotal;
			commodityweighttotal=parseFloat(lowest_weight_value);
		}
	}
	else
	{
		//表示商品总重量按照jw_commodity_rate进位，进位重量按价格最高的商品计算。
		//表示商品总重量按照jw_commodity_rate进位，进位重量按照商品价格最低的来进行计算。
		if((price_carry_flag=="5")||(price_carry_flag=="6")||(price_carry_flag=="7")||(price_carry_flag=="8"))
		{
			var j=parseInt(commodityweighttotal);
			if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
			{
				//alert("1");
				if((commodityweighttotal-j)>jw_commodity_rate)
				{
					additiveweight=j+1-commodityweighttotal;
					commodityweighttotal=j+1;
					
				}
				else
				{
					if((price_carry_flag=="5")||(price_carry_flag=="6"))//退位计算
					{
						additiveweight=j-commodityweighttotal;//退位计算
						commodityweighttotal=j;
					}
					else if((price_carry_flag=="7")||(price_carry_flag=="8"))//按实际计算
					{
						
					}
					else
					{
						
					}
				}
			}
			else
			{
				commodityweighttotal=commodityjwweighttotal;
			}
			
		}
	}
	
	$(":text[name='weight']").val(commodityweighttotal.toString());
	
	$(":text[name='sum_weight']").val(commodityjwweighttotal.toString());
	
	var weight = parseFloat($(":text[name='weight']").val());
	var tariff = parseFloat($(":text[name='tariff']").val());
	var other = parseFloat($(":text[name='other']").val());
	var premium = parseFloat($(":text[name='premium']").val());
	
	var addtivePrice = parseFloat($(":text[name='addtivePrice']").val());//渠道包裹的附加费
	//1：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最高价计算。
	//alert(commodityPrice);
	//alert(additiveweight);
	//计算商品价格时，进位的计算方法。
	//0：表示原重量计算，即不进行任何进位和换算，默认取值。
	//1：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最高价计算。
	//2：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最低价计算。
	//3：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将按实际计算。如果低于lowest_weight_value_flag，多的按最高价计算。
	//4：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将按实际计算。如果低于lowest_weight_value_flag，多的按最低价计算。
	//5：表示商品总重量按照jw_commodity_rate进位，进位重量按价格最高的商品计算，小于部分将退位计算，退位部分按最高价格计算。。
	//6：表示商品总重量按照jw_commodity_rate进位，进位重量按照商品价格最低的来进行计算，小于部分将退位计算，退位部分按最低价格计算。。
	//7：表示商品总重量按照jw_commodity_rate进位，进位重量按价格最高的商品计算，小于部分按实际计算。
	//8：表示商品总重量按照jw_commodity_rate进位，进位重量按照商品价格最低的来进行计算，小于部分按实际计算。。
	//alert(additiveweight);
	if(additiveweight<=-1)
	{
		additiveweight=0;
	}
	//alert(additiveweight);
	//alert(addtivePrice);
	
	if((price_carry_flag=="1")||(price_carry_flag=="3"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}//2：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最低价计算。
	else if((price_carry_flag=="2")||(price_carry_flag=="4"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	else if((price_carry_flag=="5")||(price_carry_flag=="7"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}
	else if((price_carry_flag=="6")||(price_carry_flag=="8"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	
	//alert(addtivePrice);

	var length = parseFloat($(":text[name='length']").val());
	var width = parseFloat($(":text[name='width']").val());
	var height = parseFloat($(":text[name='height']").val());
	var totalMoney = commodityPrice + tariff + other + premium +addtivePrice+ length * width
			* height / 166;
	var f_x = parseFloat(totalMoney);

	if (isNaN(commodityPrice)) {
		alert('商品类型中的重量填写错误！');
		return false;
	}
	if (isNaN(weight)) {
		alert('重量输入错误！');
		return false;
	}

	if (isNaN(length * width * height / 166)) {
		alert('长宽高输入错误！');
		return false;
	}
	if (isNaN(f_x)) {
		alert('计算总价钱错误，可能是参数填写错误！');
		return false;
	}
	var f_x = Math.round(totalMoney * 100) / 100;

	var s_x = f_x.toString();
	var pos_decimal = s_x.indexOf('.');
	if (pos_decimal < 0) {
		pos_decimal = s_x.length;
		s_x += '.';
	}
	while (s_x.length <= pos_decimal + 2) {
		s_x += '0';
	}
	$(":text[name='totalmoney']").val(s_x);
}
function orderModifyCalcFreight_dhyb() {
	// var type = $(":hidden[name='type']").val();
	// var maxPrice=0.00;
	
	countpremiummoney_user();
	var userType = $(":hidden[name='userType']").val();
	var moneyType = "price";
	if (userType == "0") {
		//moneyType = "price";
		//kai 20151123 普通会员
		moneyType = "price";
		//moneyType = "msPrice";
	} else if (userType == "1") {
		moneyType = "price";//转运的门市会员按转运价格来计算
	} else if (userType == "2") {
		moneyType = "vipOnePrice";
	} else if (userType == "3") {
		moneyType = "vipTwoPrice";
	} else if (userType == "4") {
		moneyType = "vipThreePrice";
	} else {
		moneyType = "price";
	}
	var commodityPrice = 0.00;
	var commodityweighttotal = 0.00;
	var commodityjwweighttotal=0.00;
	var additiveweight=0.00;//附加重量
	var lowestprice=0.00;
	var highestprice=0.00;
	var or=0.00;
	var or_self=0.00;
	var or_CommodityCost=0.00;
	
	
	if((tran_price_carry_flag!="5")||(tran_price_carry_flag!="6")||(tran_price_carry_flag!="7")||(tran_price_carry_flag!="8"))
	{
		tran_price_carry_flag=5;
	}
	
	
	$("select[name='commodityId']").each(
			function() {						
				//先进位计算
				//var jwweight=$(this).parent().parent().find(":text[name='sjweight']").val();
				//alert(jwweight);
				jwweight=parseFloat(jwweight);
				var j=parseInt(jwweight);
				//alert(j);
				if((tran_price_carry_flag=="1")||(tran_price_carry_flag=="2")||(tran_price_carry_flag=="3")||(tran_price_carry_flag=="4"))
				{
					if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
					{
						if((jwweight-j)>jw_commodity_rate)
						{
							$(this).parent().parent().find(":text[name='sjweight']").val(j+1);
						}
						else
						{
							
							if((tran_price_carry_flag=="3")||(tran_price_carry_flag=="4"))//不退位
							{
								$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
							}
							else
							{
								$(this).parent().parent().find(":text[name='sjweight']").val(j);
							}
							//$(this).parent().parent().find(":text[name='sjweight']").val(j);
						}
					}
					else
					{
						$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
					}
				}
				else
				{
					$(this).parent().parent().find(":text[name='sjweight']").val(jwweight);
				}
				
				if(lowestprice!=0.00)
				{
					if(lowestprice>parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					lowestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				if(highestprice!=0.00)
				{
					if(highestprice<parseFloat($(this).find("option:selected").attr(moneyType)))
					{
						highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
					}
				}
				else
				{
					highestprice=parseFloat($(this).find("option:selected").attr(moneyType));
				}
				
				var eachjweight=$(this).parent().parent().find(
				":text[name='eachsjweight']").val();
				
				var quantity=$(this).parent().parent().find(
				":text[name='quantity']").val();
				var jwweight=parseFloat(quantity)*parseFloat(eachjweight);
				if(jwweight=="NaN")
				{
					alert("单件数量或重量格式不对，请检查!");
					return false;
				}
				
				$(this).parent().parent().find(
				":text[name='sjweight']").val(jwweight);
				
				var sjweight = $(this).parent().parent().find(
				":text[name='sjweight']").val();
				commodityPrice = commodityPrice
						+ parseFloat($(this).find("option:selected").attr(
								moneyType)) * sjweight;
				// kai 20150912
				commodityweighttotal = commodityweighttotal
						+ parseFloat(sjweight);
				
				commodityjwweighttotal = commodityjwweighttotal
				+ parseFloat(jwweight);
				
				
				
				//计算转运价格
				var commodify_tranwarehouseid=$(this).parent().parent().find(":text[name='commodify_tranwarehouseid']").val();
				
				$(":hidden[name='count_emp_store_id']").val($("select[name='warehouse']").val());//标识计费仓库id

				if((removenull($(":hidden[name='count_emp_store_id']").val())=="")||(removenull(commodify_tranwarehouseid)==""))
				{}
				else
				{
					if(removenull($(":hidden[name='count_emp_store_id']").val())!=removenull(commodify_tranwarehouseid))
					{
						
						$.each(
								tran_price_table,
								function() {
									
									if(this.warehouseId==removenull($(":hidden[name='count_emp_store_id']").val()))//会员所属仓库id
									{
										if(this.tranwarehouseId==removenull(commodify_tranwarehouseid))//转运州过来的id
										{
											//alert(this.price);
											//alert(parseFloat(jwweight));
											or+=parseFloat(jwweight)*parseFloat(this.price);
											or_self+=parseFloat(jwweight)*parseFloat(this.selfPrice);
											or_CommodityCost+=parseFloat(jwweight)*parseFloat(this.cost);
											
											
										}
									}
								});
					}
				}
				
				
			});
	//alert(or);
	$(":hidden[name='t_CommodityCost']").val(or_CommodityCost);
	
	if(commodityweighttotal<parseFloat(lowest_weight_value))
	{
		if((tran_price_carry_flag!="0"))
		{
			additiveweight=parseFloat(lowest_weight_value)-commodityweighttotal;
			commodityweighttotal=parseFloat(lowest_weight_value);
		}
	}
	else
	{
		//表示商品总重量按照jw_commodity_rate进位，进位重量按价格最高的商品计算。
		//表示商品总重量按照jw_commodity_rate进位，进位重量按照商品价格最低的来进行计算。
		if((tran_price_carry_flag=="5")||(tran_price_carry_flag=="6")||(tran_price_carry_flag=="7")||(tran_price_carry_flag=="8"))
		{
			var j=parseInt(commodityweighttotal);
			if((parseFloat(jw_commodity_rate)!="NaN")&&(parseFloat(jw_commodity_rate)>0)&&(parseFloat(jw_commodity_rate)<1))
			{
				//alert("1");
				if((commodityweighttotal-j)>jw_commodity_rate)
				{
					additiveweight=j+1-commodityweighttotal;
					commodityweighttotal=j+1;
					
				}
				else
				{
					if((tran_price_carry_flag=="5")||(tran_price_carry_flag=="6"))//退位计算
					{
						additiveweight=j-commodityweighttotal;//退位计算
						commodityweighttotal=j;
					}
					else if((tran_price_carry_flag=="7")||(tran_price_carry_flag=="8"))//按实际计算
					{
						
					}
					else
					{
						
					}
				}
			}
			else
			{
				commodityweighttotal=commodityjwweighttotal;
			}
			
		}
	}
	
	$(":text[name='sum_weight']").val(commodityjwweighttotal.toString());
	$(":text[name='weight']").val(commodityweighttotal.toString());
	
	var weight = parseFloat($(":text[name='weight']").val());
	var tariff = parseFloat($(":text[name='tariff']").val());
	var other = parseFloat($(":text[name='other']").val());
	//var premium = parseFloat($(":hidden[name='premium']").val());
	var premium = parseFloat($(":text[name='premium']").val());
	if (premium == "NaN") {
		premium = parseFloat($(":hidden[name='premium']").val());
	}
	
	var length = parseFloat($(":text[name='length']").val());
	var width = parseFloat($(":text[name='width']").val());
	var height = parseFloat($(":text[name='height']").val());
	
	
	
	var addtivePrice = parseFloat($(":text[name='addtivePrice']").val());
	if(additiveweight<=-1)
	{
		additiveweight=0;
	}
	if((tran_price_carry_flag=="1")||(tran_price_carry_flag=="3"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}//2：表示单个商品进位计算，即如果超过jw_commodity_rate设置的值，进位到整数，如果小于将退位到整数。如果低于lowest_weight_value_flag，多的按最低价计算。
	else if((tran_price_carry_flag=="2")||(tran_price_carry_flag=="4"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	else if((tran_price_carry_flag=="5")||(tran_price_carry_flag=="7"))
	{
		addtivePrice=addtivePrice+highestprice*additiveweight;
	}
	else if((tran_price_carry_flag=="6")||(tran_price_carry_flag=="8"))
	{
		addtivePrice=addtivePrice+lowestprice*additiveweight;
	}
	
	
	var checkbox =document.getElementsByName("divideboxmoney");	
	var muxtranboxrate=0.00;
	if(checkbox[0].checked==true)
	{
		if(removenull(mux_tran_box_rate)!="")
		{
			muxtranboxrate=parseFloat(mux_tran_box_rate);
			$(":hidden[name='t_divide_money']").val(muxtranboxrate);
			if(isNaN(muxtranboxrate))
			{
				alert("自提手续费设置出错，请检查全局变量mux_tran_box_rate!");
			}
		}
	}
	else
	{
		$(":hidden[name='t_divide_money']").val("0");
	}
	
		
	
//计算转运价格
	
	
	//alert($(":hidden[name='count_emp_store_id']").val());
	//alert($(":hidden[name='count_tranwarehouseId_id']").val());
	
	
	
	
	
	
	var checkbox1 =document.getElementsByName("getpackagebyself");	
	//如果选择了自提,则只计算其它费用和转运费
	if(checkbox1[0].checked==true)
	{
		$(":text[name='or']").val(or_self);
		$(":text[name='totalmoney']").val(or_self+other);
		return false;
	}
	
	
	
	
	$(":text[name='or']").val(or);
	
	
	
	var totalMoney = commodityPrice + tariff +muxtranboxrate+ other+addtivePrice+or+ premium + length * width
			* height / 166;
	// kai 20150912
	
	var f_x = parseFloat(totalMoney);
	if (isNaN(commodityPrice)) {
		alert('商品类型中的重量填写错误！');
		return false;
	}
	if (isNaN(weight)) {
		alert('重量输入错误！');
		return false;
	}

	if (isNaN(length * width * height / 166)) {
		alert('长宽高输入错误！');
		return false;
	}
	if (isNaN(f_x)) {
		alert('计算总价钱错误，可能是参数填写错误！');
		return false;
	}
	var f_x = Math.round(totalMoney * 100) / 100;

	var s_x = f_x.toString();
	var pos_decimal = s_x.indexOf('.');
	if (pos_decimal < 0) {
		pos_decimal = s_x.length;
		s_x += '.';
	}
	while (s_x.length <= pos_decimal + 2) {
		s_x += '0';
	}
	$(":text[name='totalmoney']").val(s_x);
}

function orderModifyCalcFreight_dhyb0105() {
	// var type = $(":hidden[name='type']").val();
	// var maxPrice=0.00;
	var userType = $(":hidden[name='userType']").val();
	var moneyType = "price";
	if (userType == "0") {
		moneyType = "price";
	} else if (userType == "1") {
		moneyType = "msPrice";
	} else if (userType == "2") {
		moneyType = "vipOnePrice";
	} else if (userType == "3") {
		moneyType = "vipTwoPrice";
	} else if (userType == "4") {
		moneyType = "vipThreePrice";
	} else {
		moneyType = "price";
	}
	var commodityPrice = 0.00;
	var commodityweighttotal = 0.00;
	$("select[name='commodityId']").each(
			function() {
				
				
				var eachjweight=$(this).parent().parent().find(
				":text[name='eachsjweight']").val();
				
				var quantity=$(this).parent().parent().find(
				":text[name='quantity']").val();
				
				
				jweight=parseFloat(quantity)*parseFloat(eachjweight);
				if(jweight=="NaN")
				{
					alert("单件数量或重量格式不对，请检查!");
					return false;
				}
				
				$(this).parent().parent().find(
				":text[name='sjweight']").val(jweight);
				
				var sjweight = $(this).parent().parent().find(
						":text[name='sjweight']").val();
				commodityPrice = commodityPrice
						+ parseFloat($(this).find("option:selected").attr(
								moneyType)) * sjweight;
				// kai 20150912
				
				
				commodityweighttotal = commodityweighttotal
						+ parseFloat(sjweight);
			});
	
	//计算转运价格
	
	var or=0.00;
	//alert($(":hidden[name='count_emp_store_id']").val());
	//alert($(":hidden[name='count_tranwarehouseId_id']").val());
	$(":hidden[name='count_emp_store_id']").val($("select[name='warehouse']").val());//标识计费仓库id
	if((removenull($(":hidden[name='count_emp_store_id']").val())=="")||(removenull($(":hidden[name='count_tranwarehouseId_id']").val())==""))
	{}
	else
	{
		if(removenull($(":hidden[name='count_emp_store_id']").val())!=$(":hidden[name='count_tranwarehouseId_id']").val())
		{
			$.each(
					tran_price_table,
					function() {
						if(this.warehouseId==$(":hidden[name='count_emp_store_id']").val())//会员所属仓库id
						{
							if(this.tranwarehouseId==$(":hidden[name='count_tranwarehouseId_id']").val())//转运州过来的id
							{
								or=parseFloat(commodityweighttotal)*parseFloat(this.price);
							}
						}
					});
		}
	}
	
	$(":text[name='or']").val(or);
	$(":text[name='weight']").val(commodityweighttotal);
	// alert(commodityPrice);
	var weight = parseFloat($(":text[name='weight']").val());
	// alert("weight:"+weight);
	var tariff = parseFloat($(":text[name='tariff']").val());
	// alert("tariff:"+tariff);
	var other = parseFloat($(":text[name='other']").val());
	// alert("other:"+other);
	var premium = parseFloat($(":text[name='premium']").val());
	if (premium == "NaN") {
		premium = parseFloat($(":hidden[name='premium']").val());
	}

	// alert("premium:"+premium);
	var length = parseFloat($(":text[name='length']").val());
	// alert("length:"+length);
	var width = parseFloat($(":text[name='width']").val());
	// alert("width:"+width);
	var height = parseFloat($(":text[name='height']").val());
	// alert("height:"+height);
	
	
	var addtivePrice = parseFloat($(":text[name='addtivePrice']").val());//渠道包裹的附加费
	
	var totalMoney = commodityPrice + tariff +addtivePrice+ or+other + premium + length * width
			* height / 166;
	// kai 20150912
	$(":text[name='weight']").val(commodityweighttotal.toString());
	// alert(totalMoney);
	var f_x = parseFloat(totalMoney);
	// alert(f_x);
	if (isNaN(commodityPrice)) {
		alert('商品类型中的重量填写错误！');
		return false;
	}
	if (isNaN(weight)) {
		alert('重量输入错误！');
		return false;
	}

	if (isNaN(length * width * height / 166)) {
		alert('长宽高输入错误！');
		return false;
	}
	if (isNaN(f_x)) {
		alert('计算总价钱错误，可能是参数填写错误！');
		return false;
	}
	var f_x = Math.round(totalMoney * 100) / 100;

	var s_x = f_x.toString();
	var pos_decimal = s_x.indexOf('.');
	if (pos_decimal < 0) {
		pos_decimal = s_x.length;
		s_x += '.';
	}
	while (s_x.length <= pos_decimal + 2) {
		s_x += '0';
	}
	$(":text[name='totalmoney']").val(s_x);
}

/////////////////////////////////////////////////////////////
function loadNav51Data() {
	loadFirstTranshipList();

	$(":submit[name='searchSub']").click(
			function() {
				//alert("222s00");
				var tid = $(":text[name='tid']").val();//改为包裹单号
				$(":text[name='tid']").val("");
				var sdate = $(":text[name='sdate']").val();
				var edate = $(":text[name='edate']").val();
				var key = $(":text[name='key']").val();
				var type = $("select[name='type']").val();

				var state = $("select[name='tran_state']").val();// 转运状态
				var tranType = $("select[name='tran_type']").val();// 转运类型
				var tran_wid = $("select[name='tran_wid_search']").val();// 转运州仓库
				var to_wid = $("select[name='self_wid_search']").val();// 目的仓库，即所属仓库
				if(tran_wid=="-1")
				{
					tran_wid="";
				}
				if(to_wid=="-1")
				{
					to_wid="";
				}
				
				// alert(key);
				if (tid != null && tid != '') {
					$(":text[name='sdate']").val('');
					$(":text[name='edate']").val('');
					$(":text[name='key']").val('');
					$("select[name='type']").val('');
					sdate = '';
					edate = '';
					key = '';
					type = '';
					tranType = '';
					state = '';
					tran_wid='';
					to_wid='';
				}
				//alert("sadfads");
				// loadTranshipList(tid, key, type, sdate, edate, "1");
				
				loadTranshipListnew(tid, key, type, sdate, edate, "1", state,
						tranType,tran_wid,to_wid);
				//alert("sadfads111");
				return false;
			});

	//下载转运清单
/*	$("#downtranlist_search").click(
			
			function() {
				//alert("222s00");
				//alert("333");
				var tid = $(":text[name='tid']").val();//改为包裹单号
				$(":text[name='tid']").val("");
				var sdate = $(":text[name='sdate']").val();
				var edate = $(":text[name='edate']").val();
				var key = $(":text[name='key']").val();
				var type = $("select[name='type']").val();

				var state = $("select[name='tran_state']").val();// 转运状态
				var tranType = $("select[name='tran_type']").val();// 转运类型
				var tran_wid = $("select[name='tran_wid_search']").val();// 转运州仓库
				var to_wid = $("select[name='self_wid_search']").val();// 目的仓库，即所属仓库
				if(tran_wid=="-1")
				{
					tran_wid="";
				}
				if(to_wid=="-1")
				{
					to_wid="";
				}
				
				// alert(key);
				if (tid != null && tid != '') {
					$(":text[name='sdate']").val('');
					$(":text[name='edate']").val('');
					$(":text[name='key']").val('');
					$("select[name='type']").val('');
					sdate = '';
					edate = '';
					key = '';
					type = '';
					tranType = '';
					state = '';
					tran_wid='';
					to_wid='';
				}
				//alert("sadfads");
				// loadTranshipList(tid, key, type, sdate, edate, "1");
				loadTranshipListnew(tid, key, type, sdate, edate, "1", state,
						tranType,tran_wid,to_wid);
				
				
				
				return false;
			});
	
	*/
	
	$("a[name='a_search_by_time']").click(function() {
		var type = $(this).attr("id");
		var date = new Date();
		var date2 = new Date();
		if (type == '4') {
			date2 = new Date(date.getTime() - 1000 * 60 * 60 * 24 * 30);
		} else if (type == '3') {
			date2 = new Date(date.getTime() - 1000 * 60 * 60 * 24 * 7);
		} else if (type == '2') {
			date = new Date(date.getTime() - 1000 * 60 * 60 * 24 * 1);
			date2 = new Date(date2.getTime() - 1000 * 60 * 60 * 24 * 1);
		}
		var year = date.getFullYear();
		var month = date.getMonth() + 1;
		if (month < 10) {
			month = "0" + month;
		}
		var day = date.getDate();
		if (day < 10) {
			day = "0" + day;
		}
		var year1 = date2.getFullYear();
		var month1 = date2.getMonth() + 1;
		if (month1 < 10) {
			month1 = "0" + month1;
		}
		var day1 = date2.getDate();
		if (day1 < 10) {
			day1 = "0" + day1;
		}
		var edate = year + "-" + month + "-" + day;
		var sdate = year1 + "-" + month1 + "-" + day1;
		//loadTranshipList("", "", "", sdate, edate, "1");
		
		loadTranshipListnew("", "", "", sdate, edate, "1", "",
				"","","");
		
		$(":hidden[name='sdate']").val("");
		$(":hidden[name='edate']").val("");
	});

	$("#a_delete_tranship_link")
			.click(
					function() {
						var chk_value = [];
						var flag=true;
						$('input[name="del_id"]:checked').each(function() {
							var state=$(this).parent().parent().find("td[name='stateid']").html();
							//alert(state);
							if((state=="4")||(state=="-8"))//已完成
							{
								
							}
							else
							{
								flag=false;
								return false;
							}
							
							
							chk_value.push($(this).val());
						});
						if(flag==false)
						{
							alert("只有已经完成或已退货的运单可以删除!");
							return;
						}
						if (chk_value.length == 0) {
							alert("您还没有选择要删除的订单(转运单)！");
						} else {
							if (confirm("您是否确认要删除订单(转运单)信息?如果该转运单产生的运单还没有完成流程,删除转运单可能导致在查询运单的过程中某些信息无法获取！")) {
								$.ajax({
									type : "post",
									url : admin_detail_tranship_delete_url,
									data : $.param({
										"id" : chk_value,
									}, true),
									success : function(response) {
										var code = response.code;
										if ("200" == code) {
											alert("删除成功");
											// $("#nav51").click();
											nav51Click();
										} else if ("607" == code) {
											alert("您尚未登录或登录已失效！");
											logout();
										} else {
											alert("删除转运单失败，原因是:"
													+ response.message);
										}
										return false;
									}
								});
							}
						}
						return false;
					});

	$("#t_del_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});
	
	
	//选择仓库操作
	
	$.ajax({
		type : "get",
		async : true,
		url : admin_warehosue_all,
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					var tran_wid = '<option value="-1" selected="selected">请选转运仓库</option>';
					var To_wid='<option value="-1" selected="selected">请选所属仓库</option>';
					
					$.each(response.data, function() {
						if("admin"==$("#admin_id_flag").val())
						{
							
								tran_wid += "<option value='" + this.id + "'>" + this.name
										+ "</option>";
							
								To_wid+= "<option value='" + this.id + "'>" + this.name
								+ "</option>";
								
							
						}
						else
						{
							tran_wid += "<option value='" + this.id + "'>" + this.name
							+ "</option>";
							if(this.id==$("#store_id_flag").val())
							{
								To_wid= "<option value='" + this.id + "'  selected='selected'>" + this.name
								+ "</option>";
							}
						}

					});
					$("select[name='tran_wid_search']").html(tran_wid);
					$("select[name='self_wid_search']").html(To_wid);//从转运州过来要去的门店
					
				}
			}
		}
	});
}




function loadFirstTranshipList() {
	//loadTranshipList("", "", "", "", "", "1");
	loadTranshipListnew("", "", "", "", "", "1", "",
			"","","");
}
function loadTranshipList(tid, key, type, sdate, edate, pn) {
	$(":hidden[name='tid']").val(tid);
	$(":hidden[name='key']").val(key);
	$(":hidden[name='type']").val(type);
	$(":hidden[name='sdate']").val(sdate);
	$(":hidden[name='edate']").val(edate);
	$(":hidden[name='pn']").val(pn);
	$.ajax({
		type : "get",
		url : admin_tranship_list_url,
		data : {
			tid : tid,
			key : key,
			type : type,
			sd : sdate,
			ed : edate,
			pageIndex : pn
		},
		success : function(response) {
			var code = response.code;
			//alert(code);
			if ("200" == code) {
				if (response.data == null) {
					showTranshipList(null);
					showTranshipLink(null);
				} else {
					showTranshipList(response.data.datas);
					showTranshipLink(response.data);
				}
				
				afterLoadTranshipList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='10'>"
						+ "<span>&nbsp;&nbsp;获取转运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}
	});
}


/*
 * kai 添加回车搜索功能
 * 20151027
 * */

function baoguosearchonkey11111(event) {

	event=(event)?event:((window.event)?window.event : "");
	var key=event.keyCode? event.keyCode : event.wihch;
	//alert(key);
		if (key == 13)// 回车事件
		{
			var tid = $(":text[name='tid']").val();//改为包裹单号
			
			var sdate = $(":text[name='sdate']").val();
			var edate = $(":text[name='edate']").val();
			var key = $(":text[name='key']").val();
			var type = $("select[name='type']").val();

			var state = $("select[name='tran_state']").val();// 转运状态
			var tranType = $("select[name='tran_type']").val();// 转运类型
			// alert(key);
			if (tid != null && tid != '') {
				$(":text[name='sdate']").val('');
				$(":text[name='edate']").val('');
				$(":text[name='key']").val('');
				$("select[name='type']").val('');
				sdate = '';
				edate = '';
				key = '';
				type = '';
				tranType = '';
				state = '';
			}

			loadTranshipListnew(tid, key, type, sdate, edate, "1", state,
					tranType);
			//$(":text[name='tid']").val("");
		}
}

//发现重复了
function showTranshipList000(list) {
	var str = "";
	if (list != null) {
		$
				.each(
						list,
						function() {
							str += "<tr id='" + this.id + "'>";
							str += "<td><input type='checkbox' name='del_id' value='"
									+ this.id + "'/></td>";
							str += "<td>" + this.id + "</td>";
							str += "<td>" + this.transitNo + "</td>";
							var pm = "";
							$.each(this.commoditys, function() {
								pm += this.commodityName + ":" + this.quantity
										+ ":" + this.xiangqing + ";";
							});
							str += "<td>" + pm + "</td>";
							str += "<td>" + this.userName + "</td>";
							str += "<td>" + this.userId + "</td>";
							if (this.weight == null) {
								this.weight = "&nbsp;";
							}
							str += "<td>" + this.weight + "</td>";
							if (this.state == "0") {
								str += "<td>未入库</td>";
							} else if (this.state == "1") {
								str += "<td>已入库</td>";
							} else if (this.state == "2") {
								str += "<td>等待审核</td>";
							} else if (this.state == "3") {
								str += "<td>等待付款</td>";
							}  else if (this.state == "4") {
								str += "<td>已付款</td>";
							}else if (this.state == "5") {
								str += "<td>分拣完成</td>";
							} else if (this.state == "-10") {
								str += "<td>包裹异常</td>";
							} else if (this.state == "-7") {
								str += "<td>转运入库</td>";
							} else if (this.state == "-6") {
								str += "<td>转运出库</td>";
							}else if (this.state == "-5") {
								str += "<td>待检入库</td>";
							}
							else if (this.state == "-9") {
								str += "<td>退货中</td>";
							} else if (this.state == "-8") {
								str += "<td>已退货</td>";
							}else {
								str += "<td>" + this.state + "</td>";
							}
							//alert("1");
							//alert(this.state);
							str += "<td name='stateid' style='display:none;'>" + this.state + "</td>";
							str += "<td>" + this.unpackingNumber + "</td>";
							str += "<td>" + this.createDate + "</td>";
							//var unpackingNumber = this.unpackingNumber;
							//if (unpackingNumber > 1) {
								// 拆包
							//	if (this.state == "0") {
							//		str += "<td><a href='#' name='a_tranship_modify_state_link'>入库</a></td>";
							//	}
							//} else {
								// 不是拆包
								
								//str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
						//	}
								
								
									if("admin"==$("#admin_id_flag").val())
									{
										str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
									}
									else
									{
										if(this.warehouseId==$("#store_id_flag").val())
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
										}
										else if((removenull(this.tranWarehouseId)!="")&&(this.state=="-6"))
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
										}
										else
										{
											str += "<td></td>";
										}
									}
									
								
							str += "</tr>";
						});
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='11'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的转运单信息!</span></td>";
		}
	}
	$("#tab1 table tbody").html(str);
}

function showTranshipLink(pageSplit) {
	
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			var tid = $(":text[name='tid']").val();//改为包裹单号
			$(":text[name='tid']").val("");
			var sdate = $(":text[name='sdate']").val();
			var edate = $(":text[name='edate']").val();
			var key = $(":text[name='key']").val();
			var type = $("select[name='type']").val();

			var state = $("select[name='tran_state']").val();// 转运状态
			var tranType = $("select[name='tran_type']").val();// 转运类型
			var tran_wid = $("select[name='tran_wid_search']").val();// 转运州仓库
			var to_wid = $("select[name='self_wid_search']").val();// 目的仓库，即所属仓库
			if(tran_wid=="-1")
			{
				tran_wid="";
			}
			if(to_wid=="-1")
			{
				to_wid="";
			}
			
			// alert(key);
			if (tid != null && tid != '') {
				$(":text[name='sdate']").val('');
				$(":text[name='edate']").val('');
				$(":text[name='key']").val('');
				$("select[name='type']").val('');
				sdate = '';
				edate = '';
				key = '';
				type = '';
				tranType = '';
				state = '';
				tran_wid='';
				to_wid='';
			}
			//alert("sadfads");
			// loadTranshipList(tid, key, type, sdate, edate, "1");
			loadTranshipListnew(tid, key, type, sdate, edate, pn, state,
					tranType,tran_wid,to_wid);
			//alert("sadfads111");
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					
					var tid = $(":text[name='tid']").val();//改为包裹单号
					$(":text[name='tid']").val("");
					var sdate = $(":text[name='sdate']").val();
					var edate = $(":text[name='edate']").val();
					var key = $(":text[name='key']").val();
					var type = $("select[name='type']").val();

					var state = $("select[name='tran_state']").val();// 转运状态
					var tranType = $("select[name='tran_type']").val();// 转运类型
					var tran_wid = $("select[name='tran_wid_search']").val();// 转运州仓库
					var to_wid = $("select[name='self_wid_search']").val();// 目的仓库，即所属仓库
					if(tran_wid=="-1")
					{
						tran_wid="";
					}
					if(to_wid=="-1")
					{
						to_wid="";
					}
					
					// alert(key);
					if (tid != null && tid != '') {
						$(":text[name='sdate']").val('');
						$(":text[name='edate']").val('');
						$(":text[name='key']").val('');
						$("select[name='type']").val('');
						sdate = '';
						edate = '';
						key = '';
						type = '';
						tranType = '';
						state = '';
						tran_wid='';
						to_wid='';
					}
					//alert("sadfads");
					// loadTranshipList(tid, key, type, sdate, edate, "1");
					loadTranshipListnew(tid, key, type, sdate, edate, pn, state,
							tranType,tran_wid,to_wid);
					//alert("sadfads111");
					return false;
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadTranshipList() {
	$("a[name='a_tranship_detail_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		var url = admin_detail_tranship_page_url + "?id=" + id;
		$("#main-content").load(url);
		return false;
	});

	$("a[name='a_tranship_modify_link']").click(function() {
		
		var id = $(this).parent().parent().attr("id");
		
		var url = admin_modify_tranship_page_url + "?id=" + id;
		$("#main-content").load(url);
		return false;
	});
	$("a[name='a_tranship_modify_state_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		$.ajax({
			type : "post",
			url : admin_modify_tranship_url,
			data : {
				id : id,
				state : "3"
			},
			success : function(response) {
				var code = response.code;
				if ("200" == code) {
					alert("入库成功，该转运单已经被拆分成几个运单，请去运单管理界面对该转运单的运单进行称重操作！");
					// $("#nav52").click();
					nav52Click();
				} else if ("607" == code) {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("入库失败，失败原因是：" + response.message);
				}
			}
		});

		return false;
	});
}


//kai 20150925 转运新搜索，添加状态和类型
function loadTranshipListnew(tid, key, type, sdate, edate, pn, state, trantype,tranwid,towid) {
	if (key != "") {
		if (type == 0) {
			alert("输入\"关键字\"必须选择\"搜索方向\"！");
			return;
		}
	}
	if (state == -1) {
		state = "";
	}
	if (trantype == -1) {
		trantype = "";
	}
	
	if(tranwid=="-1")
	{
		tranwid="";
	}
	if(towid=="-1")
	{
		towid="";
	}

	$(":hidden[name='tid']").val(tid);
	$(":hidden[name='key']").val(key);
	$(":hidden[name='type']").val(type);
	$(":hidden[name='sdate']").val(sdate);
	$(":hidden[name='edate']").val(edate);
	$(":hidden[name='pn']").val(pn);
	$(":hidden[name='tran_state']").val(state);
	$(":hidden[name='tran_type']").val(trantype);
	$(":hidden[name='s_tran_wid']").val(tranwid);
	$(":hidden[name='s_to_wid']").val(towid);

	$.ajax({
		type : "get",
		url : admin_tranship_searchlist_url,
		data : {
			tid : tid,
			key : key,
			type : type,
			sd : sdate,
			ed : edate,
			pageIndex : pn,
			trantype : trantype,
			state : state,
			tran_wid : tranwid,
			to_wid : towid
		},
		success : function(response) {
			var code = response.code;
			//alert(code);
			if ("200" == code) {
				if (response.data == null) {
					showTranshipList(null);
					showTranshipLink(null);
				} else {
					showTranshipList(response.data.datas);
					showTranshipLink(response.data);
				}
				
				afterLoadTranshipList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='10'>"
						+ "<span>&nbsp;&nbsp;获取转运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}
	});
}

function removenull(str)
{
    if((str=="")||(str=="null")||(str==null)||(str=="undefined"))	
    {
    	return "";
    }
    else
    {
    	return str;
    }
}
// kai 20150925 modify
function showTranshipList(list) {
	var str = "";
	if (list != null) {
		$
				.each(
						list,
						function() {
							
							str += "<tr id='" + this.id + "'>";
							str += "<td><input type='checkbox' name='del_id' value='"
									+ this.id + "'/></td>";
							
						
							
							str += '<td><a href="'+this.id+'" name="a_tran_order_route_detail_link">' + this.id + '</a></td>';
							str += "<td>" + this.transitNo + "</td>";
							var pm = "";
							$.each(this.commoditys, function() {
								pm += this.commodityName + ":" + this.quantity
										+ ":" + this.xiangqing + ";";
							});
							
							str += "<td>" + pm + "</td>";
							str += "<td>" + removenull(this.tranWarehouseName) + "</td>";
							str += "<td>" +removenull(this.warehouseName) + "</td>";
							str += "<td>" + this.userName + "</td>";
							str += "<td>" + this.userId + "</td>";
							if (this.weight == null) {
								this.weight = "&nbsp;";
							}
							str += "<td>" + this.weight + "</td>";
							if (this.state == "0") {
								str += "<td>未入库</td>";
							} else if (this.state == "1") {
								str += "<td>已入库</td>";
							} else if (this.state == "2") {
								str += "<td>等待审核</td>";
							} else if (this.state == "3") {
								str += "<td>等待付款</td>";
							} else if (this.state == "4") {
								str += "<td>已付款</td>";
							}else if (this.state == "5") {
								str += "<td>分拣完成</td>";
							} else if (this.state == "-10") {
								str += "<td>包裹异常</td>";
							} else if (this.state == "-9") {
								str += "<td>退货中</td>";
							}else if (this.state == "-8") {
								str += "<td>已退货</td>";
							}else if (this.state == "-7") {
								str += "<td>转运入库</td>";
							} else if (this.state == "-6") {
								str += "<td>转运出库</td>";
							}else if (this.state == "-5") {
								str += "<td>待检入库</td>";
							}else {
								str += "<td>" + this.state + "</td>";
							}
							var position = "";
							if(null != this.storagePosition){
								position = this.storagePosition.storageName + "-" + this.storagePosition.rowNumber + "-" + this.storagePosition.colNumber;
							}
							str += "<td>" + position + "</td>";
							if (this.transitType == 0) {
								str += "<td>" + "普通转运" + "</td>";
							} else if (this.transitType == 1) {
								str += "<td>" + "极速转运" + "</td>";
							} else if (this.transitType == 2) {
								str += "<td>" + "购物转运" + "</td>";
							} else {
								str += "<td>" + "" + "</td>";
							}
							str += "<td name='stateid' style='display:none;'>" + this.state+ "</td>";
							// str += "<td>" + this.unpackingNumber + "</td>";
							str += "<td>" + this.createDate + "</td>";
							/*
							 * var unpackingNumber = this.unpackingNumber; if
							 * (unpackingNumber > 1) { // 拆包 if (this.state ==
							 * "0") { str += "<td><a href='#'
							 * name='a_tranship_modify_state_link'>入库</a></td>"; } }
							 * else { // 不是拆包 str += "<td><a href='#'
							 * name='a_tranship_modify_link'>修改</a></td>"; }
							 */
							// alert(this.state);
							/*if (this.state == "4") {
								//str += "<td>已生成订单</td>";
								if(removenull(this.orderId)=="")
								{
									str += "<td>已付款</td>";
								}
								else
								{
									str += "<td>已付款,运单号：<br/>"+this.orderId+"</td>";
								}
							}else*/ if (this.state == "5") {
								//str += "<td>已生成订单</td>";
								if(removenull(this.orderId)=="")
								{
									str += "<td>分拣完成</td>";
								}
								else
								{
									str += "<td>分拣完成,运单号：<br/>"+this.orderId+"</td>";
								}
							}else if(this.state == "-9")
							{
								str += "<td>退货中</td>";
							}
							else if(this.state == "-8")
							{
								str += "<td>已退货</td>";
							}
							else {
								//str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
								
								var str_temp="";
								if (this.state == "4") {
									//str += "<td>已生成订单</td>";
									if(removenull(this.orderId)=="")
									{
										str_temp="";
									}
									else
									{
										str_temp=this.orderId;
									}
								}
								
								if("admin"==$("#admin_id_flag").val())
								{
									if(str_temp=="")
									{
										str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
									}
									else
									{
										str += "<td><a href='#' name='a_tranship_modify_link'>修改("+str_temp+")</a></td>";
									}
								}
								else
								{
									if((this.warehouseId==$("#store_id_flag").val())||(this.state=="0"))
									{
										if(str_temp=="")
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
										}
										else
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改("+str_temp+")</a></td>";
										}
									}
									else if((removenull(this.tranWarehouseId)!="")&&(this.state=="-6"))
									{
										if(str_temp=="")
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改</a></td>";
										}
										else
										{
											str += "<td><a href='#' name='a_tranship_modify_link'>修改("+str_temp+")</a></td>";
										}
									}
									else
									{
										str += "<td>禁止操作</td>";
									}
								}
							}
							
							
							
							
							
							
							str += "</tr>";
						});
		
		
		
		
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='11'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的转运单信息!</span></td>";
		}
	}
	$("#tab1 table tbody").html(str);
	
	$("a[name='a_tran_order_route_detail_link']").click(function() {
		var oid = $(this).attr("href");
		
		var url = admin_tran_route_order_detail_page_url + "?oid=" + oid;
		$("#main-content").load(url);
		return false;
	});
}
//转运修改
////////////////////////////////////////////////////////
function loadNav512Data() {
	
	
	get_tranpricetable();//获取转运价格表
	getglobalargs_commrate();//获取全局变量
	$("#a_back_tranship_list_link").click(function() {
		nav51Click();
		return false;
	});

	$("#a_add_commodity_quantity_link")
			.click(
					function() {
						var commodity = $("select[name='commodityId']").html();
						var str = '<tr><td>'
								+ '<select style="width:100px" onChange="orderModifyCalcFreight_dhyb()" name="commodityId" >'
								+ commodity + '</select></td>';
						str += '<td><input type="text" class="text-input"type="text" name="commodifysku" placeholder="商品唯一标志(条形码)"style="width:140px" /></td>';
						str += '<td><input type="text" class="text-input"type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:140px" /></td>';
						//str += '<td><input type="text" class="text-input"type="text" name="commodifybrands" placeholder="填写具体物品牌"style="width:140px" /></td>';
																		
						str += '<td><input name="quantity" class="text-input" size="3" type="text" value="0" onChange="orderModifyCalcFreight_dhyb()"/></td>';
						str += '<td><input name="eachsjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" value="0"/></td>';
						str += '<td><input name="sjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" readonly= "true" value="0"/></td>';
					
						str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+$(":hidden[name='t_tran_no']").val()+'"  /></td>';
						var widno=removenull($(":hidden[name='t_tran_wid_no']").val());
						
						if(widno=="")
						{
							widno=0;
						}
						else
						{
							var tempv=widno.lastIndexOf("|");//包含分隔符
							if(tempv!=-1)
							{
								widno=$("select[name=state]").val();
							}
							else 
							{
								if((parseFloat(widno)!="NaN")&&(parseFloat(widno)<1))
								{
									widno=0;
								}
							}
						}
						
						str += '<td style="display:none"><input name="commodify_tranwarehouseid" readonly= "true" class="text-input"  type="text" value="'+widno+'"  /></td>';
						// str += '<td><input name="jfweight" class="text-input"
						// size="3" type="text" /></td>';
						str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
						$("#commodity_list_table tbody").append(str);
						// afterShowModifyTranshipInfo();
						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1) {
								$(this).parent().parent().remove();
							}
							return false;
						});
						return false;
					});

	// sku回车事件，添加一个商品
	/*
	 * $("#commodifysku").keydown( function(event) { alert("asdfaf"); if
	 * (event.which == 13) { var commodity =
	 * $("select[name='commodityId']").html(); var str = '<tr><td>' + '<select
	 * style="width:100px" onChange="orderModifyCalcFreight()"
	 * name="commodityId" >' + commodity + '</select></td>'; str += '<td><input
	 * type="text" class="text-input"type="text" name="commodifysku"
	 * placeholder="商品唯一标志(条形码)"style="width:140px" /></td>'; str += '<td><input
	 * type="text" class="text-input"type="text" name="commodifyxiangqing"
	 * placeholder="填写具体物品信息"style="width:140px" /></td>'; str += '<td><input
	 * name="quantity" class="text-input" size="3" type="text" value="1" /></td>';
	 * str += '<td><input name="sjweight" class="text-input" size="3"
	 * type="text" onChange="orderModifyCalcFreight()" value="0"/></td>'; //
	 * str += '<td><input name="jfweight" class="text-input" // size="3"
	 * type="text" /></td>'; str += '<td><a href="#"
	 * name="a_delete_commodity">删除</a></td></tr>'; $("#commodity_list_table
	 * tbody").append(str); // afterShowModifyTranshipInfo();
	 * $("a[name='a_delete_commodity']").click(function() { if
	 * ($("a[name='a_delete_commodity']").length > 1) {
	 * $(this).parent().parent().remove(); } return false; }); return false; }
	 * });
	 * 
	 */
	
	
	
	$(":text[name='weight']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='tariff']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='other']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='premium']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='length']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='width']").change(orderModifyCalcFreight_dhyb);
	$(":text[name='height']").change(orderModifyCalcFreight_dhyb);
	//$(":text[name='premium']").change(countpremiummoney_user);//保险额度计算
	
	// kai 20150913 添加网上置单的分箱功能
	// alert("asdfasfd");
	$("#a_add_onlineorder_divide_link").click(function() {

		var onlineordercontext = $("#onlineorder_divide_id").html();
		//alert(onlineordercontext);
		$("#onlineorder_divide_id").append(onlineordercontext);

		return false;
	});
	
	//加转运州选择和是否要手续费
	$(":checkbox[name='fromTransportState']")
	.click(
			function() {
				var str='<option value="1" selected="selected">已入库</option><option value="2" >等待审核</option><option value="3" >等待付款</option><option value="4">已付款</option><option value="5">分拣完成</option><option value="-10">包裹异常</option>';
				var transtr="";
				transtr+='<option value="-7" selected="selected">转运入库</option>';
				transtr+='<option value="-6" >转运出库</option>';

				
				
				var checkbox =document.getElementsByName("fromTransportState");				
				if(checkbox[0].checked==true)
				{
					$("select[name='state']").html(transtr);
					$("#bt_tranship_submit_to_order").hide();
					$("#tran_state_info_show").hide();
					$("#Towarehouse_show").show();
					findStorage4User();
				}
				else
				{
					$("select[name='state']").html(str);
					$("#Towarehouse_show").hide();
					if($(":hidden[name='t_tran_type']").val()>=1){//极速转运，购物转运
						$("#bt_tranship_submit_to_order").show();
					}
					$("#tran_state_info_show").show();
					$("#Towarehouse_show").hide();
					findStorage4User();//转运州分配全仓位
				}
				
			
			});
	
	
	$(":checkbox[name='getpackagebyself']")
	.click(
			function() {
				
				var checkbox2 =document.getElementsByName("getpackagebyself");	
				if(checkbox2[0].checked==true)
				{
					
					$("#self_paytype").show();
					$("#getpackagebyselfshow").show();
					$("#bt_tranship_submit_to_order").show();
				}
				else
				{
					$("#self_paytype").hide();
					$("#getpackagebyselfshow").hide();
					if(($(":hidden[name='t_tran_type']").val()<1)&&($("select[name='state']").val()<=1)){//极速转运，购物转运
						$("#bt_tranship_submit_to_order").hide();
					}
				}
				
			});
			
	
		
	//已入库之后的都应该显示地址信息
	$("select[name='state']").change(function() {
		//alert($("select[name='state']").val());
		
		if (($(":hidden[name='t_tran_type']").val() >= 1)||(($("select[name='state']").val()!="")&&(parseFloat($("select[name='state']").val())>1))||($(":hidden[name='t_au_paymoney']").val()=="1"))// 极速转运，购物转运
		{
			if($("select[name='state']").val()!="-10")
			{
				$("#showquicktraninfo").show();
				$("#wrong_message_show").hide();
			}
			else
			{
				$("#wrong_message_show").show();
			}
	
		} else {
			if($("select[name='state']").val()!="-10")
			{
				$("#showquicktraninfo").hide();
				$("#wrong_message_show").hide();
			}
			else
			{
				$("#wrong_message_show").show();
			}
		}
		findStorage4User();
	});
	$("#bt_tranship_modify")
			.click(
					function() {

						var id = $(":hidden[name='id']").val();
						var warehouseId = $("select[name='warehouse']").val();
						var state = $("select[name='state']").val();
						var weight = $(":text[name='weight']").val();
						var tariff = $(":text[name='tariff']").val();
						var or = $(":text[name='other']").val();
						var other = $(":text[name='other']").val();
						var remark = $("textarea[name='remark']").val();

						var length = $(":text[name='length']").val();
						var width = $(":text[name='width']").val();
						var height = $(":text[name='height']").val();
						var cid = $("select[name='cid']").val();
						var validate = true;
						if (cid == null || cid == "请选择渠道" || cid == "-1") {
							$("select[name='cid']").css({
								"border-color" : "red"
							});
							$("select[name='cid']")
									.change(
											function() {
												if ($("select[name='cid']")
														.val() != null
														&& !$(
																"select[name='cid']")
																.val() == "请选择渠道"
														&& !$(
																"select[name='cid']")
																.val() == "-1")
													$("select[name='cid']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (weight == "" || weight == null || isNaN(weight)
								|| weight == "0") {
							$(":text[name='weight']").css({
								"border-color" : "red"
							});
							$(":text[name='weight']")
									.change(
											function() {
												if ($(":text[name='weight']")
														.val() != null
														&& !isNaN($(
																":text[name='weight']")
																.val())
														&& $(
																":text[name='weight']")
																.val() > 0)
													$(":text[name='weight']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (length == "" || length == null || isNaN(length)) {
							$(":text[name='length']").css({
								"border-color" : "red"
							});
							$(":text[name='length']")
									.change(
											function() {
												if ($(":text[name='length']")
														.val() != null
														&& !isNaN($(
																":text[name='length']")
																.val()))
													$(":text[name='length']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (width == "" || width == null || isNaN(width)) {
							$(":text[name='width']").css({
								"border-color" : "red"
							});
							$(":text[name='width']")
									.change(
											function() {
												if ($(":text[name='width']")
														.val() != null
														&& !isNaN($(
																":text[name='width']")
																.val()))
													$(":text[name='width']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (height == "" || height == null || isNaN(height)) {
							$(":text[name='height']").css({
								"border-color" : "red"
							});
							$(":text[name='height']")
									.change(
											function() {
												if ($(":text[name='height']")
														.val() != null
														&& !isNaN($(
																":text[name='height']")
																.val()))
													$(":text[name='height']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						var str = '"id":"' + id + '",' + '"state":"' + state
								+ '",' + '"weight":"' + weight + '",'
								+ '"or":"' + or + '",' + '"tariff":"' + tariff
								+ '",' + '"remark":"' + remark + '",'
								+ '"other":"' + other + '",' +

								'"length":"' + length + '",' + '"width":"'
								+ width + '",' + '"height":"' + height + '",'
								+ '"channelId":"' + cid + '",'
								+ '"warehouseId":"' + warehouseId + '"';

						var i = 0;
						$("select[name='commodityId']")
								.each(
										function() {
											var cname = $(this).val();
											var cquantity = $(this)
													.parent()
													.parent()
													.find(
															":input[name='quantity']")
													.val();
											// var cjfweight =
											// $(this).parent().parent().find(":input[name='jfweight']").val();
											var csjweight = $(this)
													.parent()
													.parent()
													.find(
															":input[name='sjweight']")
													.val();
											var cxiangqing = $(this)
													.parent()
													.parent()
													.find(
															":input[name='commodifyxiangqing']")
													.val();
											str += ',"commodity[' + i
													+ '].commodityId":"'
													+ cname + '"';
											str += ',"commodity[' + i
													+ '].quantity":"'
													+ cquantity + '"';
											str += ',"commodity[' + i
													+ '].sjweight":"'
													+ csjweight + '"';
											// str += ',"commodity[' + i +
											// '].jfweight":"' + cjfweight +
											// '"';
											str += ',"commodity[' + i
													+ '].xiangqing":"'
													+ cxiangqing + '"';
											i = i + 1;
										});

						var obj = $.parseJSON("{" + str + "}");
						if (!validate) {
							alert("红色框中的信息必须正确填写，才可以提交！");
							return false;
						}
						$
								.ajax({
									type : "post",
									url : admin_modify_tranship_url,
									data : obj,
									success : function(response) {
										var code = response.code;
										if ("200" == code) {
											alert("修改成功");
											// $("#nav51").click();
											nav51Click();
										} else if ("607" == code) {
											alert("您尚未登录或登录已失效！");
											logout();
										} else {
											alert("修改订单(转运单)失败，原因是:"
													+ response.message);
										}
										return false;
									}
								});
						return false;
					});

	$.ajax({
		type : "get",
		async : true,
		url : admin_warehosue_all,
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					var str = "";
					var str1="";
					
					$.each(response.data, function() {
						if("admin"==$("#admin_id_flag").val())
						{
							if(this.id==$("#store_id_flag").val())
							{
								str += "<option value='" + this.id + "'  selected='selected'>" + this.name
								+ "</option>";															
							}
							else
							{
							str += "<option value='" + this.id + "'>" + this.name
									+ "</option>";
							}
							
							
						}
						else
						{
							if(this.id==$("#store_id_flag").val())
							{
								str += "<option value='" + this.id + "'  selected='selected'>" + this.name
								+ "</option>";
							}
						}
						
						if(this.id==$("#store_id_flag").val())
						{
							if("admin"==$("#admin_id_flag").val())
							{
								str1 += "<option value='" + this.id + "'>" + this.name
								+ "</option>";
							}
						}
						else
						{
							str1 += "<option value='" + this.id + "'>" + this.name
							+ "</option>";
						}
						
						
					});
					$("select[name='warehouse']").html(str);
					$("select[name='Towarehouse']").html(str1);//从转运州过来要去的门店
					showChannelTableInTM();
					$("select[name='warehouse']").change(showChannelTableInTM);
				}
			}
		}
	});

	$.ajax({
		type : "get",
		url : admin_tranship_show_one_url,
		data : {
			id : $(":hidden[name='id']").val()
		},
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					// alert("asdfaf");
					showModifyTranshipInfo(response.data);
					// afterShowModifyTranshipInfo(response.data.commoditys);
				} else {
					alert("数据库中没有对应id的转运单信息.");
					// $("#nav51").click();
					nav51Click();
				}
			} else if (code == '607') {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("根据id获取转运单信息失败,失败原因是：" + response.message);
				// $("#nav51").click();
				nav51Click();
			}
		}
	});

}
//kai 20150930 提交转运单为订单为
function sendwrongmessage(id,message) {
	
	//alert(id);
	//alert(message);
	$.ajax({
		type:"post",
		url:"../admin/transh/wrongsave",
		data: {
			"id" : id,
			"message" : message
		},
		success:function(response){
			var code = response.code;
			if (code == "200") {
				alert("修改成功");
				nav51Click();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				// 失败
				alert("修改失败(数据已修改)，原因是:" + response.message);
			}
		}
	});
	return  false;
}

//提交修改运单接口 //kai 20150928
function submit_tranorder() {
//alert("sadff");
	var id = $(":hidden[name='id']").val();
	var tran_type=$(":hidden[name='t_tran_type']").val();
	//alert(tran_type);
	var warehouseId = $("select[name='warehouse']").val();
	var state = $("select[name='state']").val();
	var weight = $(":text[name='weight']").val();
	var tariff = $(":text[name='tariff']").val();
	var or = $(":text[name='or']").val();
	var other = $(":text[name='other']").val();
	var remark = $("textarea[name='remark']").val();

	var length = $(":text[name='length']").val();
	var width = $(":text[name='width']").val();
	var height = $(":text[name='height']").val();
	var cid = $("select[name='cid']").val();

	var premium = $(":text[name='premium']").val();
	var weightKg = $(":text[name='weightKg']").val();// 千克
	var mail = $("select[name='mail']").val();
    var parcelValue=$(":text[name='parceValue']").val();//申报价
    var paybool=$(":hidden[name='t_to_order_pay']").val();//是否直接支付标志
	var validate = true;
	var transtateflag=0;
	var checkbox =document.getElementsByName("fromTransportState");	
	var selfgetpackageFlag_checkbox =document.getElementsByName("getpackagebyself");	
	var transitNo=$("#t_c_b_tranno").html();
	var towid="";
	var tranWarehouseId=$(":hidden[name='t_tran_wid_no']").val();
	var authorizeMoveMoney=$(":hidden[name='t_au_paymoney']").val();
	var divide_money=$(":hidden[name='t_divide_money']").val();
	
	var wrongRemark = $("textarea[name='wrong_remark']").val();
	var CommodityCost=$(":hidden[name='t_CommodityCost']").val();
	
	if(state=="-10")
	{
		if(wrongRemark=="")
		{
			alert("异常描述不能为空!");
			return false;
		}
		
		sendwrongmessage(id,wrongRemark);
		return false;
	}
	
	
	var selfgetpackageFlag=0;
	if(selfgetpackageFlag_checkbox[0].checked==true)
	{
		selfgetpackageFlag=1;
	}

	$(":hidden[name='t_selfgetpackageFlag']").val(selfgetpackageFlag);
	var selfPaytype=$("select[name='self_paytype']").val();
	
	
	
	
	var pretranwarehouseId="0";
	if((state=="-6")||(state=="-7"))
	{
		pretranwarehouseId=$("select[name='Towarehouse']").val();
	}
	else
	{
		pretranwarehouseId="0";
	}
	
	if(checkbox[0].checked==true)
	{
		transtateflag=1;//表示来自转运州
		
		if(state=="-6")//转运出库,出库的州
		{
			towid = $("select[name='Towarehouse']").val();
			tranWarehouseId=warehouseId;
			warehouseId=towid;//把要到达的仓库设为仓库id
		}
	}
	else
	{
		transtateflag=0;
	}
	
//alert(paybool);
	
	if((state>0)||(paybool=="yes"))//状态大于0的必须包含商品及参数 
	{
		if (weightKg == "" || weightKg == null || isNaN(weightKg)) {
			$(":text[name='weightKg']").css({
				"border-color" : "red"
			});
			$(":text[name='weightKg']").change(
					function() {
						if ($(":text[name='weightKg']").val() != null
								&& !isNaN($(":text[name='weightKg']").val()))
							$(":text[name='weightKg']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (premium == "" || premium == null || isNaN(premium)) {
			$(":text[name='premium']").css({
				"border-color" : "red"
			});
			$(":text[name='premium']").change(
					function() {
						if ($(":text[name='premium']").val() != null
								&& !isNaN($(":text[name='premium']").val()))
							$(":text[name='premium']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (cid == null || cid == "请选择渠道" || cid == "-1") {
			$("select[name='cid']").css({
				"border-color" : "red"
			});
			$("select[name='cid']").change(
					function() {
						if ($("select[name='cid']").val() != null
								&& !$("select[name='cid']").val() == "请选择渠道"
								&& !$("select[name='cid']").val() == "-1")
							$("select[name='cid']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (weight == "" || weight == null || isNaN(weight) || weight == "0") {
			$(":text[name='weight']").css({
				"border-color" : "red"
			});
			$(":text[name='weight']").change(
					function() {
						if ($(":text[name='weight']").val() != null
								&& !isNaN($(":text[name='weight']").val())
								&& $(":text[name='weight']").val() > 0)
							$(":text[name='weight']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (length == "" || length == null || isNaN(length)) {
			$(":text[name='length']").css({
				"border-color" : "red"
			});
			$(":text[name='length']").change(
					function() {
						if ($(":text[name='length']").val() != null
								&& !isNaN($(":text[name='length']").val()))
							$(":text[name='length']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (width == "" || width == null || isNaN(width)) {
			$(":text[name='width']").css({
				"border-color" : "red"
			});
			$(":text[name='width']").change(
					function() {
						if ($(":text[name='width']").val() != null
								&& !isNaN($(":text[name='width']").val()))
							$(":text[name='width']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	
		if (height == "" || height == null || isNaN(height)) {
			$(":text[name='height']").css({
				"border-color" : "red"
			});
			$(":text[name='height']").change(
					function() {
						if ($(":text[name='height']").val() != null
								&& !isNaN($(":text[name='height']").val()))
							$(":text[name='height']").css({
								"border-color" : ""
							});
					});
			validate = false;
		}
	}
	else
	{
		validate=true;
	}
	
	
	
	var storagePositionId=document.getElementById("storagePositionId").value;
	//alert(storagePositionId);

	var str = '"id":"' + id + '",' + '"state":"' + state + '",' + '"weight":"'
			+ weight + '",' + '"or":"' + or + '",' + '"tariff":"' + tariff+ '",' + '"divideMoney":"' + divide_money+ '",' + '"selfgetpackageFlag":"' + selfgetpackageFlag+ '",' + '"selfPaytype":"' + selfPaytype
			+ '",' + '"remark":"' + remark + '",' + '"other":"' + other + '",' + '"transtateflag":"' + transtateflag + '",' + '"transitType":"' + tran_type + '",' +

			'"length":"' + length + '",' + '"width":"' + width + '",'+ '"parcelValue":"' + parcelValue + '",'+ '"mail":"' + mail + '",'
			+ '"height":"' + height + '",' + '"channelId":"' + cid + '",'+ '"storagePosition.id":"' + storagePositionId + '",'
			+ '"premium":"' + premium + '",' + '"weightKg":"' + weightKg + '",'+ '"tranWarehouseId":"' + tranWarehouseId + '",'+ '"CommodityCost":"' + CommodityCost + '",'
			+ '"warehouseId":"' + warehouseId + '",'+'"pretranwarehouseId":"' + pretranwarehouseId + '"';

	var i = 0;
	$("select[name='commodityId']")
			.each(
					function() {
						var cname = $(this).val();
						var cquantity = $(this).parent().parent().find(
								":input[name='quantity']").val();

						var ccommodifysku = $(this).parent().parent().find(
								":input[name='commodifysku']").val();

						var cquantityobj = $(this).parent().parent().find(
								":input[name='quantity']");
						// var cjfweight =
						// $(this).parent().parent().find(":input[name='jfweight']").val();
						var csjweight = $(this).parent().parent().find(
								":input[name='eachsjweight']").val();
						
						var csjweightall = $(this).parent().parent().find(
						":input[name='sjweight']").val();

						var sjweightobj = $(this).parent().parent().find(
								":input[name='eachsjweight']");

						var cxiangqing = $(this).parent().parent().find(
								":input[name='commodifyxiangqing']").val();

						var cxiangqingobj = $(this).parent().parent().find(
								":input[name='commodifyxiangqing']");
						
						var commodify_transitno = $(this).parent().parent().find(
						":input[name='commodify_transitno']").val();
						var commodify_tranwarehouseid="0";
						if(state=="-6")//转运出库
						{
							commodify_tranwarehouseid=$("select[name='warehouse']").val();
						}
						else
						{
							commodify_tranwarehouseid = $(this).parent().parent().find(
							":input[name='commodify_tranwarehouseid']").val();
						}
						if(removenull(commodify_tranwarehouseid)=="")
						{
							commodify_tranwarehouseid="0";
						}
						

						if((state>0)||(paybool=="yes"))//状态大于0的必须包含商品及参数 
						{
							if (cquantity == "" || cquantity == null
									|| isNaN(cquantity) || cquantity == "0") {
								cquantityobj.css({
									"border-color" : "red"
								});
								cquantityobj.change(function() {
									if (cquantityobj.val() != null
											&& !isNaN(cquantityobj.val())
											&& cquantityobj.val() > 0)
										cquantityobj.css({
											"border-color" : ""
										});
								});
								validate = false;
							}
							if (csjweight == "" || csjweight == null
									|| isNaN(csjweight) || csjweight == "0") {
								sjweightobj.css({
									"border-color" : "red"
								});
								sjweightobj.change(function() {
									if (sjweightobj.val() != null
											&& !isNaN(sjweightobj.val())
											&& sjweightobj.val() > 0) {
										sjweightobj.css({
											"border-color" : ""
										});
										orderModifyCalcFreight();
									}
	
								});
								validate = false;
							}
						}
						str += ',"commodity[' + i + '].commodityId":"' + cname
								+ '"';
						str += ',"commodity[' + i + '].commoditySku":"'
								+ ccommodifysku + '"';

						str += ',"commodity[' + i + '].quantity":"' + cquantity
								+ '"';
						str += ',"commodity[' + i + '].eachjfweight":"' + csjweight
								+ '"';
						str += ',"commodity[' + i + '].sjweight":"' + csjweightall
						+ '"';
						// str += ',"commodity[' + i +
						// '].jfweight":"' + cjfweight +
						// '"';
						str += ',"commodity[' + i + '].xiangqing":"'
								+ cxiangqing + '"';
						str += ',"commodity[' + i + '].transitNo":"'
						+ commodify_transitno + '"';
						
						str += ',"commodity[' + i + '].tranWarehouseId":"'
						+ commodify_tranwarehouseid + '"';
						
						
						i = i + 1;
					});
	//alert(str);
	
	var totalmoney=$(":text[name='totalmoney']").val();
	var totalp = parseFloat(totalmoney);
	
	if (totalp == "NaN") {
	alert("总价格式有误!");
	return false;
	}
	else
	{
		if(totalp<0)
		{
			alert("总价钱不能小于0!");
			return false;
		}
	}
	if(state<=0)//这里很奇怪，如果总价格没变动过，得到的结果是空而不是0
	{
		if(removenull(totalmoney)=="")
		{
			totalmoney=0;
		}
	}
	
	$(":hidden[name='t_totalmoney']").val(totalmoney);
	
	str=str+',"totalMoney":"' + totalmoney + '"';
	//alert("555555");
	if((tran_type==1)||(state>1)||(authorizeMoveMoney=="1"))//极速转运，要提交地址等信息,等待审核之后，也要填写地址信息
	{
		//alert("6666");
		var cName = $(":text[name='cName']").val();
		var cCity = $(":text[name='cCity']").val();
		var cDistrict = $(":text[name='cDistrict']").val();
		var cProvince = $(":text[name='cProvince']").val();
		var cStreetAddress = $(":text[name='cStreetAddress']")
				.val();
		var cZipCode = $(":text[name='cZipCode']").val();
		var cPhone = $(":text[name='cPhone']").val();
		
		
		var cardurl = $(":text[name='idurlcard']").val();
		var cardurlother = $(":text[name='idurlcardother']").val();
		var cardurltogether = $(":text[name='idurlcardtogether']").val();
		var cardid = $(":text[name='cardidname']").val();
		cardurl = encodeURI(cardurl);
		
		cardurlother = encodeURI(cardurlother);
		
		cardurltogether = encodeURI(cardurltogether);
		
		if((paybool=="yes")||(state>1))
		{
		
		/*	if (cProvince == "省份") {
				$("#loc_province").css({
					"border-color" : "red"
				});
				$("#loc_province").change(function() {
					if ($("#loc_province").val() != null)
						$("#loc_province").css({
							"border-color" : ""
						});
				});
				validate = false;
			}
			if (cCity == "地级市") {
				$("#loc_city").css({
					"border-color" : "red"
				});
				$("#loc_city").change(function() {
					if ($("#loc_city").val() != null)
						$("#loc_city").css({
							"border-color" : ""
						});
				});
				validate = false;
			}
			if (cDistrict == "市、县、区") {
				$("#loc_town").css({
					"border-color" : "red"
				});
				$("#loc_town").change(function() {
					if ($("#loc_town").val() != null)
						$("#loc_town").css({
							"border-color" : ""
						});
				});
				validate = false;
			}
	*/
			if (cName == "" || cName == null) {
				$(":text[name='cName']").css({
					"border-color" : "red"
				});
				$(":text[name='cName']").change(
						function() {
							if ($(":text[name='cName']")
									.val() != null)
								$(":text[name='cName']")
										.css({
											"border-color" : ""
										});
						});
				validate = false;
			}
			if (cStreetAddress == "" || cStreetAddress == null) {
				$(":text[name='cStreetAddress']").css({
					"border-color" : "red"
				});
				$(":text[name='cStreetAddress']").change(
						function() {
							if ($(":text[name='cStreetAddress']")
									.val() != null)
								$(":text[name='cStreetAddress']")
										.css({
											"border-color" : ""
										});
						});
				validate = false;
			}
	
			
			if (cPhone == "" || cPhone == null) {
				$(":text[name='cPhone']").css({
					"border-color" : "red"
				});
				$(":text[name='cPhone']").change(function() {
					if ($(":text[name='cPhone']").val() != null)
						$(":text[name='cPhone']").css({
							"border-color" : ""
						});
				});
				validate = false;
			}
		}
		else
		{
			validate=true;
		}

		
		
//alert("65656");
		
		str=str+',"cName":"' + cName + '",' +'"cProvince":"' + cProvince + '",' +
		'"cCity":"' + cCity + '",' +'"cDistrict":"' + cDistrict + '",' +
		'"cStreetAddress":"' + cStreetAddress + '",' +'"cZipCode":"' + cZipCode + '",' +
		'"cPhone":"' + cPhone + '",' +
		'"cardid":"' + cardid + '",' +'"cardurl":"' + cardurl + '",' +
		'"cardurlother":"' + cardurlother + '",' +'"cardurltogether":"' + cardurltogether + '"';
		
	}
	str=str+',"paybool":"' + paybool + '"';
	//alert(str);
	var obj = $.parseJSON("{" + str + "}");
	if (!validate) {
		alert("红色框中的信息必须正确填写，才可以提交！");
		return false;
	}
	

	var file = $(":file[name='file']").val();
	// kai 20150921
	var fileother = $(":file[name='fileother']").val();
	// alert(file);
	if ((file != null && file != '')
			|| (fileother != null && fileother != '')) {

		modifytranshavepic(id,tran_type,paybool,authorizeMoveMoney);
		return false;
	}
	
	$(":hidden[name='t_to_order_pay']").val("");
//alert(str);
//return;
	$.ajax({
		type : "post",
		url : admin_modify_tranship_url,
		data : obj,
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				//alert(paybool);
				if((tran_type==1)&&(paybool=="yes"))//极速转运并要立即付款
				{
					if(((state>0)||(state=="-5"))&&(state<4))
					{
						
						mulitSubmittranOrder(id,tran_type);
						
					}
					else
					{
						alert("该类型的运单状态只能是\" 已入库  \",\" 待审核  \",\" 待付款  \",\" 待检入库  \"状态才能生成订单.");
						alert("保存数据成功，支付失败!");
						// $("#nav51").click();
						nav51Click();
					}
				}
				else if((authorizeMoveMoney==1)&&(paybool=="yes"))//用户授权生成订单
				{
					if((state>1)&&(state<4))
					{
						
						mulitSubmittranOrder(id,"2");//使用2来标识是用户授权的
						
					}
					else
					{
						alert("该类型的运单状态只能是\" 待审核  \",\" 待付款  \"状态才能生成订单.");
						alert("保存数据成功，支付失败!");
						// $("#nav51").click();
						nav51Click();
					}
				}
				else if((removenull($(":hidden[name='t_selfgetpackageFlag']").val())=="1")&&(paybool=="yes"))//自提标志
				{
					if((state>0)&&(state<4))
					{
						
						mulitSubmittranOrder(id,"3");//使用2来标识是用户自提
						
					}
					else
					{
						alert("该类型的运单状态只能是\" 已入库\",\" 等待审核  \",\" 等待付款 \"状态才能生成自提订单.");
						alert("保存数据成功，支付失败!");
						// $("#nav51").click();
						nav51Click();
					}
				}
				else
				{
					alert("修改成功");
					// $("#nav51").click();
					nav51Click();
				}
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("修改订单(转运单)失败，原因是:" + response.message);
			}
			return false;
		}
	});
	return false;

}



//kai 20150929 修改转运订单时包含照片

function modifytranshavepic(id,tran_type,paybool,authorizeMoveMoney) {
	// alert("开始提交有图片订单");
	var state = $("select[name='state']").val();
	$(":hidden[name='t_to_order_pay']").val("");
	$("#modify_online_tran_pic").ajaxSubmit(
			{
				type : "post",
				url : "../admin/transh/modify_have_pics",
				success : function(data) {
					// alert(data);
					$("#tmpmsgdiv1").html(data);
					var str = $("#tmpmsgdiv1 pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					if (code == "200") {
						
						
						
						if((tran_type==1)&&(paybool=="yes"))//极速转运并要立即付款
						{
							if(((state>0)||(state=="-5"))&&(state<4))
							{
								
								mulitSubmittranOrder(id,tran_type);
								
							}
							else
							{
								alert("该类型的运单状态只能是\" 已入库  \",\" 待审核  \",\" 待付款  \",\" 待检入库  \"状态才能生成订单.");
								alert("修改成功");
								// $("#nav51").click();
								nav51Click();
							}
						}
						else if((authorizeMoveMoney==1)&&(paybool=="yes"))//用户授权生成订单
						{
							if((state>1)&&(state<4))
							{
								
								mulitSubmittranOrder(id,"2");//使用2来标识是用户授权的
								
							}
							else
							{
								alert("该类型的运单状态只能是\" 待审核  \",\" 待付款  \"状态才能生成订单.");
								alert("修改成功");
								// $("#nav51").click();
								nav51Click();
							}
						}
						else
						{
							alert("修改成功");
							// $("#nav51").click();
							nav51Click();
						}
						
						
						/*if(state!=1)
						{
							alert("运单状态只能是\" 已入库  \"状态才能生成订单.");
							alert("修改成功");
							// $("#nav51").click();
							nav51Click();
							
						}
						else
						{

							if(paybool!="yes")
							{
								alert("修改成功");
								// $("#nav51").click();
								nav51Click();
							}
							else
							{
								mulitSubmittranOrder(id,tran_type);
							}
						}*/
					} else if (code == "607") {
						alert("重新过期，请重新登录");
						window.location.href = "login.jsp";
					} else {
						alert("修改订单(转运单)失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("操作失败");
					return false;
				}
			});
}
//kai 20150930 提交转运单为订单为
function mulitSubmittranOrder(tranid,trantype) {
	
	
	$.ajax({
		type:"post",
		url:"../admin/order/transubmit",
		data: {
			"tranid" : tranid,
			"trantype" : trantype
		},
		success:function(response){
			var code = response.code;
			if (code == "200") {
				alert("提交运单成功");
				nav51Click();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				// 失败
				alert("提交运单信息失败(数据已修改)，原因是:" + response.message);
			}
		}
	});
	return  false;
}
//kai 20150929 提交极速转运为订单
function submit_tranorder_to_orders()
{
	
	var usamoney=$(":hidden[name='t_user_usdBalance']").val();//帐户余额
	var rmbmoney=$(":hidden[name='t_user_rmbBalance']").val();//帐户余额
	//alert(rmbmoney);
	var comm=$(":text[name='totalmoney']").val();//当前商品价格
	if(parseFloat(comm)<0)
	{
		alert("支付费用不能小于0");
		return false;
	}
	var checkbox2 =document.getElementsByName("getpackagebyself");	
	if((checkbox2[0].checked==false)||((checkbox2[0].checked==true)&&($("select[name='self_paytype']").val()==1)))
	{
		if(parseFloat(comm)>parseFloat(usamoney))
		{
			if(parseFloat(jw_commodity_rate)>0)
			{
				if(parseFloat(rmbmoney-(parseFloat(comm)-parseFloat(usamoney))*parseFloat(jw_commodity_rate))>=0)
				{
					
				}
				else
				{
					alert("余额不足!");
					return false;
				}
			}
			else
			{
				alert("余额不足!");
				return false;
			}
		}
	}
	$(":hidden[name='t_to_order_pay']").val("yes");//设置提交的运单是否支付，表示支付
	submit_tranorder();
	
	
	

	
	
}
//kai 20151005
function showChannelTableInTM() {
	var wid = $("select[name='warehouse']").val();
	//alert(wid);
	$("select[name='cid']").html("<option >请选择渠道</option>");
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '" additiveprice="'+this.additivePrice+'">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					showCommodityTableInTM();
					$("select[name='cid']").change(showCommodityTableInTM);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

//kai 20150928
function showCommodityTableInTM() {
	$("#commodity_list_table tbody").html("");
	var wid = $("select[name='warehouse']").val();
	var cid = $("select[name='cid']").val();
	
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$
			.ajax({
				post : "get",
				url : admin_commodity_list_url,
				data : {
					"wid" : wid,
					"cid" : cid
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						if (response.data == null) {
							$("#commodity_list_table tbody")
									.html(
											"<tr><td colspan='5'>您的运单中，有该渠道禁运商品类别，请选择其他渠道！</td></tr>");
							return;
						}
						var str_option = "";
						// alert("sdafa");
						$.each(response.data, function() {
							str_option += "<option value='" + this.id
									+ "'  price='" + this.price + "' msPrice='"
									+ this.msPrice + "' vipOnePrice='"
									+ this.vipOnePrice + "' vipTwoPrice='"
									+ this.vipTwoPrice + "' vipThreePrice='"
									+ this.vipThreePrice + "'>" + this.name
									+ "</option>";
						});
						var str = "";
						// $.each(details,function(){
						str += '<tr><td>';
						str += '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight_dhyb()" >'
								+ str_option + '</select>';
						str += '</td>';
						str += '<td><input name="commodifysku" class="text-input" style="width:140px" type="text" value="" placeholder="商品唯一标志(条形码)" /></td>';
						str += '<td><input name="commodifyxiangqing" class="text-input" style="width:140px" type="text" value="" placeholder="填写具体物品信息"/></td>';
						str += '<td><input name="quantity" class="text-input" size="3" type="text" value="0" onChange="orderModifyCalcFreight_dhyb()"/></td>';
						str += '<td><input name="eachsjweight" class="text-input" size="5" type="text" value="0" onChange="orderModifyCalcFreight_dhyb()" /></td>';
						str += '<td><input name="sjweight" readonly= "true" class="text-input" size="5" type="text" value="0" onChange="orderModifyCalcFreight_dhyb()" /></td>';
						str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+$(":hidden[name='t_tran_no']").val()+'"  /></td>';
						var widno=removenull($(":hidden[name='t_tran_wid_no']").val());
						if(widno=="")
						{
							widno=0;
						}
						else
						{
							var tempv=widno.lastIndexOf("|");//包含分隔符
							if(tempv!=-1)
							{
								widno=$("select[name=state]").val();
							}
							else 
							{
								if((parseFloat(widno)!="NaN")&&(parseFloat(widno)<1))
								{
									widno=0;
								}
							}
						}
						
						str += '<td style="display:none"><input name="commodify_tranwarehouseid" readonly= "true" class="text-input"  type="text" value="'+widno+'"  /></td>';
						str += '<input name="transhipmentId" type="hidden" value="-1"/>';
						str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
						// });
						$("#commodity_list_table tbody").html(str);

						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1)
								$(this).parent().parent().remove();
							return false;
						});
					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					}
				}
			});
}

function skuaddcommodify(event) {

event=(event)?event:((window.event)?window.event : "");
var key=event.keyCode? event.keyCode : event.wihch;
//alert(key);
	if (key == 13)// 回车事件
	{
		var commodity = $("select[name='commodityId']").html();
		var skuscan = $(":text[name='skuscan']").val();
		var addnew = true;
		$(":text[name='skuscan']").val("");//清空原有数据
		if((skuscan=="")||((skuscan==null)))
		{
			return false;
		}

		$("select[name='commodityId']")
				.each(
						function() {
							var cname = $(this).val();
							var cquantity = $(this).parent().parent().find(
									":input[name='quantity']").val();

							var ccommodifysku = $(this).parent().parent().find(
									":input[name='commodifysku']").val();

							var csjweight = $(this).parent().parent().find(
									":input[name='eachsjweight']").val();

							var cxiangqing = $(this).parent().parent().find(
									":input[name='commodifyxiangqing']").val();
							

							if ((cquantity == 0) && (ccommodifysku == "")
									&& (csjweight == 0) && (cxiangqing == ""))// 原来就是空
							{
								$(this).parent().parent().find(
										":input[name='commodifysku']").val(
										skuscan);
								$(this).parent().parent().find(
								":input[name='quantity']").val("1");
								orderModifyCalcFreight_dhyb();
								addnew = false;
								return false;

							} else if ((ccommodifysku != "")
									&& (ccommodifysku != null)) {
								if (ccommodifysku == skuscan) {
									cquantity=1+parseFloat(cquantity);
									if(cquantity=="NaN")
									{
										alert("商品数量格式有问题，请检查!");
										return false;
									}
									
									$(this).parent().parent().find(
											":input[name='quantity']").val(
											cquantity);
									orderModifyCalcFreight_dhyb();
									addnew = false;
									return false;
								} else {

								}
							}

						});

		if (addnew == true) {

			var str = '<tr><td>'
					+ '<select style="width:100px" onChange="orderModifyCalcFreight_dhyb()" name="commodityId" >'
					+ commodity + '</select></td>';

			str += '<td><input type="text" class="text-input"type="text" name="commodifysku" id="commodifyskuid" style="width:140px" value="'
					+ skuscan + '"' + ' /></td>';

			str += '<td><input type="text" class="text-input"type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:140px" /></td>';
			str += '<td><input name="quantity" class="text-input" size="3" type="text" value="1" onChange="orderModifyCalcFreight_dhyb()"/></td>';
			str += '<td><input name="eachsjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" value="0"/></td>';
			str += '<td><input name="sjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" value="0"/></td>';
			str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+$(":hidden[name='t_tran_no']").val()+'"  /></td>';
			var widno=removenull($(":hidden[name='t_tran_wid_no']").val());
			if(widno=="")
			{
				widno=0;
			}
			else
			{
				var tempv=widno.lastIndexOf("|");//包含分隔符
				if(tempv!=-1)
				{
					widno=$("select[name=state]").val();
				}
				else 
				{
					if((parseFloat(widno)!="NaN")&&(parseFloat(widno)<1))
					{
						widno=0;
					}
				}
			}
			
			str += '<td style="display:none"><input name="commodify_tranwarehouseid" readonly= "true" class="text-input"  type="text" value="'+widno+'"  /></td>';
			// str += '<td><input name="jfweight" class="text-input"
			// size="3" type="text" /></td>';

			str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';

			$("#commodity_list_table tbody").append(str);
			// afterShowModifyTranshipInfo();
			// skuscan
			orderModifyCalcFreight_dhyb();
			$("a[name='a_delete_commodity']").click(function() {
				if ($("a[name='a_delete_commodity']").length > 1) {
					$(this).parent().parent().remove();
				}
				return false;
			});

			return false;
		}
	}

}
//kai 20150929 修改一条订单的显示信息
function showModifyTranshipInfo(tranship) {
	
	
	
	
	if (tranship.state != "0")//普通管理员只能操作自己门店已经入库的运单
	{
		if($("#admin_id_flag").val()!="admin")
		{
			if(tranship.warehouseId!=$("#store_id_flag").val())//判断是不是同一个仓库门店的
			{
				if((removenull(tranship.tranWarehouseId)!="")&&(tranship.tranWarehouseId==$("#store_id_flag").val())&&(tranship.state=="-6"))
				{}
				else
				{
					alert("对不起，你只能修改自己仓库/门店的已入库转运单！");
					nav51Click();
					return false;
				}
			}
		
		}
	}
	
	
	
	
	$("select[name='state']").val(tranship.state);
	
	if(tranship.state=="-7")
	{
		$("select[name='Towarehouse']").val(tranship.pretranwarehouseId);
	}
	else if(tranship.state=="-6")
	{
		$("select[name='Towarehouse']").val(tranship.pretranwarehouseId);

	}
	
	if(tranship.state=="-10")
	{
		$("#wrong_message_show").show();
	}
	$("textarea[name='wrong_remark']").val(removenull(tranship.wrongRemark));
	
	$(":text[name='tran_warehouse_name']").val(tranship.tranWarehouseName);
	$("#u_id").html(tranship.userId);
	$("#u_nick_name").html(tranship.userName);
	$("#t_c_b_tranno").html(tranship.transitNo);
	

	if(removenull(tranship.CommodityCost)=="")
	{
		$(":hidden[name='t_CommodityCost']").val("0");
	}
	else
	{
		$(":hidden[name='t_CommodityCost']").val(tranship.CommodityCost);
	}
	if(removenull(tranship.transitCompany)=="")
	{
		tranship.transitCompany="&nbsp;";
	}
	$("#t_c_b_tran_company").html(tranship.transitCompany);
	var money="$"+tranship.usdBalance+",￥"+tranship.rmbBalance;
	$("#t_user_balance").html(money);

	$(":hidden[name='t_user_rmbBalance']").val(tranship.rmbBalance);
	$(":hidden[name='t_user_usdBalance']").val(tranship.usdBalance);
	$(":hidden[name='t_totalmoney']").val(tranship.totalMoney);
	
	var str_temp = "";
	if (tranship.transitType == 0) {
		str_temp = "普通转运";
		if(tranship.authorizeMoveMoney=="1")
		{
			$("#bt_tranship_submit_to_order").attr("style","");
		}
		else
		{
			$("#bt_tranship_submit_to_order").attr("style","display:none");
		}
	} else if (tranship.transitType == 1) {
		str_temp = "极速转运";
		$("#bt_tranship_submit_to_order").attr("style","");
	} else if (tranship.transitType == 2) {
		str_temp = "购物转运";
		$("#bt_tranship_submit_to_order").attr("style","");
	} else {
		str_temp = "未知类型";
	}
	$("#t_tran_type").html(str_temp);
	
	
	//添加授权标志
	
	if(tranship.authorizeMoveMoney=="1")
	{
		$("#t_u_au_paymoney").html("是");
	}
	else
	{
		$("#t_u_au_paymoney").html("否");
	}
	$(":hidden[name='t_au_paymoney']").val(tranship.authorizeMoveMoney);
	
	
	
	
	//$("#t_tran_type").html(str_temp);
	$(":hidden[name='t_tran_type']").val(tranship.transitType);
	$(":hidden[name='t_tran_no']").val(tranship.transitNo);
	
	if(removenull(tranship.tranWarehouseId)=="")
	{
		tranship.tranWarehouseId="0";
	}
	$(":hidden[name='t_tran_wid_no']").val(tranship.tranWarehouseId);
	
	$(":hidden[name='count_tranwarehouseId_id']").val(tranship.tranWarehouseId);//标识计费的转运州id
	
	
	var s = "";
	if (tranship.state == "0") {
		s= "<td>未入库</td>";
	} else if (tranship.state == "1") {
		s= "<td>已入库</td>";
	} else if (tranship.state == "2") {
		s= "<td>等待审核</td>";
	} else if (tranship.state == "3") {
		s= "<td>等待付款</td>";
	}  else if (tranship.state == "4") {
		s= "<td>已付款</td>";
	} else if (tranship.state == "5") {
		s= "<td>分拣完成</td>";
	} else if (tranship.state == "-10") {
		s= "<td>包裹异常</td>";
	} else if (tranship.state == "-7") {
		s= "<td>转运入库</td>";
	} else if (tranship.state == "-6") {
		s= "<td>转运出库</td>";
	}else if (tranship.state == "-5") {
		s= "<td>待检入库</td>";
	}else if (tranship.state == "-9") {
		s= "<td>退货中</td>";
	} else if (tranship.state == "-8") {
		s= "<td>已退货</td>";
	}else {
		s= "<td>" + tranship.state + "</td>";
	}
	$("#t_old_state").html(s);
	
	var position = "&nbsp;";
	if(null != tranship.storagePosition){
		position = tranship.storagePosition.storageName + "-" + tranship.storagePosition.rowNumber + "-" + tranship.storagePosition.colNumber;
	}
	$("#t_old_position").html(position);

	if (tranship.warehouseId != null && tranship.warehouseId != '') {
		$(
				"select[name='warehouse'] option[value='"
						+ tranship.warehouseId + "']").attr("selected", true);
		
		//showChannelTableInTM();
		//showCommodityTableInTM();
		//showChannelTableInTM_dhyb(details)
		if (tranship.commoditys != null && tranship.commoditys != '') {
		//alert(tranship.commoditys);
		//showCommodityTable(tranship.commoditys);
			showChannelTableInTM_dhyb(tranship.commoditys);
		
	}
		
	}
	if (tranship.channelId != null && tranship.channelId != '') {
		$("select[name='cid'] option[value='" + tranship.channelId + "']")
				.attr("selected", true);
	}

	if (removenull(tranship.weight)!="") {
		$(":text[name='weight']").val(tranship.weight);
	}
	else
	{
		$(":text[name='weight']").val("0");
	}
	if (tranship.weightKg != null && tranship.weightKg != '') {
		$(":text[name='weightKg']").val(tranship.weightKg);
	}
	else
	{
		$(":text[name='weightKg']").val("0");
	}
	if (removenull(tranship.width) != '') {
		$(":text[name='width']").val(tranship.width);
	}
	else
	{
		$(":text[name='width']").val("0");
	}
	if (removenull(tranship.length)!= '') {
		$(":text[name='length']").val(tranship.length);
	}
	else
	{
		$(":text[name='length']").val("0");
	}
	if (removenull(tranship.height) != '') {
		$(":text[name='height']").val(tranship.height);
	}
	else
	{
		$(":text[name='height']").val("0");
	}
	if (removenull(tranship.tariff)!= '') {
		$(":text[name='tariff']").val(tranship.tariff);
	}
	else
	{
		$(":text[name='tariff']").val("0");
	}
	if (removenull(tranship.or)!= '') {
		$(":text[name='or']").val(tranship.or);
	}
	else
	{
		$(":text[name='or']").val("0");
	}
	if (removenull(tranship.other)!= '') {
		$(":text[name='other']").val(tranship.other);
	}
	else
	{
		$(":text[name='other']").val("0");
	}

	if (removenull(tranship.parcelValue) != '') {
		$(":text[name='parceValue']").val(tranship.parcelValue);
	}
	else
	{
		$(":text[name='parceValue']").val("0");
	}

	if (removenull(tranship.premium) != '') {
		$(":text[name='premium']").val(tranship.premium);
	}
	else
	{
		$(":text[name='premium']").val("0");
	}
	$("textarea[name='remark']").val(tranship.remark);
	
	if (tranship.commoditys != null && tranship.commoditys != '') {
		//alert(tranship.commoditys);
		//showCommodityTable(tranship.commoditys);
		//showCommodityTable_dhyb(tranship.commoditys);
		
	}

	// 添加极速转运信息
	
	if ((tranship.transitType >= 1)||((removenull(tranship.state)!="")&&(parseFloat(tranship.state)>1))||(tranship.authorizeMoveMoney=="1"))// 极速转运，购物转运
	{
	
		$("#showquicktraninfo").show();
		$(":text[name='cName']").val(tranship.cName);
		$(":text[name='cProvince']").val(tranship.cProvince);
		$(":text[name='cCity']").val(tranship.cCity);
		$(":text[name='cDistrict']").val(tranship.cDistrict);
		$(":text[name='cStreetAddress']").val(tranship.cStreetAddress);
		$(":text[name='cZipCode']").val(tranship.cZipCode);
		$(":text[name='cPhone']").val(tranship.cPhone);
		$(":text[name='cardidname']").val(tranship.cardid);

		var cardurl1 = tranship.cardurl;
		if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
		{
			// alert(cardurl1);
			$("#showcardpicid").attr("style", "display:block;");
			$(":text[name='idurlcard']").val(cardurl1);
			cardurl1 = getRootPath() + cardurl1;
			$("#imacardurlid").attr("href", cardurl1);
			$("#imacardurlid img").attr("src", cardurl1);

		} else {
			$("#showcardpicid").attr("style", "display:none");

			// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
		}

		// 反面图片处理
		var cardurl1 = tranship.cardurlother;
		// alert(cardurl1);
		if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
		{
			// alert(cardurl1);
			$("#showcardpicidother").attr("style", "display:block;");
			$(":text[name='idurlcardother']").val(cardurl1);
			cardurl1 = getRootPath() + cardurl1;
			$("#imacardurlidother").attr("href", cardurl1);
			$("#imacardurlidother img").attr("src", cardurl1);

		} else {
			$("#showcardpicid").attr("style", "display:none");

			// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
		}

		// 合成图片处理
		var cardurl1 = tranship.cardurltogether;
		if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
		{
			// alert(cardurl1);
			$("#showcardpicidtogether").attr("style", "display:block;");
			$(":text[name='idurlcardtogether']").val(cardurl1);
			cardurl1 = getRootPath() + cardurl1;
			$("#imacardurlidtogether").attr("href", cardurl1);
			$("#imacardurlidtogether img").attr("src", cardurl1);

		} else {
			$("#showcardpicidtogether").attr("style", "display:none");

			// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
		}

		$(":file[name='file']").val("");// 清空原来选择过上传的图片
		$(":file[name='fileother']").val("");// 清空原来选择过上传的图片

		$("#cardpicid").on("change", function() {
			var picValue = $(":file[name='file']").val();
			if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
				$("#showcardpicid").attr("style", "display:none");
				$("#showcardpicidtogether").attr("style", "display:none");
				// $(":text[name='idurlcardother']").val("");// 已经重新上传，清空原有的图片
			} else {
				var url2 = $(":text[name='idurlcard']").val();
				if ((url2 != null) && (url2 != "") && (url2 != "null")) {
					$("#showcardpicid").attr("style", "display:block;");
					var cardurl1 = getRootPath() + url2;
					$("#imacardurlid").attr("href", cardurl1);
					$("#imacardurlid img").attr("src", cardurl1);

				}
			}

		});

		$("#cardpicidother").on("change", function() {
			var picValue = $(":file[name='fileother']").val();
			if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
				$("#showcardpicidother").attr("style", "display:none");
				$("#showcardpicidtogether").attr("style", "display:none");
				// $(":text[name='idurlcardother']").val("");// 已经重新上传，清空原有的图片
			} else {
				var url2 = $(":text[name='idurlcardother']").val();
				if ((url2 != null) && (url2 != "") && (url2 != "null")) {
					$("#showcardpicidother").attr("style", "display:block;");
					var cardurl1 = getRootPath() + url2;
					$("#imacardurlidother").attr("href", cardurl1);
					$("#imacardurlidother img").attr("src", cardurl1);

				}
			}

		});

	} else {
		$("#showquicktraninfo").hide();
	}
	findStorage4User();
	//alert("4522121");
	orderModifyCalcFreight_dhyb();
}
//kai 20151118 转运初始食道

function showChannelTableInTM_dhyb(details) {
	var wid = $("select[name='warehouse']").val();
	//alert(wid);
	$("select[name='cid']").html("<option >请选择渠道</option>");
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					//showCommodityTableInTM();
					showCommodityTable_dhyb(details);
					$("select[name='cid']").change(showCommodityTableInTM);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}


//kai 20150929显示转运已有商品

function showCommodityTable_dhyb(details) {
	
	$("#commodity_list_table tbody").html("");
	var wid = $("select[name='warehouse']").val();
	var cid = $("select[name='cid']").val();
	//alert(wid);
	//alert(cid);
	$
			.ajax({
				post : "get",
				url : admin_commodity_list_url,
				data : {
					"wid" : wid,
					"cid" : cid
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						var str_option = "";
						$.each(response.data, function() {
							str_option += "<option value='" + this.id
									+ "'  price='" + this.price + "' msPrice='"
									+ this.msPrice + "' vipOnePrice='"
									+ this.vipOnePrice + "' vipTwoPrice='"
									+ this.vipTwoPrice + "' vipThreePrice='"
									+ this.vipThreePrice + "'>" + this.name
									+ "</option>";
						});
						var str = "";
						$
								.each(
										details,
										function() {

											if ((this.sjweight == null)
													|| this.sjweight == "null") {
												this.sjweight = 0;
											}
											if ((this.eachjfweight == null)
													|| this.eachjfweight == "null") {
												this.eachjfweight = 0;
											}

											if ((this.xiangqing == null)
													|| this.xiangqing == "null") {
												this.xiangqing = "";
											}
											if ((this.quantity == null)
													|| this.quantity == "null") {
												this.quantity = 0;
											}
											
											if ((this.commoditySku == null)
													|| this.commoditySku == "null") {
												this.commoditySku = "";
											}
											
											//alert(this.commodityId);

											str += '<tr name="'
													+ this.commodityId
													+ '"><td>';
											str += '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight_dhyb()">'
													+ str_option + '</select>';
											str += '</td>';
											
											
											str += '<td><input type="text" class="text-input"type="text" name="commodifysku" id="commodifyskuid" style="width:140px" value="'
												+ this.commoditySku + '"' + ' /></td>';
											
											str += '<td><input type="text" class="text-input"type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:140px" value="'
												+ this.xiangqing
												+'" /></td>';
											
											str += '<td><input name="quantity" class="text-input" size="3" type="text"  onChange="orderModifyCalcFreight_dhyb()" value="'
												+ this.quantity
												+ '"/></td>';
											
											str += '<td><input name="eachsjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" value="'
												+ this.eachjfweight
												+'"/></td>';
											
											str += '<td><input name="sjweight" class="text-input" size="3" type="text" onChange="orderModifyCalcFreight_dhyb()" value="'
												+ this.sjweight
												+ '"/></td>';
											
											if((this.transitNo!="")||(this.transitNo!="null")||(this.transitNo!=null)||(this.transitNo!="null"))
											{
												str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+this.transitNo+'"  /></td>';
											}
											else
											{
												str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+$(":hidden[name='t_tran_no']").val()+'"  /></td>';
												
											}
											if((removenull(this.tranWarehouseId)!="")&&(this.tranWarehouseId!="0")&&(this.tranWarehouseId!="-1"))
											{
												str += '<td style="display:none"><input name="commodify_tranwarehouseid" readonly= "true" class="text-input"  type="text" value="'+this.tranWarehouseId+'"  /></td>';
											}
											else
											{
												var widno=removenull($(":hidden[name='t_tran_wid_no']").val());
												
												if(widno=="")
												{
													widno=0;
												}
												else
												{
													var tempv=widno.lastIndexOf("|");//包含分隔符
													if(tempv!=-1)
													{
														widno=$("select[name=state]").val();
													}
													else 
													{
														if((parseFloat(widno)!="NaN")&&(parseFloat(widno)<1))
														{
															widno=0;
														}
													}
												}
												
												str += '<td style="display:none"><input name="commodify_tranwarehouseid" readonly= "true" class="text-input"  type="text" value="'+widno+'"  /></td>';
										
												//str += '<td style="display:none"><input name="commodify_transitno" readonly= "true" class="text-input"  type="text" value="'+$(":hidden[name='t_tran_wid_no']").val()+'"  /></td>';
												
											}
											
											str += '<input name="transhipmentId" type="hidden" value="'
													+ this.transhipmentId
													+ '"/>';
											
											
											str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
										});
						$("#commodity_list_table tbody").html(str);

						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1)
								$(this).parent().parent().remove();
							orderModifyCalcFreight_dhyb();
							return false;
						});

						$.each(details, function() {
							$(
									"tr[name='" + this.commodityId
											+ "'] select option[value='"
											+ this.commodityId + "']").attr(
									"selected", true);
						});
						if(details!=null)
						{
							orderModifyCalcFreight_dhyb();
						}
					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					}
				}
			});
}


// /////////////////////////////////////////////////
function loadNav513Data() {
	$("#a_back_tranship_list_link").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */

		// $("#nav51").click();
		nav51Click();
		return false;
	});
}

// /////////////////////////////////////////////////
function loadNav52Data() {

	getglobalargs_commrate();
	loadFirstOrderList();//卧槽，这个文件里的只是一个幻象，在countOrdersMoney.js里的才是本体
	loadwid_imporeorder();// 引入仓库信息
	loadcid_imporeorder();// 引入信息信息
	// add by chenkanghua
	$("#import_order_from_weiyi").click(function() {
		$("#import_form_weiyi").ajaxSubmit({
			type : 'post',
			dataType : 'text',
			timeout : 600000,
			url : admin_order_import_from_weiyi,
			success : function(data) {

				$("#tmpmsgdiv2").html(data);
				var str = $("#tmpmsgdiv2 pre").html();

				var obj = $.parseJSON(str);

				var code = obj.code;

				if (code == "200") {
					alert("操作完成");
					loadNav52Data();
					// $("#nav55").click();
				} else {

					alert("操作失败，" + obj.message);
				}
				return false;
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}

		});
		return false;
	});

	
	$("#third_import_order_from_weiyi").click(function() {
		//alert("asdfasd");
		$("#import_form_weiyi").ajaxSubmit({
			type : 'post',
			dataType : 'text',
			timeout : 600000,
			url : admin_third_order_import_from_weiyi,
			success : function(data) {
//alert(data);
				$("#tmpmsgdiv2").html(data);
				var str = $("#tmpmsgdiv2 pre").html();

				var obj = $.parseJSON(str);

				var code = obj.code;

				if (code == "200") {
					alert("操作完成:"+obj.message);
					loadNav52Data();
					// $("#nav55").click();
				} else {

					alert("操作失败，" + obj.message);
				}
				return false;
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}

		});
		return false;
	});

	
	
	// add by chenkanghua
	$("#import_order_from_meitao").click(function() {
		$("#import_form_meitao").ajaxSubmit({
			type : 'post',
			dataType : 'text',
			url : admin_order_import_from_meitao,
			success : function(data) {
				if (data.indexOf('"200"')) {
					alert("操作完成");
					// $("#nav55").click();
				} else {
					alert("操作失败，" + data);
				}
				return false;
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}

		});
		return false;
	});

	// add by chenkanghua
	$("#export_order_to_meitao").click(function() {

		var oid = $(":text[name='search_order_no']").val();
		var sdate, edate, key, type, state;
		if (oid == null || oid == '') {
			var sdate = $(":text[name='sdate']").val();
			var edate = $(":text[name='edate']").val();
			var key = $(":text[name='key']").val();
			var type = $("select[name='type']").val();
			var state = $("select[name='state']").val();
		} else {
			$(":text[name='sdate']").val('');
			$(":text[name='edate']").val('');
			$(":text[name='key']").val('');
			$("select[name='type']").val('');
			$("select[name='state']").val('');
		}
		$.ajax({
			type : "get",
			url : admin_order_export_to_meitao,
			data : $.param({
				oid : oid,
				key : key,
				type : type,
				state : state,
				sd : sdate,
				ed : edate
			}, true),
			success : function(response) {

			}
		});
	});
	$(":submit[name='searchSub']").click(function() {
//alert("22222");
		var oid = $(":text[name='search_order_no']").val();
		$(":text[name='search_order_no']").val("");
		if (oid == null || oid == '') {
			var sdate = $(":text[name='sdate']").val();
			var edate = $(":text[name='edate']").val();
			var key = $(":text[name='key']").val();
			var type = $("select[name='type']").val();
			var state = $("select[name='state']").val();
			
			var typekey = $("select[name='typekey']").val();

			loadOrderList("", key, type, state,typekey, sdate, edate, "1");

			//loadOrderList("", key, type, state, sdate, edate, "1");
		} else {
			$(":text[name='sdate']").val('');
			$(":text[name='edate']").val('');
			$(":text[name='key']").val('');
			$("select[name='type']").val('');
			$("select[name='state']").val('');
			
		    $("select[name='typekey']").val('');
			loadOrderList(oid, "", "", "", "", "","", "1");
			//loadOrderList(oid, "", "", "", "", "", "1");
		}
		return false;
	});

	
	
	// kai 20150914 订单图片处理连接
	// alert("4454566");
	$("#a_order_pics_process_link").click(function() {
		// alert("sadfa");
		$("#main-content").load(admin_order_pics_process_link_url);
		return false;
	});

	$("#a_delete_order_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的运单！");
		} else {
			if (confirm("您是否确认要删除运单信息?")) {
				$.ajax({
					type : "post",
					url : admin_detail_order_delete_url,
					data : $.param({
						"oid" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							// kai 20150911-1 modify
							loadNav52Data();
							$("#nav52").click();

						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除运单失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#o_del_check_all").click(function() {

		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});
}


//kai 20150917 在导入订单时添加引入仓库信息
function loadwid_imporeorder()
{
	$
	.ajax({
		type : "get",
		async : true,
		// url:"../user/warehouse/all",
		url : "../warehouse/all",
		success : function(response) {
			var code = response.code;
			// alert(code);
			if (code == '200') {
				if (response.data != null) {
					var str = "";

					$.each(response.data, function() {
						
						
						
						
						if("admin"==$("#admin_id_flag").val())
						{
							
							str += "<option value='" + this.id + "'>"
							+ this.name + "</option>";
								
							
						}
						else
						{
							
							if(this.id==$("#store_id_flag").val())
							{
								str += "<option value='" + this.id + "'>"
								+ this.name + "</option>";
							}
						}
						
						
						
					});
				
					$("select[name='wid_upload']").html(str);
					$("select[name='wid_upload']").change(loadcid_imporeorder);
					
				}
			}
		}
	});
}
//kai 20150917 在导入订单时添加引入仓库的通道信息
function loadcid_imporeorder() {
	// alert(channelId);
	var wid = $("select[name='wid_upload']").val();
	$("select[name='cid_upload']").html("");
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '">' + this.name
								+ '</option>';
					});
					$("select[name='cid_upload']").html(str);
					

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}
// /////////////////////////////////////////////////
// kai 20150914 添加图片处理接口函数和订单下载
function loadNav521Data() {
	// loadFirstOrderList();
	//loadOrderList_pics("", "", "", "", "", "","","", "1");

	$(":button[name='searchSub']").click(function() {

		var oid = $(":text[name='search_order_no']").val();
		if (oid == null || oid == '') {
			var sdate = $(":text[name='sdate']").val();
			var edate = $(":text[name='edate']").val();
			var key = $(":text[name='key']").val();
			var type = $("select[name='type']").val();
			var state = $("select[name='state']").val();
			var wid = $("select[name='wid_download']").val();
			var cid = $("select[name='cid_downloadload']").val();
			var typekey=$("select[name='typekey']").val();

			loadOrderList_pics("", key, type, state,typekey, sdate, edate,wid,cid, "1");
		} else {
			$(":text[name='sdate']").val('');
			$(":text[name='edate']").val('');
			$(":text[name='key']").val('');
			$("select[name='type']").val('');
			$("select[name='state']").val('');
			$("select[name='wid_download']").val("-1");
			$("select[name='cid_downloadload']").val("-1");
			$("select[name='typekey']").val('');
			
			loadOrderList_pics(oid, "", "", "", "","", "","","", "1");
		}
		return false;
	});
	
	

	$(":submit[name='searchSub_fly']").click(function() {

		var flyno = $(":text[name='search_fly_no']").val();
		$.ajax({
			type : "get",
			url : "../admin/weborder/flyno",
			data : {
				flyno : flyno
			},
			success : function(response) {
				var code = response.code;

				if ("200" == code) {
					if (response.data == null) {
						showOrderList(null);
						showOrderLink(null);
						str = " 总订单数:<span style='color:red;'>" + "0" + "</span>条";
						$("#orders_no").html(str);
						countorderchecked();
					} else {

						// showOrderList(response.data.datas);
						showOrderList_pics(response.data.datas);
						// showOrderLink(response.data);
					}
					afterLoadOrderList();
				} else if ("607" == code) {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("获取运单失败，原因："+response.message);
					var info = "<td style='text-align: left;' colspan='8'>"
							+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
					$("#tab1 table tbody").html(info);
				}
				return false;
			}

		});
		return false;
	});
	
	
	$("#inputorderstoflyno").click(function() {
		var flyno=$(":text[name='ordertofly_name']").val();
		if(flyno=="")
		{
			alert("请先填入要归属的航班号!");
			return false;
		}
		
		var fly_state=$("select[name='fly_state']").val();
		if(fly_state=="-1")
		{
			fly_state="";
		}
		var m = 0;
		var checkbox = document.getElementsByName("order_checked_id"); // id表示你的checkbox的name属性
		var str_orders="";
		for (var i = 0; i < checkbox.length; i++) {
			if (checkbox[i].checked == true) {
				m=m+1;
				if(m==1)
				{
					str_orders=$(checkbox[i]).val();
				}
				else
				{
					str_orders=str_orders+","+$(checkbox[i]).val();
				}
			}
		}
		if(str_orders=="")
		{
			alert("请先选择要操作的运单!");
			return false;
		}
		
		$.ajax({
			type : "post",
			url : "../admin/order/modifyordersfly",
			data : {
				flightno : flyno,
				str_orders : str_orders,
				state : fly_state
			},
			success : function(response) {
				var code = response.code;
				if (code == "200") {
					alert("添加成功");
					
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("添加失败，失败原因是:" + response.message);
				}
			}
		});
		return false;
	});
	
	
	// kai 20150914 订单图片处理连接
	// alert("4454566");
	$("#a_order_pics_process_link").click(function() {
		// alert("sadfa");
		$("#main-content").load(admin_order_pics_process_link_url);
		return false;
	});

	$("#o_order_checked_all").click(function() {
//alert("asdfas");
		if ($(this).is(':checked')) {
			$('input[name="order_checked_id"]').attr("checked", 'true');
		} else {
			$('input[name="order_checked_id"]').removeAttr("checked");
		}
		countorderchecked();
	});

//	$("#order_checked_id")(function() {

		//alert("sdf22");
		/*
		 * if ($(this).is(':checked')) {
		 * $('input[name="order_checked_id"]').attr("checked", 'true'); } else {
		 * $('input[name="order_checked_id"]').removeAttr("checked"); }
		 */
	//});

	//kai 20150915
	countorderchecked();
	
	//kai 20151028导入仓库信息
	loadwid_downloadorder();// 引入仓库信息
	
	

	
}

function onclick_checked_commoditys()
{
	var checkbox = document.getElementsByName("o_order_checked_commoditys"); // id表示你的checkbox的name属性
	var str="";
	
	for (var i = 0; i < checkbox.length; i++) {
		
		if (checkbox[i].checked == true) {
			//alert(checkbox[i].value);
			if(str=="")
			{
				str=checkbox[i].value;
			}
			else
			{
				str=str+","+checkbox[i].value;
			}
		}
	}
	$(":text[name='commudity_hidden']").val(str);
}
//kai 20151028 在导出订单时装的仓库
function loadwid_downloadorder()
{
	$
	.ajax({
		type : "get",
		async : true,
		// url:"../user/warehouse/all",
		url : "../warehouse/all",
		success : function(response) {
			var code = response.code;
			// alert(code);
			if (code == '200') {
				if (response.data != null) {
					var str = '<option value="-1">请选择门店</option>';
				
					$.each(response.data, function() {
						/*str += "<option value='" + this.id + "'>"
								+ this.name + "</option>";*/
						
						if("admin"==$("#admin_id_flag").val())
						{
							str += "<option value='" + this.id + "'>"
							+ this.name + "</option>";								
						}
						else
						{
							
							if(this.id==$("#store_id_flag").val())
							{
								str = "<option value='" + this.id + "'>"
								+ this.name + "</option>";
							}
						}

						
					});
				
					$("select[name='wid_download']").html(str);
					$("select[name='wid_download']").change(loadcid_downloadorder);
					if(("admin"!=$("#admin_id_flag").val())&&(str!='<option value="-1">请选择门店</option>'))
					{
						loadcid_downloadorder();
					}
					
					
				}
			}
		}
	});
}
//kai 20151028 在导出订单时装的渠道方式
function loadcid_downloadorder() {
	// alert(channelId);
	var wid = $("select[name='wid_download']").val();
	if(wid=="-1")//没有选择仓库
	{
		var str = '<option value="-1">请选择渠道</option>';
		$("select[name='cid_downloadload']").html(str);
		return false;
	}
	$("select[name='cid_downloadload']").html("");
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = '<option value="-1">请选择渠道</option>';
					$.each(response.data, function() {
						str += '<option value="' + this.id + '">' + this.name
								+ '</option>';
					});
					$("select[name='cid_downloadload']").html(str);
					

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

//kai 20150915 选中订单的条数
function countNum() {
	var m = 0;
	var checkbox = document.getElementsByName("order_checked_id"); // id表示你的checkbox的name属性
	for (var i = 0; i < checkbox.length; i++) {
		if (checkbox[i].checked == true) {
			m = m + 1;
		}
	}
	return m;
}
//kai 20150915 选中订单的条数
function countNum_picchecked() {
	var m = 0;
	var checkbox = document.getElementsByName("o_order_checked_pics"); // id表示你的checkbox的name属性
	for (var i = 0; i < checkbox.length; i++) {
		if (checkbox[i].checked == true) {
			m = m + 1;
		}
	}
	return m;
}

//kai 20151028 选中订单的条数
function countNum_commoditychecked() {
	var m = 0;
	var checkbox = document.getElementsByName("o_order_checked_commoditys"); // id表示你的checkbox的name属性
	for (var i = 0; i < checkbox.length; i++) {
		if (checkbox[i].checked == true) {
			m = m + 1;
		}
	}
	return m;
}
// 用于点击计算被选择的订单条数
function countorderchecked() {
	var numbers=countNum();
	var str=" 选中订单数:<span style='color:red;'>"+numbers+"</span>条";
	$("#orderschecked_no").html(str);
	
}

function submitorderdowloadclik()
{
	//alert(document.submitdownn.button_submit.value);
	var numbers=countNum();
	if(numbers==0)
	{
		alert("请先选择要操作的订单!");
		return false;
	}
	numbers=countNum_picchecked();
	var num=countNum_commoditychecked();
	//if((document.submitdownn.button_submit.value=="pictures download"))
	//{
		//alert("222");
		if(numbers==0)
		{
			alert("请选择要下载的图片类型!");
			return false;
		}
		
		if(num==0)
		{
			alert("请选择商品数据下载方式!");
			return false;
		}
	//}
	return true;
	
}

function loadFirstOrderList() {
	loadOrderList("", "", "", "", "","", "", "1");
}

function loadOrderList(oid, key, type, state, typekey,sdate, edate, pn) {

	$(":hidden[name='key']").val(key);
	$(":hidden[name='type']").val(type);
	$(":hidden[name='state']").val(state);
	$(":hidden[name='sdate']").val(sdate);
	$(":hidden[name='edate']").val(edate);
	$(":hidden[name='pn']").val(pn);
	$(":hidden[name='typekey']").val(typekey);

	$.ajax({
		type : "get",
		url : admin_order_list_url,
		data : {
			oid : oid,
			key : key,
			type : type,
			state : state,
			typekey : typekey,
			sd : sdate,
			ed : edate,
			pageIndex : pn
		},
		success : function(response) {
			var code = response.code;

			if ("200" == code) {
				if (response.data == null) {
					showOrderList(null);
					showOrderLink(null);
				} else {

					showOrderList(response.data.datas);
					showOrderLink(response.data);
				}
				afterLoadOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}

	});
}
// kai 20150914 modify
function loadOrderList_pics(oid, key, type, state,typekey, sdate, edate,wid,cid, pn) {
	
	if((oid=="")&&(key=="")&&(type=="-1")&&(state=="-1")&&(sdate=="")&&(edate=="")&&(wid=="-1")&&(cid=="-1")&&(typekey==""))
	{
		alert("请输入搜索条件，不能全为空!");
		return false;
	}
//alert(wid);
	$(":hidden[name='key']").val(key);
	$(":hidden[name='type']").val(type);
	$(":hidden[name='state']").val(state);
	$(":hidden[name='sdate']").val(sdate);
	$(":hidden[name='edate']").val(edate);
	$(":hidden[name='pn']").val(pn);
	$(":hidden[name='wid']").val(wid);
	$(":hidden[name='cid']").val(cid);
	$(":hidden[name='typekey']").val(typekey);
	


	$.ajax({
		type : "get",
		url : "../admin/weborder/searchall",
		data : {
			oid : oid,
			key : key,
			type : type,
			state : state,
			typekey :typekey,
			sd : sdate,
			ed : edate,
			wid : wid,
			cid :cid,
			pageIndex : pn
		},
		success : function(response) {
			var code = response.code;

			if ("200" == code) {
				if (response.data == null) {
					showOrderList(null);
					showOrderLink(null);
					str = " 总订单数:<span style='color:red;'>" + "0" + "</span>条";
					$("#orders_no").html(str);
					countorderchecked();
				} else {

					// showOrderList(response.data.datas);
					showOrderList_pics(response.data.datas);
					// showOrderLink(response.data);
				}
				afterLoadOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("获取运单失败，原因："+response.message);
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}

	});
}







function showOrderList_pics(list) {

	var str = "";
	var flag_no = 0;
	if (list != null) {
		$("#tab1 table tbody").html("");
		var alllength=list.length;
		if(removenull(alllength)!="")
		{
			if(alllength<3001)
			{}
			else if(alllength>6000)
			{
				alert("对不起，你选择的条件得到的结果超过6000条，只能直接下载运单或缩小搜索范围!");
				return false;
			}
			else
			{
				alert("运单号数量超过3000,将只显示单号!");
			}
			
		}

		$
				.each(
						list,
						function() {

							if(alllength<3001)
							{
							flag_no = flag_no + 1;
							str += "<tr id='" + this.id + "'>";
							// kai 20150911-1 modify
							str += "<td style='text-align:center;'>" + flag_no
									+ "</td>";

							str += "<td style='text-align:center;'><input type='checkbox' name='order_checked_id' onclick='countorderchecked()' value='"
									+ this.orderId + "'/></td>";

							str += "<td >" + this.orderId + "</td>";
							var tc = "";
							/*$.each(this.details, function() {
								tc += this.ctype + ":" + this.quantity + ";";
							});*/
							str += "<td>" + tc + "</td>";
							
							
							if (this.user == null) {
								str += "<td>&nbsp;</td>";
							} else {
								var strtemp="";
								if((this.user.phone==null)||(this.user.phone=="null")||(this.user.phone=="")||(this.user.phone=="undefined"))
								{
									
								}
								else
								{
									strtemp=this.user.phone;
								}
								if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
								{
									
								}
								else
								{
									if(strtemp!="")
									{
										strtemp=strtemp+"/"+this.user.email;
									}
									else
									{
										strtemp=this.user.email;
									}
									
								}
								if((this.user.nickName==null)||(this.user.nickName=="null")||(this.user.nickName=="")||(this.user.nickName=="undefined"))
								{
									
								}
								else
								{
									if(strtemp!="")
									{
										strtemp=strtemp+"/"+this.user.nickName;
									}
									else
									{
										strtemp=this.user.nickName;
									}
									
								}
								
								if((this.user.realName==null)||(this.user.realName=="null")||(this.user.realName=="")||(this.user.realName=="undefined"))
								{
									
								}
								else
								{
									if(strtemp!="")
									{
										strtemp=strtemp+"/"+this.user.realName;
									}
									else
									{
										strtemp=this.user.realName;
									}
									
								}
								
								str += "<td>" + strtemp + "</td>";
							}

							str += "<td>" + this.cName + "</td>";
							str += "<td>" + this.stateStr + "</td>";
							str += "<td>" + this.createDate + "</td>";
							var baseUrl=getRootPath();
							if (this.cardurl == null || this.cardurl == ''
									|| this.cardurl == 'null') {
								str += "<td style='text-align:center;'>无</td>";
							} else {
								var url = this.cardurl;
								url = baseUrl + url;
								str += "<td style='text-align:center;'><a href='"
										+ url
										+ "'  target='_blank'><img width='30px' height='30px' src='"
										+ url + "'/></a></td>";
							}

							if (this.cardurlother == null || this.cardurlother == ''
								|| this.cardurlother == 'null') {
							str += "<td style='text-align:center;'>无</td>";
						} else {
							var url = this.cardurlother;
							url = baseUrl + url;
							str += "<td style='text-align:center;'><a href='"
									+ url
									+ "'  target='_blank'><img width='30px' height='30px' src='"
									+ url + "'/></a></td>";
						}
							if (this.cardurltogether == null || this.cardurltogether == ''
								|| this.cardurltogether == 'null') {
							str += "<td style='text-align:center;'>无</td>";
						} else {
							var url = this.cardurltogether;
							url = baseUrl + url;
							str += "<td style='text-align:center;'><a href='"
									+ url
									+ "'  target='_blank'><img width='30px' height='30px' src='"
									+ url + "'/></a></td>";
						}
							// kai 20150911-1 modify
							/*
							 * if (this.state == "0" || this.state == "1" ||
							 * this.state == "-1" || this.state == "-10") { str += "<td><a
							 * href='" + this.orderId + "'
							 * name='a_order_modify_link'>修改</a></td>"; }
							 * else { str += "<td id='" + this.orderId + "'><a
							 * href='" + this.orderId + "'
							 * name='a_order_print_link'>打印</a></td>"; }
							 */
							str += "</tr>";
							}
							else if(alllength>6000)
							{
								
							}
							else
							{
								
								flag_no = flag_no + 1;
								str += "<tr id='" + this.id + "'>";
								// kai 20150911-1 modify
								str += "<td>" + flag_no
										+ "</td>";

								str += "<td style='text-align:center;'><input type='checkbox' name='order_checked_id' onclick='countorderchecked()' value='"
									+ this.orderId + "'/></td>";

								str += "<td >" + this.orderId + "</td>";
								var tc = "";
								/*$.each(this.details, function() {
									tc += this.ctype + ":" + this.quantity + ";";
								});*/
								str += "<td>" + tc + "</td>";
								
								str += "<td></td>";
								

								str += "<td>" + "" + "</td>";
								str += "<td>" + "" + "</td>";
								str += "<td>" + "" + "</td>";
								str += "<td>" + "" + "</td>";
								str += "<td>" + "" + "</td>";
								str += "<td>" + "" + "</td>";
								
								str += "</tr>";
							}
							$("#tab1 table tbody").append(str);
							str="";
						});

	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='8'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的运单信息!</span></td>";
		}
	}

	//$("#tab1 table tbody").html(str);
	str = "";
	str = " 总订单数:<span style='color:red;'>" + flag_no + "</span>条";
	$("#orders_no").html(str);
	countorderchecked();

}

//kai 20151004 添加用户提交时的并没有打印的处理方式
function showOrderList(list) {

	var str = "";
	if (list != null) {

		$.each(list, function() {

			str += "<tr id='" + this.id + "'>";
			// kai 20150911-1 modify
			if ((this.state == "0") || (this.state == "1")
					|| (this.state == "-10")) {
				str += "<td><input type='checkbox' name='del_id' value='"
						+ this.orderId + "'/></td>";
			} else {
				str += "<td>&nbsp;</td>";
			}
			
			//str += "<td >" + this.orderId + "</td>";
			str += '<td><a href="' + this.orderId
			+ '" name="a_order_route_detail_link">'
			+ this.orderId + '</a></td>';
			
			var tc = "";
			$.each(this.orderDetailTranshipmentIds, function() {
				tc += this + "<br/>";
			});
			str += "<td>" + tc + "</td>";
			if (this.user == null) {
				str += "<td>&nbsp;</td>";
			} else {
				//str += "<td>" + this.user.phone + "</td>";
				var strtemp="";
				if((this.user.phone==null)||(this.user.phone=="null")||(this.user.phone=="")||(this.user.phone=="undefined"))
				{
					
				}
				else
				{
					strtemp=this.user.phone;
				}
				if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
				{
					
				}
				else
				{
					if(strtemp!="")
					{
						strtemp=strtemp+"/"+this.user.email;
					}
					else
					{
						strtemp=this.user.email;
					}
					
				}
				if((this.user.nickName==null)||(this.user.nickName=="null")||(this.user.nickName=="")||(this.user.nickName=="undefined"))
				{
					
				}
				else
				{
					if(strtemp!="")
					{
						strtemp=strtemp+"/"+this.user.nickName;
					}
					else
					{
						strtemp=this.user.nickName;
					}
					
				}
				
				if((this.user.realName==null)||(this.user.realName=="null")||(this.user.realName=="")||(this.user.realName=="undefined"))
				{
					
				}
				else
				{
					if(strtemp!="")
					{
						strtemp=strtemp+"/"+this.user.realName;
					}
					else
					{
						strtemp=this.user.realName;
					}
					
				}
				
				str += "<td>" + strtemp + "</td>";
			}

			str += "<td>" + this.cName + "</td>";
			str += "<td>" + this.stateStr + "</td>";
			var storagePosition = "&nbsp;";
			if(null != this.storagePosition){
				storagePosition = this.storagePosition.storageName + "-" + this.storagePosition.rowNumber + "-" + this.storagePosition.colNumber;
			}
			str += "<td>" + storagePosition + "</td>";
			
			
			
			
			if(removenull(this.typeKey)!="")
			{
				if(this.typeKey=="1")
				{
					str+="<td>门市运单</td>";
				}
				else if(this.typeKey=="2")
				{
					str+="<td>转运运单</td>";
				}
				else if(this.typeKey=="3")
				{
					str+="<td>网上置单</td>";
				}
				else if(this.typeKey=="4")
				{
					str+="<td>第三方运单</td>";
				}
				else if(this.typeKey=="5")
				{
					str+="<td>上门收货</td>";
				}
				else if(this.typeKey=="6")
				{
					str+="<td>空运单</td>";
				}
				else if(this.typeKey=="7")
				{
					str+="<td>批量生成门市运单</td>";
				}
				else
				{
					
					str+="<td>"+removenull(this.typeKey)+"</td>";
				}
			}
			else
			{
				str+="<td>"+"</td>";
			}
			
			
			
			
			
			
			str += "<td>" + this.createDate + "</td>";
			// kai 20150911-1 modify

			if (this.state == "0" || this.state == "1" || this.state == "-1"
					|| this.state == "-10") {
				if(print_orders_for_low_state=="1")//添加可以打印处理
				{
					str += "<td id='" + this.orderId + "'><a href='" + this.orderId
						+ "' name='a_order_modify_link'>修改</a> | <a href='" + this.orderId
					+ "' name='a_order_print_a4_link'>A4打印</a> | <a href='" + this.orderId
					+ "' name='a_order_print_link'>热敏(4x6)</a></td>";
				}
				else
				{
					str += "<td><a href='" + this.orderId
						+ "' name='a_order_modify_link'>修改</a></td>";
				}
			} else {
				/*if((this.state == "2")&&(this.tranPro==0))
				{
					str += "<td id='" + this.orderId + "'><a href='" + this.orderId
						+ "' name='a_order_modify_link'>修改</a>|<a href='" + this.orderId
						+ "' name='a_order_print_a4_link'>A4打印</a>|<a href='" + this.orderId
					+ "' name='a_order_print_link'>热敏(4x6)</a></td>";
				}
				else
				{*/
					str += "<td id='" + this.orderId + "'><a href='" + this.orderId
						+ "' name='a_order_print_a4_link'>A4打印</a> | <a href='" + this.orderId
						+ "' name='a_order_print_link'>热敏(4x6)</a></td>";
				//}
			}
			str += "</tr>";
		});

	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='11'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的运单信息!</span></td>";
		}
	}

	$("#tab1 table tbody").html(str);
	
	$("a[name='a_order_route_detail_link']").click(function() {
		var oid = $(this).attr("href");
		var url = admin_route_order_detail_page_url + "?oid=" + oid;
		$("#main-content").load(url);
		return false;
	});
}



function showOrderLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			var key = $(":hidden[name='key']").val();
			var type = $(":hidden[name='type']").val();
			var state = $(":hidden[name='state']").val();
			var sdate = $(":hidden[name='sdate']").val();
			var edate = $(":hidden[name='edate']").val();
			//loadOrderList("", key, type, state, sdate, edate, pn);
			var typekey = $(":hidden[name='typekey']").val();
			//alert(typekey);
			loadOrderList("", key, type, state,typekey, sdate, edate, pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					var key = $(":hidden[name='key']").val();
					var type = $(":hidden[name='type']").val();
					var state = $(":hidden[name='state']").val();
					var sdate = $(":hidden[name='sdate']").val();
					var edate = $(":hidden[name='edate']").val();
					//loadOrderList("", key, type, state, sdate, edate, pn);
					var typekey = $(":hidden[name='typekey']").val();
					//alert(typekey);
					loadOrderList("", key, type, state,typekey, sdate, edate, pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadOrderList() {
	$("a[name='a_order_modify_link']").click(function() {
		var id = $(this).attr("href");
		var url = admin_order_modify_page_url + "?orderId=" + id;
		$("#main-content").load(url);
		return false;
	});

	$("a[name='a_order_print_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		var orderId = $(this).parent().attr("id");

		var url = admin_print_page_url + "?id=" + id + "&orderId=" + orderId;

		$("#my_print_div").load(url);
		return false;
	});
	$("a[name='a_order_print_a4_link']").click(function() {

		
		var id = "";
		var orderId = $(this).parent().attr("id");

		var url = admin_print_A4_page_url + "?id=" + id + "&orderId=" + orderId;

		$("#my_print_div").load(url);
		return false;
	});
}

// //////////////////////////////////////////////////////

//装载他就信息
divide_number = 0;
function loadNav522Data() {
	getglobalargs_commrate();//获取进位值
	$.ajax({
		type : "get",
		url : admin_tranship_get_by_order_url,
		data : {
			"oid" : $(":hidden[name='orderId']").val()
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data != null) {
					showOrderTranshipmentInfo(response.data);
				}
			}
		}
	});

	
	//获取保险的比例额度
	//var flags="print_order_hit,print_site_url";//获取logo图片,包裹提示,网站的url
	var flags="premium_rate";//
	 $.ajax({
			type : "post",
			url : admin_globalargs_getcontents_url,
			data : {
				"flags" : flags
			},
			success : function(response) {
				var code = response.code;

				//alert(code);
				if ("200" == code) {
					//alert(response.data[0]);
					$(":hidden[name='premiumratevalue']").val(response.data[0]);
				}
				else
				{
					$(":hidden[name='premiumratevalue']").val("0");
				}
			}
	 });
	
	
	$.ajax({
		type : "get",
		url : admin_order_get_one_url,
		data : {
			"oid" : $(":hidden[name='orderId']").val()
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data != null) {
					// kai 20150919-1 modify
					$("#curstateid").html(response.data.state);// 保存当前订单状态
					if (response.data.state == "-10")// 网上车置单的处理方式
					{
						showOrderInfo_wsjd(response.data);
					} else {
						showOrderInfo(response.data);
					}
					if(null != response.data.storagePosition){
						$("#storagePositionId").val(response.data.storagePosition.id);
						$("#storageName").val(response.data.storagePosition.storageName);
						$("#storagePositionColNumber").val(response.data.storagePosition.colNumber);
						$("#storagePositionRowNumber").val(response.data.storagePosition.rowNumber);
					}
					
					afterLoadOneOrderInfo();
				} else {
					alert("没有对应id的运单记录!");
					// $("#nav52").click();
					nav52Click();
				}
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("获取运单详情失败，失败原因是：" + response.message);
				// $("#nav52").click();
				nav52Click();
			}
		}
	});

	
	$(":text[name='premiumtotal']").change(countpremiummoney_modifyorder);
	$(":text[name='weight']").change(orderModifyCalcFreight);
	$(":text[name='tariff']").change(orderModifyCalcFreight);
	$(":text[name='other']").change(orderModifyCalcFreight);
	$(":text[name='length']").change(orderModifyCalcFreight);
	$(":text[name='width']").change(orderModifyCalcFreight);
	$(":text[name='height']").change(orderModifyCalcFreight);
	$(":text[name='sjweight']").change(orderModifyCalcFreight);
	$(":text[name='premium']").change(orderModifyCalcFreight);

	// obj.css({ "border-color": "" });

	$("#a_back_order_list_link").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */
		// $("#nav52").click();
		nav52Click();
		return false;
	});

	// kai 20150913 添加网上置单的分箱功能

	/*
	 * $("#a_add_onlineorder_divide_link") .click( function() {
	 * alert(divide_number); var
	 * onlineordercontext=$("#onlineorder_divide_id").html();
	 * onlineordercontext="<div id='onlineorder_divide_id_other'
	 * class='box_content'>"+onlineordercontext+"</div>";
	 * 
	 * $("#onlineorder_divide_id").parent().append(onlineordercontext);
	 * $("#onlineorder_divide_id_other").children().find("select[name='cid']").attr("name","cid"+divide_number);
	 * var
	 * str=$("#onlineorder_divide_id_other").children().find("select[name='cid111111']").val();
	 * $("#onlineorder_divide_id_other").attr("id","onlineorder_divide_id_other"+divide_number);
	 * //$("#bt_modify_order").attr("id","bt_modify_order"+divide_number);
	 * $("input[id='bt_modify_order']").attr("id","bt_modify_order"+divide_number);
	 * //str=$("input[id='bt_modify_order']").parent().parent().parent().parent().parent().parent().find("select[name='cid']").val();
	 * //str=$("input[id='bt_modify_order']").parent().parent().parent().parent().parent().parent().parent().find("select[name='cid']").val();
	 * alert(str); divide_number=divide_number+1;
	 * 
	 * 
	 * return false; });
	 * 
	 */
	// 修改订单返回按钮
	$("#bt_back_add_msj_order_list").click(function() {
		$("#main-content").load(admin_msj_order_add_page_url, {
			"username" : $("#pay_nick_name").html(),
			"realname" : $("#real_name").html()
		});
	});
	$("#a_add_commodity_quantity_link")
			.click(
					function() {
						var commodity = $("select[name='commodityId']").html();
						var str = '<tr><td>'
								+ '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight()">'
								+ commodity + '</select></td>';
						str += '<td><input type="text" class="text-input"type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:140px" /></td>';
						str += '<td><input type="text" class="text-input"type="text" name="commodifybrands" placeholder="填写具体物品牌"style="width:140px" /></td>';
						str += '<td><input name="quantity" class="text-input" size="3" type="text" value="1"/></td>';
						str += '<td><input name="jwweight" class="text-input" size="3" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
						str += '<td><input name="sjweight" class="text-input" size="3" readonly="readonly" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
						// str += '<td><input name="jfweight" class="text-input"
						// size="3" type="text" /></td>';
						str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
						$("#commodity_list_table tbody").append(str);
						// afterShowModifyTranshipInfo();
						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1) {
								$(this).parent().parent().remove();
								orderModifyCalcFreight();
							}

							return false;
						});
						return false;
					});
	$("#bt_modify_order")
			.click(
					function() {

						// var str_prex1="";
						// str_prex1=this.parent().html();
						// alert("55555");
						// alert(str_prex1);
						// return;
						var orderId = $(":hidden[name='orderId']").val();
						var order_Id = $(":text[name='ordername_id']").val();// 当前订单的id号

						var transhipmentId = $(":hidden[name='transhipmentId']")
								.val();
						var state = $("select[name='state']").val();
						var weight = $(":text[name='weight']").val();
						
						var sumweight = $(":text[name='sum_weight']").val();

						var weightKg = $(":text[name='weightKg']").val();

						var tariff = $(":text[name='tariff']").val();
						var or = "0";
						var other = $(":text[name='other']").val();
						var totalmoney = $(":text[name='totalmoney']").val();

						//var premium = $(":hidden[name='premium']").val();
						//kai 20151004 modify 修改 原来现代是修改订单不成功，原因是hidden类型不对应
						var premium = $(":text[name='premium']").val();
						//alert(premium);
						var mail = $("select[name='mail']").val();
						var cName = $(":text[name='cName']").val();
						var cCity = $(":text[name='cCity']").val();
						var cDistrict = $(":text[name='cDistrict']").val();
						var cProvince = $(":text[name='cProvince']").val();
						var cStreetAddress = $(":text[name='cStreetAddress']")
								.val();
						var cZipCode = $(":text[name='cZipCode']").val();
						var cPhone = $(":text[name='cPhone']").val();
						var remark = $("textarea[name='remark']").val();
						var type = $(":hidden[name='type']").val();

						var length = $(":text[name='length']").val();
						var width = $(":text[name='width']").val();
						var height = $(":text[name='height']").val();
						var parceValue = $(":text[name='parceValue']").val();

						var cid = $("select[name='cid']").val();
						var wid = $("select[name='wid']").val();
						
						
						//导入第三方信息
						var third_commidtylist= $("textarea[name='third_commidtylist']").val();
						var third_brands= $("textarea[name='third_brands']").val();
						var importRemark= $("textarea[name='importRemark']").val();
						var thirdCreateDate = $(":text[name='thirdCreateDate']").val();
						var flight = $(":text[name='flight']").val();
						var boxNo = $(":text[name='boxNo']").val();
						var payOrNot = $(":text[name='payOrNot']").val();
						var baseMoney = $(":text[name='baseMoney']").val();
						var expressName = $(":text[name='expressName']").val();
						var cardOrNot = $(":text[name='cardOrNot']").val();
//alert(wid);
						var cardid = $(":text[name='cardidname']").val();// 身份证id
						// alert(cardid);
						var validate = true;
						var tran_no_flag=$(":hidden[name='tran_no_flag']").val();//标识转动订单是否已经处理
						var tranPro="";
						
						var t_s_address = $(":text[name='t_s_address']").val();// 
						var t_s_city = $(":text[name='t_s_city']").val();// 
						var t_s_state = $(":text[name='t_s_state']").val();// 
						var t_s_zipcode = $(":text[name='t_s_zipcode']").val();// 
						
						if(tran_no_flag=="yes")
						{
							tranPro=$("select[id='tran_progress']").val();
						}else
						{
							tranPro="";
						}

						if (cid == null || cid == "请选择渠道" || cid == "-1") {
							$("select[name='cid']").css({
								"border-color" : "red"
							});
							$("select[name='cid']")
									.change(
											function() {
												if ($("select[name='cid']")
														.val() != null
														&& !$(
																"select[name='cid']")
																.val() == "请选择渠道"
														&& !$(
																"select[name='cid']")
																.val() == "-1")
													$("select[name='cid']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (weight == "" || weight == null || isNaN(weight)
								|| weight == "0") {
							$(":text[name='weight']").css({
								"border-color" : "red"
							});
							$(":text[name='weight']")
									.change(
											function() {
												if ($(":text[name='weight']")
														.val() != null
														&& !isNaN($(
																":text[name='weight']")
																.val())
														&& $(
																":text[name='weight']")
																.val() > 0)
													$(":text[name='weight']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (weightKg == "" || weightKg == null
								|| isNaN(weightKg) || weight == "0") {
							$(":text[name='weightKg']").css({
								"border-color" : "red"
							});
							$(":text[name='weightKg']")
									.change(
											function() {
												if ($(":text[name='weightKg']")
														.val() != null
														&& !isNaN($(
																":text[name='weightKg']")
																.val())
														&& $(
																":text[name='weightKg']")
																.val() > 0)
													$(":text[name='weightKg']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (length == "" || length == null || isNaN(length)) {
							$(":text[name='length']").css({
								"border-color" : "red"
							});
							$(":text[name='length']")
									.change(
											function() {
												if ($(":text[name='length']")
														.val() != null
														&& !isNaN($(
																":text[name='length']")
																.val()))
													$(":text[name='length']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (width == "" || width == null || isNaN(width)) {
							$(":text[name='width']").css({
								"border-color" : "red"
							});
							$(":text[name='width']")
									.change(
											function() {
												if ($(":text[name='width']")
														.val() != null
														&& !isNaN($(
																":text[name='width']")
																.val()))
													$(":text[name='width']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (height == "" || height == null || isNaN(height)) {
							$(":text[name='height']").css({
								"border-color" : "red"
							});
							$(":text[name='height']")
									.change(
											function() {
												if ($(":text[name='height']")
														.val() != null
														&& !isNaN($(
																":text[name='height']")
																.val()))
													$(":text[name='height']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}
						if (parceValue == "" || parceValue == null
								|| isNaN(parceValue)) {
							$(":text[name='parceValue']").css({
								"border-color" : "red"
							});
							$(":text[name='parceValue']")
									.change(
											function() {

												if (!isNaN($(
														":text[name='parceValue']")
														.val())
														&& $(
																":text[name='parceValue']")
																.val() != ""
														&& $(
																":text[name='parceValue']")
																.val() != null)
													$(
															":text[name='parceValue']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (totalmoney == null) {
							alert("请输入总运费totalmoney");
						}

						// kai 20150915 付钱状态
						var pay_flag = "no";
						//alert(tran_no_flag);
						if ((state == "2")&&((tran_no_flag!="yes"))) {
							state = "1";// 修改为未付款状态
							pay_flag = "yes";
						}

						var str = '"orderId":"' + orderId + '",' + '"state":"'
								+ state + '",' + '"weight":"' + weight + '",' + '"jwweight":"' + sumweight + '",'							
								+ '"tariff":"' + tariff + '",' + '"or":"' + or
								+ '",' + '"other":"' + other + '",'
								+ '"premium":"' + premium + '",' + '"mail":"'
								+ mail + '",' + '"cName":"' + cName + '",'
								+ '"cCity":"' + cCity + '",' + '"cDistrict":"'
								+ cDistrict + '",' + '"cProvince":"'
								+ cProvince + '",' + '"cStreetAddress":"'
								+ cStreetAddress + '",' + '"cZipCode":"'
								+ cZipCode + '",' + '"cPhone":"' + cPhone
								+ '",' + '"totalMoney":"' + totalmoney + '",'
								+ '"remark":"' + remark + '",' + '"length":"'
								+ length + '",' + '"width":"' + width + '",'
								+ '"cardid":"' + cardid + '",' + '"weightKg":"'
								+ weightKg + '",' + '"height":"' + height
								+ '",' + '"warehouseId":"' + wid + '",'+ '"tranPro":"' + tranPro + '",'
								+ '"parceValue":"' + parceValue + '",'
								+ '"channelId":"' + cid + '",' + '"type":"'
								+ type + '",'
								+ '"commodityThirdList":"' + third_commidtylist + '",'
								+ '"thirdBrands":"' + third_brands + '",'
								+ '"importRemark":"' + importRemark + '",'
								+ '"thirdCreateDate":"' + thirdCreateDate + '",'
								+ '"flight":"' + flight + '",'
								+ '"boxNo":"' + boxNo + '",'
								+ '"payOrNot":"' + payOrNot + '",'
								+ '"baseMoney":"' + baseMoney + '",'
								+ '"expressName":"' + expressName + '",'
								+ '"cardOrNot":"' + cardOrNot + '",'
								+ '"senduserAddress":"' + t_s_address + '",'
								+ '"senduserCity":"' + t_s_city + '",'
								+ '"senduserState":"' + t_s_state + '",'
								+ '"senduserZipcode":"' + t_s_zipcode + '",'
								+ '"parceValue":"' + parceValue + '"';
						
						
					
						
						

						var details = [];
						var i = 0;

						$("select[name='commodityId']")
								.each(
										function() {
											var cname = $(this).val();
											var cquantityobj = $(this)
													.parent()
													.parent()
													.find(
															":input[name='quantity']");
											var cquantity = cquantityobj.val();

											var sjweightobj = $(this)
													.parent()
													.parent()
													.find(
															":input[name='sjweight']");
											
											
											var csjweight = sjweightobj.val();

											if (cquantity == ""
													|| cquantity == null
													|| isNaN(cquantity)
													|| cquantity == "0") {
												cquantityobj.css({
													"border-color" : "red"
												});
												cquantityobj
														.change(function() {
															if (cquantityobj
																	.val() != null
																	&& !isNaN(cquantityobj
																			.val())
																	&& cquantityobj
																			.val() > 0)
																cquantityobj
																		.css({
																			"border-color" : ""
																		});
														});
												validate = false;
											}
											if (csjweight == ""
													|| csjweight == null
													|| isNaN(csjweight)
													|| csjweight == "0") {
												sjweightobj.css({
													"border-color" : "red"
												});
												sjweightobj
														.change(function() {
															if (sjweightobj
																	.val() != null
																	&& !isNaN(sjweightobj
																			.val())
																	&& sjweightobj
																			.val() > 0) {
																sjweightobj
																		.css({
																			"border-color" : ""
																		});
																orderModifyCalcFreight();
															}

														});
												validate = false;
											}
											var cxiangqing = $(this)
													.parent()
													.parent()
													.find(
															":input[name='commodifyxiangqing']")
													.val();
											
											
											var commodifybrands = $(this)
											.parent()
											.parent()
											.find(
													":input[name='commodifybrands']")
											.val();
											
											var jwweight=$(this)
											.parent()
											.parent()
											.find(
													":input[name='jwweight']")
											.val();
									
											
											str += ',"details[' + i
													+ '].commodityId":"'
													+ cname + '"';
											str += ',"details[' + i
													+ '].quantity":"'
													+ cquantity + '"';
											str += ',"details[' + i
													+ '].sjweight":"'
													+ csjweight + '"';
											str += ',"details[' + i
											+ '].jwweight":"'
											+ jwweight + '"';
											
											str += ',"details[' + i
													+ '].xiangqing":"'
													+ cxiangqing + '"';
											
											str += ',"details[' + i
											+ '].brands":"'
											+ commodifybrands + '"';
											
											str += ',"details[' + i
													+ '].transhipmentId":"'
													+ transhipmentId + '"';
											i = i + 1;
										});
//alert(str);
						var obj = $.parseJSON("{" + str + "}");
						if (!validate) {
							alert("红色框中的信息必须正确填写，才可以提交！");
							return false;
						}
						
						var totalmoney=$(":text[name='totalmoney']").val();
						var totalp = parseFloat(totalmoney);
						if (totalp == "NaN") {
						alert("总价格式有误!");
						return false;
						}
						else
						{
							if(totalp<0)
							{
								alert("总价钱不能小于0!");
								return false;
							}
						}
						
						// kai 20150912
						var strurl = "";
						// alert($("#curstateid").html());
						if ($("#curstateid").html() == -10) {
							strurl = "../admin/order/modifyonline";
						} else {
							strurl = admin_order_modify_url;
						}

						$.ajax({

							type : "post",
							url : strurl,
							data : $.param(obj, true),
							success : function(response) {
								var code = response.code;
								if ("200" == code) {
									// alert("修改成功");
									if ((pay_flag == "yes"))// 修改参数成功，开始付款
									{
										alert("修改成功,等待付款");
										var url = admin_msg_order_pay_page_url
												+ "?id=" + order_Id + "&oid="
												+ orderId;
										$("#main-content").load(url);
									} else {
										alert("修改成功");
										nav52Click();
									}
								} else if ("607" == code) {
									alert("您尚未登录或登录已失效！");
									logout();
								} else {
									alert("修改运单失败，原因是:" + response.message);
								}
								return false;
							}
						});
						return false;
					});

}


function countpremiummoney_modifyorder()
{
	var rate=$(":hidden[name='premiumratevalue']").val();
	if((rate=="0")||(rate==null))
	{
		return false;
	}
	var rate = parseFloat(rate);
	if (isNaN(rate))
	{
		return false;
	}
	var premium=parseFloat(rate*parseFloat($(":text[name='premiumtotal']").val()));
	if (isNaN(premium))
	{
		return false;
	}
	$(":text[name='premium']").val(premium);
	orderModifyCalcFreight();
}

function showOrderTranshipmentInfo(list) {
	var str = "";
	var i = 1;
	$.each(list, function() {
		var pm = "";
		$.each(this.commoditys, function() {
			pm += this.commodityName + ":" + this.xiangqing + ":"
					+ this.quantity + ";";
		});
		str += '<p><label>预报单号' + '：' + this.id + '</label>' + '<label>对应运单个数：'
				+ this.unpackingNumber + '</label>' + '<label>转运单商品信息：' + pm
				+ '</label>' + '<label>备注信息：' + this.remark
				+ '</label></p><hr/>';
		i = i + 1;
	});
	$("#tranship_info").html(str);
}
//kai 20150912 添加照片显示功能
function showOrderInfo(order) {
	// alert("showOrderInfo");
	
	
	
	
	
	var str = "";
	if((order.user!=null)&&(order.user!="null")&&(order.user!="")&&(order.user!="undefined"))
	{
	str += order.user.id + "&nbsp;/&nbsp;" + order.user.nickName
			+ "&nbsp;/&nbsp;" + order.user.realName + "&nbsp;/&nbsp;"
			+ order.user.phone;
	$("#from_user_info").html(str);
	}
	else
	{
		str += order.senduserName + "&nbsp;/&nbsp;" + order.senduserphone;
		$("#from_user_info").html(str);
	}
	
	
	
	
	
	
	
	if (order.premium != null) {
		str = order.premium;
	} else {
		str = "0";
	}
	if(str!="0")
	{
		var rate=$(":hidden[name='premiumratevalue']").val();
		if((rate=="0")||(rate==null))
		{
			rate="0";
		}
		var rate = parseFloat(rate);
		if (isNaN(rate)||(rate=="0")||(rate==0))
		{
			
		}
		else
		{
			var totalpremium=parseFloat(parseFloat(str)/rate);
			if (isNaN(totalpremium))
			{
				
			}
			else
			{
				$(":text[name='premiumtotal']").val(totalpremium);
			}
		}
	}
	$("#premium_info").html(str);
	$(":hidden[name='premium']").val(str);
	$(":text[name='premium']").val(str);
	str = "";
	
	if(order.type=="7")
	{
		$("#order_type_t").html(" 第三方运单");
		$("#commodity_lists_show").attr("style","display:none");
		$("#showallpic").attr("style","display:none");
		
		
		$("textarea[name='third_commidtylist']").val(order.commodityThirdList);
		$("textarea[name='third_brands']").val(order.thirdBrands);
		$("#third_commiditylist_show").attr("style","");
		
		$("#show_third_otherinfo").attr("style","");
		
		$(":text[name='thirdCreateDate']").val(order.thirdCreateDate);
		$(":text[name='flight']").val(order.flight);
		$(":text[name='boxNo']").val(order.boxNo);
		$(":text[name='payOrNot']").val(order.payOrNot);
		$(":text[name='baseMoney']").val(order.baseMoney);
		$(":text[name='expressName']").val(order.expressName);
		$(":text[name='cardOrNot']").val(order.cardOrNot);
		
		
		$(":text[name='t_s_address']").val(order.senduserAddress);
		$(":text[name='t_s_city']").val(order.senduserCity);
		$(":text[name='t_s_state']").val(order.senduserState);
		$(":text[name='t_s_zipcode']").val(order.senduserZipcode);
		
		$("textarea[name='importRemark']").val(order.importRemark);
		
		
	}
	else
	{
		$("#order_type_t").html(" 系统运单");
	}
	
	
	//判断隐藏运单 kai 20151004 
	
	if((order.state=="2")&&(order.tranPro=="0"))
	{
		
		$("#state_label").attr("style","display:none");
		$("#state_id").attr("style","display:none");
		$("#tran_progress_s").attr("style","");
		$("#tran_progress").attr("style","");
		
		$(":hidden[name='tran_no_flag']").val("yes");//设置为运单修改状态
		//alert("yes");
	}

	if (order.type != null) {
		$(":hidden[name='type']").val(order.type);
	}
	if ((order.user!=null)&&(order.user.type != null)) {
		$(":hidden[name='userType']").val(order.user.type);
	}
	$("select[name='wid']").hide();
	$("#span_wid").hide();

	if (order.warehouseId != null) {
		$("select[name='wid']").html(
				"<option value=" + order.warehouseId + ">本门店</option>");
		showChannelTableInOM(order.channelId, order.details);
	} else { // 网上置件

		loadWarehouseInOM();
	}

	
	
	// showCommodityTable(order.details);

	$("#order_id").html(order.orderId);
	$(":text[name='orderidname']").val(order.orderId);

	$(":text[name='ordername_id']").val(order.id);// kai 20150515 存储订单的id

	$("select[name='mail'] option[value='" + order.mail + "']").attr(
			"selected", true);
	$("select[name='state'] option[value='" + order.state + "']").attr(
			"selected", true);
	$(":text[name='totalmoney']").val(order.totalMoney);
	$(":text[name='cName']").val(order.cName);
	$(":text[name='cCity']").val(order.cCity);
	$(":text[name='cDistrict']").val(order.cDistrict);
	$(":text[name='cProvince']").val(order.cProvince);
	$(":text[name='cStreetAddress']").val(order.cStreetAddress);
	$(":text[name='cZipCode']").val(order.cZipCode);
	$(":text[name='cPhone']").val(order.cPhone);
	$("textarea[name='remark']").val(order.remark);
	if (order.weight != null) {
		$(":text[name='weight']").val(order.weight);
	}
	if (order.jwweight != null) {
		$(":text[name='sum_weight']").val(order.jwweight);
	}

	if (order.weightKg != null) {
		$(":text[name='weightKg']").val(order.weightKg);
	}

	if (order.tariff != null) {
		$(":text[name='tariff']").val(order.tariff);
	}
	if (order.or != null) {
		$(":text[name='or']").val(order.or);
	}
	if (order.other != null) {
		$(":text[name='other']").val(order.other);
	}

	if (order.length != null) {
		$(":text[name='length']").val(order.length);
	}
	if (order.width != null) {
		$(":text[name='width']").val(order.width);
	}
	if (order.length != null) {
		$(":text[name='height']").val(order.height);
	}
	if (order.parceValue != null) {
		$(":text[name='parceValue']").val(order.parceValue);
	}

	$("a[name='a_delete_commodity']").click(function() {
		if ($("a[name='a_delete_commodity']").length > 1)
			$(this).parent().parent().remove();
		return false;
	});

	$(":text[name='cardidname']").val(order.cardid);
	var cardurl1 = order.cardurl;
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicid").attr("style", "display:block;");
		$(":text[name='idurlcard']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlid").attr("href", cardurl1);
		$("#imacardurlid img").attr("src", cardurl1);

	} else {
		$("#showcardpicid").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	var cardurl1 = order.cardurlother;
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicidother").attr("style", "display:block;");
		$(":text[name='idurlcardother']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlidother").attr("href", cardurl1);
		$("#imacardurlidother img").attr("src", cardurl1);

	} else {
		$("#showcardpicidother").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	var cardurl1 = order.cardurltogether;
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicidtogether").attr("style", "display:block;");
		$(":text[name='idurlcardtogether']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlidtogether").attr("href", cardurl1);
		$("#imacardurlidtogether img").attr("src", cardurl1);

	} else {
		$("#showcardpicidtogether").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	$(":file[name='file']").val("");// 清空原来选择过上传的图片

	// 当上传图片时，用于实时隐藏原地址薄中的图片
	$("#cardpicid").on("change", function() {
		var picValue = $(":file[name='file']").val();
		if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
			modifyonlineorderhavepicurl();
		}

	});
	// 当上传图片时，用于实时隐藏原地址薄中的图片
	$("#cardpicidother").on("change", function() {
		var picValue = $(":file[name='fileother']").val();
		if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
			modifyonlineorderhavepicurl();
		}

	});

}

// kai 20150911-1 modify
// js获取项目根路径，如： http://localhost:8083/uimcardprj
base_url_set_has_sub = false;
function getRootPath() {
	// 获取当前网址，如： http://localhost:8083/uimcardprj/share/meun.jsp
	var curWwwPath = window.document.location.href;
	// 获取主机地址之后的目录，如： uimcardprj/share/meun.jsp
	var pathName = window.document.location.pathname;
	var pos = curWwwPath.indexOf(pathName);
	// 获取主机地址，如： http://localhost:8083
	var localhostPaht = curWwwPath.substring(0, pos);
	// 获取带"/"的项目名，如：/uimcardprj
	var projectName = pathName
			.substring(0, pathName.substr(1).indexOf('/') + 1);
	
	if(base_url_set_has_sub==true)
	{
		return (localhostPaht + projectName);
	}
	else
	{
		return localhostPaht;
	}
}
//kai 20150911-1 modify
function showOrderInfo_wsjd(order) {

	var str = "";
	if((order.user!=null)&&(order.user!="null")&&(order.user!="")&&(order.user!="undefined"))
	{
	str += order.user.id + "&nbsp;/&nbsp;" + order.user.nickName
			+ "&nbsp;/&nbsp;" + order.user.realName + "&nbsp;/&nbsp;"
			+ order.user.phone;
	$("#from_user_info").html(str);
	}
	else
	{
		str += order.senduserName + "&nbsp;/&nbsp;" + order.senduserphone;
		$("#from_user_info").html(str);
	}
	if (order.premium != null) {
		str = order.premium;
	} else {
		str = "0";
	}
	$("#premium_info").html(str);

	$(":hidden[name='premium']").val(str);
	$(":text[name='premium']").val(str);
	str = "";

	if (order.type != null) {
		$(":hidden[name='type']").val(order.type);
	}
	if ((order.user!=null)&&(order.user.type != null)) {
		$(":hidden[name='userType']").val(order.user.type);
	}

	if (order.warehouseId != null) {
		/*
		 * $("select[name='wid']").html( "<option value=" + order.warehouseId +
		 * ">本门店</option>");
		 */

		loadconinfo_wsjd1(order.warehouseId, order.channelId, order.details);
		// showChannelTableInOM(order.channelId, order.details);
	} else { // 网上置件

		loadWarehouseInOM();
	}

	// showCommodityTable(order.details);
	// loadconinfo_wsjd();

	$("#order_id").html(order.orderId);
	$(":text[name='orderidname']").val(order.orderId);
	$(":text[name='ordername_id']").val(order.id);// kai 20150515 存储订单的id
	$("select[name='mail'] option[value='" + order.mail + "']").attr(
			"selected", true);
	$("select[name='state'] option[value='" + order.state + "']").attr(
			"selected", true);
	$(":text[name='totalmoney']").val(order.totalMoney);
	$(":text[name='cName']").val(order.cName);
	$(":text[name='cCity']").val(order.cCity);
	$(":text[name='cDistrict']").val(order.cDistrict);
	$(":text[name='cProvince']").val(order.cProvince);
	$(":text[name='cStreetAddress']").val(order.cStreetAddress);
	$(":text[name='cZipCode']").val(order.cZipCode);
	$(":text[name='cPhone']").val(order.cPhone);
	$("textarea[name='remark']").val(order.remark);
	if (order.weight != null) {
		$(":text[name='weight']").val(order.weight);
	}
	if (order.jwweight != null) {
		$(":text[name='sum_weight']").val(order.jwweight);
	}

	if (order.weightKg != null) {
		$(":text[name='weightKg']").val(order.weightKg);
	}

	if (order.tariff != null) {
		$(":text[name='tariff']").val(order.tariff);
	}
	if (order.or != null) {
		$(":text[name='or']").val(order.or);
	}
	if (order.other != null) {
		$(":text[name='other']").val(order.other);
	}

	if (order.length != null) {
		$(":text[name='length']").val(order.length);
	}
	if (order.width != null) {
		$(":text[name='width']").val(order.width);
	}
	if (order.length != null) {
		$(":text[name='height']").val(order.height);
	}
	if (order.parceValue != null) {
		$(":text[name='parceValue']").val(order.parceValue);
	}

	$("a[name='a_delete_commodity']").click(function() {
		if ($("a[name='a_delete_commodity']").length > 1)
			$(this).parent().parent().remove();
		return false;
	});
	$(":text[name='cardidname']").val(order.cardid);
	var cardurl1 = order.cardurl;
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicid").attr("style", "display:block;");
		$(":text[name='idurlcard']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlid").attr("href", cardurl1);
		$("#imacardurlid img").attr("src", cardurl1);

	} else {
		$("#showcardpicid").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	// 反面图片处理
	var cardurl1 = order.cardurlother;
	// alert(cardurl1);
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicidother").attr("style", "display:block;");
		$(":text[name='idurlcardother']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlidother").attr("href", cardurl1);
		$("#imacardurlidother img").attr("src", cardurl1);

	} else {
		$("#showcardpicid").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	// 合成图片处理
	var cardurl1 = order.cardurltogether;
	if ((cardurl1 != "") && (cardurl1 != "null"))// 地址中包含有身份证图片，显示出来
	{
		// alert(cardurl1);
		$("#showcardpicidtogether").attr("style", "display:block;");
		$(":text[name='idurlcardtogether']").val(cardurl1);
		cardurl1 = getRootPath() + cardurl1;
		$("#imacardurlidtogether").attr("href", cardurl1);
		$("#imacardurlidtogether img").attr("src", cardurl1);

	} else {
		$("#showcardpicidtogether").attr("style", "display:none");

		// $(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
	}

	$(":file[name='file']").val("");// 清空原来选择过上传的图片
	$(":file[name='fileother']").val("");// 清空原来选择过上传的图片

	// 当上传图片时，用于实时隐藏原地址薄中的图片
	$("#cardpicid").on("change", function() {
		var picValue = $(":file[name='file']").val();
		if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
			modifyonlineorderhavepicurl();
		} else {
			/*
			 * var url2=$(":text[name='idurlcard']").val();
			 * 
			 * //alert(url2); if((url2!=null)&&(url2!="")&&(url2!="null")) {
			 * $("#showcardpicid").attr("style", "display:block;"); var cardurl1 =
			 * getRootPath() + url2;
			 * 
			 * $("#imacardurlid").attr("href", cardurl1); $("#imacardurlid
			 * img").attr("src", cardurl1);
			 *  }
			 */
		}

	});

	// 当上传图片时，用于实时隐藏原地址薄中的图片
	$("#cardpicidother").on("change", function() {
		var picValue = $(":file[name='fileother']").val();
		if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
			modifyonlineorderhavepicurl();
		} else {
			/*
			 * var url2=$(":text[name='idurlcard']").val();
			 * 
			 * //alert(url2); if((url2!=null)&&(url2!="")&&(url2!="null")) {
			 * $("#showcardpicid").attr("style", "display:block;"); var cardurl1 =
			 * getRootPath() + url2;
			 * 
			 * $("#imacardurlid").attr("href", cardurl1); $("#imacardurlid
			 * img").attr("src", cardurl1);
			 *  }
			 */
		}

	});

}

// kai 20150912 //装载仓库及相关联的数据
function loadconinfo_wsjd1(wid, channelId, order) {
	$
			.ajax({
				type : "get",
				async : true,
				// url:"../user/warehouse/all",
				url : "../warehouse/all",
				success : function(response) {
					var code = response.code;
					// alert(code);
					if (code == '200') {
						if (response.data != null) {
							var str = "";

							$.each(response.data, function() {
								str += "<option value='" + this.id + "'>"
										+ this.name + "</option>";
							});
							// alert(str);
							$("select[name='wid']").html(str);
							$("select[name='wid']").val(wid);
							// showChannelTable_wsjd();
							// showChannelTableInOM(channelId,order);
							showChannelTableInOM_wsjd1(channelId, order);
							// showChannelTableInTM();

							$("select[name='wid']").change(
									showChannelTableInOM_change);
							// loadCommoditySelectOption1();
						}
					}
				}
			});
}

// kai 20150911-1
function modifyonlineorderhavepicurl() {
	// alert("开始提交有图片订单,只要是指在线下单部分的订单");
	// alert("555555");
	$("#modify_online_order_pic").ajaxSubmit({
		type : "post",
		// url : "../consignee/add",//admin/consignee/add
		// url : "consignee/add",
		// url : "../admin/msjorder_pic/submit",
		url : "../admin/order/online_pic_modify_url",
		success : function(data) {
			// alert(data);
			$("#tmpmsgdiv2").html(data);
			var str = $("#tmpmsgdiv2 pre").html();

			var obj = $.parseJSON(str);

			var code = obj.code;

			if (code == "200") {
				// alert("提交成功");
				// window.close();
				alert("图片更新成功,刷新后即可观看效果!");

				$("#showcardpicid").attr("style", "display:none");
				//$(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
				$("#showcardpicidother").attr("style", "display:none");
				//$(":text[name='idurlcardother']").val("");// 已经重新上传，清空原有的图片
				$("#showcardpicidtogether").attr("style", "display:none");
				//$(":text[name='idurlcardtogether']").val("");// 已经重新上传，清空原有的图片

				// $("#imacardurlid").attr("href",$("#cardpicid").val());
				// $("#imacardurlid
				// img").attr("src",$("#cardpicid").val());

			} else if (code == "607") {
				alert("您尚未登录或登录已失效！");
				$(":text[name='cardpicid']").val("");// 已经重新上传，清空原有的图片
				logout();
			} else {
				alert("提交网上置件信息失败，原因是:" + response.message);
				$(":text[name='cardpicid']").val("");// 已经重新上传，清空原有的图片
			}
			return false;
		},
		error : function(XmlHttpRequest, textStatus, errorThrown) {
			alert("操作失败");
			$(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
			return false;
		}
	});
}

function loadWarehouseInOM() {
	$.ajax({
		type : "get",
		url : admin_get_emp_self,
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				$("select[name='wid']").html(
						"<option value=" + response.data.storeId
								+ ">本门店</option>");
				showChannelTableInOM(null, null);
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				// 失败
				// alert("获取仓库数据失败，原因是:" + response.message);
			}
		}
	});
}

// kai 20150911-1
function loadWarehouseInOM_wsjd() {
	$.ajax({
		type : "get",
		url : admin_get_emp_self,
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				$("select[name='wid']").html(
						"<option value=" + response.data.storeId
								+ ">本门店</option>");
				showChannelTableInOM(null, null);
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				// 失败
				// alert("获取仓库数据失败，原因是:" + response.message);
			}
		}
	});

	$.ajax({
		type : "get",
		async : true,
		url : "../user/warehouse/all",
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					var str = "";
					$.each(response.data, function() {
						str += "<option value='" + this.id + "'>" + this.name
								+ "</option>";
					});
					$("select[name='wid']").html(str);

					showChannelTableInOM_wsjd();

					// showChannelTableInTM();

					$("select[name='wid']").change(showChannelTableInOM_wsjd);
					// loadCommoditySelectOption1();
				}
			}
		}
	});
}

// kai 20150912 去掉“请选择渠道”字样
function showChannelTableInOM(channelId, details) {
	var wid = $("select[name='wid']").val();
	$("select[name='cid']").html("");
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '" additiveprice="'+this.additivePrice+'">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					// alert(channelId);
					if (channelId == null) {

					} else {
						$("select[name='cid']").val(channelId);
						showCommodityTable(details);
					}
					$("select[name='cid']").change(showCommodityTableInOM);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

function showChannelTableInOM_wsjd1(channelId, details) {
	// alert(channelId);
	var wid = $("select[name='wid']").val();
	$("select[name='cid']").html("");
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '" additiveprice="'+this.additivePrice+'">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					if (channelId == null) {

					} else {
						$("select[name='cid']").val(channelId);
						showCommodityTable(details);
					}
					$("select[name='cid']").change(showCommodityTableInOM);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

// kai 20150912 当门店改变时的操作
function showChannelTableInOM_change() {
	var wid = $("select[name='wid']").val();
	$("select[name='cid']").html("");
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '" additiveprice="'+this.additivePrice+'">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);

					showCommodityTable_change();
					$("select[name='cid']").change(showCommodityTable_change);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}
// kai 20150911 modify
function showChannelTableInOM_wsjd(channelId, details) {
	var wid = $("select[name='wid']").val();
	$("select[name='cid']").html("<option >请选择渠道</option>");
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					var str = "<option>请选择渠道</option>";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '" additiveprice="'+this.additivePrice+'">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					if (channelId == null) {

					} else {
						$("select[name='cid']").val(channelId);
						showCommodityTable(details);
					}
					$("select[name='cid']").change(showCommodityTableInOM);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

// kai 20150911 当门店发生改变时，更出商品类型
function showCommodityTable_change() {
	$("#commodity_list_table tbody").html("");
	var wid = $("select[name='wid']").val();
	var cid = $("select[name='cid']").val();
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	
	$
			.ajax({
				post : "get",
				url : admin_commodity_list_url,
				data : {
					"wid" : wid,
					"cid" : cid
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						var str_option = "";
						var flag = 0;
						$.each(response.data, function() {
							if (flag == 0) {
								flag = this.id;
							}
							flag = flag + 1;
							str_option += "<option value='" + this.id
									+ "'  price='" + this.price + "' msPrice='"
									+ this.msPrice + "' vipOnePrice='"
									+ this.vipOnePrice + "' vipTwoPrice='"
									+ this.vipTwoPrice + "' vipThreePrice='"
									+ this.vipThreePrice + "'>" + this.name
									+ "</option>";
						});

						var str = "";

						str += '<tr name="' + flag + '"><td>';
						str += '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight()">'
								+ str_option + '</select>';
						str += '</td>';
						str += '<td><input name="commodifyxiangqing" class="text-input" style="width:140px" type="text" value="'
								+ "" + '"/></td>';
						str+='<td><input type="text" class="text-input" name="commodifybrands" placeholder="填写具体物品牌" style="width:140px"></td>';
						
						str += '<td><input name="quantity" class="text-input" size="3" type="text" value="'
								+ "" + '"/></td>';
						
						str += '<td><input name="jwweight" class="text-input" size="3" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
						str += '<td><input name="sjweight" class="text-input" size="5" readonly="readonly" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
						
					//	str += '<td><input name="sjweight" class="text-input" size="5" type="text" onchange="orderModifyCalcFreight()" value="'
					//			+ "" + '"/></td>';
						// str += '<td><input
						// name="jfweight"
						// class="text-input" size="5"
						// type="text" placeholder="不能为空"
						// value="' + this.jfweight +
						// '"/></td>';
						str += '<input name="transhipmentId" type="hidden" value="'
								+ "" + '"/>';
						str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';

						$("#commodity_list_table tbody").html(str);

						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1)
								$(this).parent().parent().remove();
							orderModifyCalcFreight();
							return false;
						});

						$(
								"tr[name='" + flag + "'] select option[value='"
										+ flag + "']").attr("selected", true);

					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					}
				}
			});
}

function showCommodityTableInOM() {
	$("#commodity_list_table tbody").html("");
	var wid = $("select[name='wid']").val();
	var cid = $("select[name='cid']").val();
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$
			.ajax({
				post : "get",
				url : admin_commodity_list_url,
				data : {
					"wid" : wid,
					"cid" : cid
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						if (response.data == null) {
							$("#commodity_list_table tbody")
									.html(
											"<tr><td colspan='5'>您的运单中，有该渠道禁运商品类别，请选择其他渠道！</td></tr>");
							return;
						}
						var str_option = "";
						$.each(response.data, function() {
							str_option += "<option value='" + this.id
									+ "'  price='" + this.price + "' msPrice='"
									+ this.msPrice + "' vipOnePrice='"
									+ this.vipOnePrice + "' vipTwoPrice='"
									+ this.vipTwoPrice + "' vipThreePrice='"
									+ this.vipThreePrice + "'>" + this.name
									+ "</option>";
						});
						var str = "";
						// $.each(details,function(){
						str += '<tr><td>';
						str += '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight()">'
								+ str_option + '</select>';
						str += '</td>';
						str += '<td><input name="commodifyxiangqing" class="text-input" style="width:140px" type="text" value=""/></td>';
						str+='<td><input type="text" class="text-input" name="commodifybrands" placeholder="填写具体物品牌" style="width:140px"></td>';
						str += '<td><input name="quantity" class="text-input" size="3" type="text" value=""/></td>';
						
						str += '<td><input name="jwweight" class="text-input" size="3" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
						str += '<td><input name="sjweight" class="text-input" size="5" readonly="readonly" type="text" onchange="orderModifyCalcFreight()" value="0"/></td>';
					
						//str += '<td><input name="sjweight" class="text-input" size="5" type="text" value="" onchange="orderModifyCalcFreight();"/></td>';
						str += '<input name="transhipmentId" type="hidden" value="-1"/>';
						str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
						// });
						$("#commodity_list_table tbody").html(str);

						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1)
								$(this).parent().parent().remove();
							orderModifyCalcFreight();
							return false;
						});
						orderModifyCalcFreight();
						$.each(details, function() {
							$(
									"tr[name='" + this.commodityId
											+ "'] select option[value='"
											+ this.commodityId + "']").attr(
									"selected", true);
						});

					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					}
				}
			});
}

function showCommodityTable(details) {
	$("#commodity_list_table tbody").html("");
	var wid = $("select[name='wid']").val();
	var cid = $("select[name='cid']").val();
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$
			.ajax({
				post : "get",
				url : admin_commodity_list_url,
				data : {
					"wid" : wid,
					"cid" : cid
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						var str_option = "";
						$.each(response.data, function() {
							str_option += "<option value='" + this.id
									+ "'  price='" + this.price + "' msPrice='"
									+ this.msPrice + "' vipOnePrice='"
									+ this.vipOnePrice + "' vipTwoPrice='"
									+ this.vipTwoPrice + "' vipThreePrice='"
									+ this.vipThreePrice + "'>" + this.name
									+ "</option>";
						});
						var str = "";
						$
								.each(
										details,
										function() {
											
											
											if ((this.sjweight == null)
													|| this.sjweight == "null") {
												this.sjweight = 0;
											}

											if ((this.xiangqing == null)
													|| this.xiangqing == "null") {
												this.xiangqing = "";
											}
											
											str += '<tr name="'
													+ this.commodityId
													+ '"><td>';
											str += '<select style="width:100px" name="commodityId" onChange="orderModifyCalcFreight()">'
													+ str_option + '</select>';
											str += '</td>';
											str += '<td><input name="commodifyxiangqing" class="text-input" style="width:140px" type="text" value="'
													+ this.xiangqing
													+ '"/></td>';
											str += '<td><input name="commodifybrands" class="text-input" style="width:140px" type="text" value="'
												+ this.brands
												+ '"/></td>';																						
											
											str += '<td><input name="quantity" class="text-input" size="3" type="text" value="'
													+ this.quantity
													+ '"/></td>';
											str += '<td><input name="jwweight" class="text-input" size="5" type="text" onchange="orderModifyCalcFreight()" value="'
												+ this.jwweight
												+ '"/></td>';
											str += '<td><input name="sjweight" class="text-input" size="5" readonly="readonly" type="text" onchange="orderModifyCalcFreight()" value="'
													+ this.sjweight
													+ '"/></td>';
											// str += '<td><input
											// name="jfweight"
											// class="text-input" size="5"
											// type="text" placeholder="不能为空"
											// value="' + this.jfweight +
											// '"/></td>';
											str += '<input name="transhipmentId" type="hidden" value="'
													+ this.transhipmentId
													+ '"/>';
											str += '<td><a href="#" name="a_delete_commodity">删除</a></td></tr>';
										});
						$("#commodity_list_table tbody").html(str);

						$("a[name='a_delete_commodity']").click(function() {
							if ($("a[name='a_delete_commodity']").length > 1)
								$(this).parent().parent().remove();
							orderModifyCalcFreight();
							return false;
						});

						$.each(details, function() {
							$(
									"tr[name='" + this.commodityId
											+ "'] select option[value='"
											+ this.commodityId + "']").attr(
									"selected", true);
						});
					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					}
				}
			});
}

function afterLoadOneOrderInfo() {
	$('select[name="commodityId"]').each(
			function() {
				var commodityId = $(this).parent().parent().attr("name");
				$(this).children("option[value='" + commodityId + "']").attr(
						"selected", true);
			});

}

// ////////////////////////////////////////////////////
function loadNav53Data() {
	loadWarehouseListFirst();

	$("#a_add_warehouse_link").click(function() {
		$("#main-content").load(admin_warehouse_add_page_url);
		return false;
	});

	$("#a_delete_warehouse_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的仓库！");
		} else {
			if (confirm("您是否确认要删除仓库信息?")) {
				$.ajax({
					type : "post",
					url : admin_warehouse_delete_url,
					data : $.param({
						"id" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							// $("#nav53").click();
							nav53Click();
						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除仓库失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#w_del_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});
}

function loadWarehouseListFirst() {
	loadWarehouseList(1);
}

function loadWarehouseList(pn) {
	$.ajax({
		type : "get",
		url : admin_warehouse_list_url,
		data : {
			"pageIndex" : pn
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					showWarehouseList(null);
					showWarehouseLink(null);
				} else {
					showWarehouseList(response.data.datas);
					showWarehouseLink(response.data);
				}
				afterLoadWarehouseList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='12'>"
						+ "<span>&nbsp;&nbsp;获取仓库列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
		}
	});
}

function showWarehouseList(list) {
	var str = "";
	if (list != null) {
		$
				.each(
						list,
						function() {
							str += '<tr id="' + this.id + '">';
							str += '<td><input type="checkbox" name="del_id" value="'
									+ this.id + '"/></td>';
							str += '<td>' + this.id + '</td>';
							str += '<td>' + this.serialNo + '</td>';
							str += '<td title=' + this.name + '>' + this.name
									+ '</td>';
							str += '<td title=' + this.address + '>'
									+ this.address + '</td>';
							str += '<td>' + this.contactName + '</td>';
							str += '<td>' + this.telephone + '</td>';
							str += '<td>' + this.country + '</td>';
							str += '<td>' + this.province + '</td>';
							str += '<td title="' + this.city + '">' + this.city
									+ '</td>';
							str += '<td>' + this.zipCode + '</td>';
							if(this.type=="1")
							{
								str += '<td>' + '<span style="color:blue;">是</span>' + '</td>';
							}
							else
							{
								str += '<td>' + '否' + '</td>';
							}
							str += '<td><a href="#" name="a_warehouse_modify_link">修改</a></td></tr>';
						});
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='12'>"
					+ "<span>&nbsp;&nbsp;对不起，现在没有仓库信息或者是没有符合您查找要求的仓库!</span></td>";
		}
	}
	$("#tab1 table tbody").html(str);
}

function showWarehouseLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			loadWarehouseList(pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					loadWarehouseList(pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadWarehouseList() {
	$("a[name='a_warehouse_modify_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		var url = admin_modify_warehouse_page_url + "?id=" + id;
		$("#main-content").load(url);
		return false;
	});
}
// ////////////////////////////////////////////////////////
function loadNav531Data() {
	$("#a_back_warehouse_list_link").click(function() {
		/*
		 * if (!$("#nav2").hasClass("current")) { $("#nav2").click(); }
		 */
		// $("#nav53").click();
		nav53Click();
		return false;
	});

	$("#bt_add_warehouse").click(function() {
		saveWarehouse();

		return false;
	});
}
/*
 * kai 20151014 modify
 * 添加打印信息
 * */
function saveWarehouse() {
	var param1 = $(":text[name='name']").val();
	var param2 = $(":text[name='company']").val();
	var param3 = $(":text[name='country']").val();
	var param4 = $(":text[name='province']").val();
	var param5 = $(":text[name='city']").val();
	var param6 = $(":text[name='address']").val();
	var param7 = $(":text[name='zipCode']").val();
	var param8 = $(":text[name='serialNo']").val();
	var param9 = $(":text[name='contactName']").val();
	var param10 = $(":text[name='telephone']").val();
	var param11 = $("textarea[name='remark']").val();
	
	var printUrl=$(":text[name='printwidurl']").val();
	var printWidCode=$(":text[name='wid_code_char2']").val();
	
	var param12 = $(":text[name='telephoneofcn']").val();
	var param13 = $(":text[name='telephoneofusa']").val();
	var callOrderAvailable = 0;
	if($("#callOrderAvailable").attr("checked")=="checked"){
		callOrderAvailable = 1;
	}
	var callOrderCity = $("textarea[name='callOrderCity']").val();
	var widtype = 0;
	if(document.getElementById("wid_type").checked==true)
	{
		widtype=1;
	}

	$(":hidden[name='widtype1']").val(widtype);
	$(":hidden[name='callOrderAvailable1']").val(callOrderAvailable);
	if (!checkWarehouseName(param1)) {
		alert("仓库名称格式不对，仓库名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseCompany(param2)) {
		alert("所属公司格式不对，公司名称最大长度为40个字符，请重新输入！");
	} else if (!checkWarehouseCountry(param3)) {
		alert("国家格式不对，国家名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseProvince(param4)) {
		alert("州格式不对，州名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseCity(param5)) {
		alert("市格式不对，市名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseAddress(param6)) {
		alert("街道地址格式不对，地址信息必须由1到100个字符组成，请重新输入！");
	} else if (!checkWarehouseZipCode(param7)) {
		alert("邮编格式不对，邮编地址必须由2到20个字符组成，请重新输入！");
	} else if (!checkWarehouseSerialNo(param8)) {
		alert("仓库排序号格式不对，仓库排序号必须是数字，请重新输入！");
	} else if (!checkWarehouseContactName(param9)) {
		alert("联系人姓名格式不对，联系人姓名最长长度为20个字符，请重新输入！");
	} else if (!checkWarehouseTelephone(param10)) {
		alert("联系人电话格式不对，联系人电话号码最长长度为20个字符，请重新输入！");
	} else if (!checkWarehouseRemark(param11)) {
		alert("备注信息格式不对，备注信息最长为200个字符，请重新输入！");
	} else {
		
		//判断是否包含上传图片
		var param14 = $(":file[name='file']").val();
		var logo = $(":file[name='filelogo']").val();
		//alert(param14);
		if ((param14 != null && param14 != '')||(logo != null && logo != ''))
		{
			saveWarehousehavepic();//有图片，要单独提交
			return false;
		}
		else
		{
			param14="";
		}
		
		
		$.ajax({
			type : "post",
			url : admin_warehouse_add_url,
			data : {
				name : param1,
				company : param2,
				country : param3,
				province : param4,
				city : param5,
				address : param6,
				zipCode : param7,
				serialNo : param8,
				contactName : param9,
				telephone : param10,
				remark : param11,
				printPhoneCN : param12,
				printPhoneUSA : param13,
				print2Code : param14,
				type : widtype,
				callOrderAvailable : callOrderAvailable,
				callOrderCity : callOrderCity,
				printUrl:printUrl,
				printWidCode:printWidCode
			},
			success : function(response) {
				var code = response.code;
				if (code == "200") {
					alert("添加成功");
					$(":reset").click();
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("添加失败，失败原因是:" + response.message);
				}
			}
		});
	}
	return false;
}


function saveWarehousehavepic() {
	$("#add_form_warehose").ajaxSubmit(
			{
				type : "post",
				url : admin_warehouse_addhavepic_url,
				success : function(data) {
					// alert(data);
					$("#tmpmsgdiv1").html(data);
					var str = $("#tmpmsgdiv1 pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					if (code == "200") {
						alert("添加成功");
						$(":reset").click();
					} else if (code == "607") {
						alert("重新过期，请重新登录");
						window.location.href = "login.jsp";
					} else {
						alert("添加失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("操作失败");
					return false;
				}
			});
}


function loadNav532Data() {
	$("#a_back_warehouse_list_link").click(function() {
		/*
		 * if (!$("#nav2").hasClass("current")) { $("#nav2").click(); }
		 */
		// $("#nav53").click();
		nav53Click();
		return false;
	});

	

	
	$.ajax({
		type : "get",
		url : admin_warehouse_get_one_url,
		data : {
			id : $("#modify_warehouse :hidden[name='id']").val()
		},
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				var date = response.data;
				$(":text[name='name']").val(date.name);
				$(":text[name='company']").val(date.company);
				$(":text[name='country']").val(date.country);
				$(":text[name='province']").val(date.province);
				$(":text[name='city']").val(date.city);
				$(":text[name='address']").val(date.address);
				$(":text[name='zipCode']").val(date.zipCode);
				$(":text[name='serialNo']").val(date.serialNo);
				$(":text[name='contactName']").val(date.contactName);
				$(":text[name='telephone']").val(date.telephone);
				$("textarea[name='remark']").val(date.remark);
				$(":text[name='telephoneofusa']").val(date.printPhoneUSA);
				$(":text[name='telephoneofcn']").val(date.printPhoneCN);
				
				
				$(":text[name='wid_code_char2']").val(date.printWidCode);
				$(":text[name='printwidurl']").val(date.printUrl);
				
				if(date.callOrderAvailable=="1"){
					$("#callOrderAvailable").attr("checked", true);
				}
				$("textarea[name='callOrderCity']").val(date.callOrderCity);
				
				if(date.type=="1")
				{
					document.getElementById("wid_type").checked=true;
				}
				else
				{
					document.getElementById("wid_type").checked=false;
				}
				if((date.print2Code=="")||(date.print2Code=="null")||(date.print2Code==null)||(date.print2Code=="undefined"))
				{
					$("#showpiccontent").hide();
					
				}
				else
				{
					$(":text[name='print2codepic']").val(date.print2Code);
					var cardurl1=date.print2Code;
					$("#showpiccontent").show();
					 cardurl1 = getRootPath() + cardurl1;
					$("#imgurllink").attr("href", cardurl1);
					$("#imgurllink img").attr("src", cardurl1);
				}
				if((date.printLogo=="")||(date.printLogo=="null")||(date.printLogo==null)||(date.printLogo=="undefined"))
				{
					$("#logoshowpiccontent").hide();
					
				}
				else
				{
					$(":text[name='printlogopic']").val(date.printLogo);
					var cardurl1=date.printLogo;
					$("#logoshowpiccontent").show();
					 cardurl1 = getRootPath() + cardurl1;
					$("#logoimgurllink").attr("href", cardurl1);
					$("#logoimgurllink img").attr("src", cardurl1);
				}
				showtranwidprice(date.tranprice);//显示价格表信息
			} else if (code == "607") {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("获取仓库详情失败，失败原因是:" + response.message);
				// $("#nav53").click();
			}
			return false;
		}
	});

	$("#bt_modify_warehouse").click(function() {
		modifyWarehouse();
		return false;
	});
}
//显示转运价格表信息list是转运价格表
function showtranwidprice(list)
{
	
	// 获取仓库列表
	$.ajax({
		type : "get",
		url : admin_warehosue_all,
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				if (response.data == null || response.data.length == 0) {
					// 没有数据
				} else {
					var str="";
					var ii=0;
					$.each(response.data, function() {
						if($("#modify_warehouse :hidden[name='id']").val()==this.id)
						{}
						else
						{
							var price="0";
							var cost="0";
							var selfPrice="0";
							var id=this.id;
							
							if(list!=null)
							{
								//alert(list.length);
								for(var iii=0;iii<list.length;iii++)
								{
									//alert(list[iii].tranwarehouseId);
									if(list[iii].tranwarehouseId==id)
									{
										
										price=list[iii].price;
										cost=list[iii].cost;
										selfPrice=list[iii].selfPrice;
										
										//alert(price);
									}
								}
								/*$.each(list, function() {
									if(this.tranwarehouseId==id)
									{
										
										price=this.price;
										cost=this.cost;
										alert(price);
									}
								});*/
								
							}
							
							str+="<tr id='tran_wid_flag"+ii+"'>";
							str+="<td style='display:none' id='tran_wid_id'>"+this.id+"</td>";
							str+="<td style='display:none'>"+'<input type="text" value="'+this.id+'" name="tran_wid_id_pic" id="tran_wid_id_pic"/>'+"</td>";
							str+="<td id='name'>"+this.name+"</td>";
							str+="<td >"+'<input type="text" value="'+cost+'" id="tran_wid_cost" name="tran_wid_cost"/>'+"</td>";
							str+="<td >"+'<input type="text" value="'+price+'" id="tran_wid_price" name="tran_wid_price"/>'+"</td>";
							str+="<td >"+'<input type="text" value="'+selfPrice+'" id="tran_wid_selfPrice" name="tran_wid_selfPrice"/>'+"</td>";
							str+="</tr>";
							ii++;
						}
						
					});
					if(str!="")
					{
						$("#wid_price_table tbody").html(str);
						$(":hidden[name='tran_wid_number']").val(ii);
					}
				}
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				// 失败
				// alert("获取仓库数据失败，原因是:" + response.message);
			}
		}
	});
}

/*
 * kai 20151015
 * 点击复位时，清空图片信息
 * 
 * */
function clearwarehousepic()
{
	$(":text[name='print2codepic']").val("");
	var cardurl1="";

	$("#imgurllink").attr("href", cardurl1);
	$("#imgurllink img").attr("src", cardurl1);
	$("#showpiccontent").hide();
}

function modifyWarehouse() {
	var param = $("#modify_warehouse :hidden[name='id']").val();
	var param1 = $(":text[name='name']").val();
	var param2 = $(":text[name='company']").val();
	var param3 = $(":text[name='country']").val();
	var param4 = $(":text[name='province']").val();
	var param5 = $(":text[name='city']").val();
	var param6 = $(":text[name='address']").val();
	var param7 = $(":text[name='zipCode']").val();
	var param8 = $(":text[name='serialNo']").val();
	var param9 = $(":text[name='contactName']").val();
	var param10 = $(":text[name='telephone']").val();
	var param11 = $("textarea[name='remark']").val();
	
	var param12 = $(":text[name='telephoneofcn']").val();
	var param13 = $(":text[name='telephoneofusa']").val();
	
	
	var printwidurl = $(":text[name='printwidurl']").val();
	var printWidCode = $(":text[name='wid_code_char2']").val();
	
	var callOrderAvailable = 0;
	if($("#callOrderAvailable").attr("checked")=="checked"){
		callOrderAvailable = 1;
	}
	$(":hidden[name='callOrderAvailable1']").val(callOrderAvailable);
	var callOrderCity = $("textarea[name='callOrderCity']").val();
	var widtype=0;
	if(document.getElementById("wid_type").checked==true)
	{
		widtype=1;
	}
	
	var tranwidnum=$(":hidden[name='tran_wid_number']").val();
	var tranprice="";
	var str2="";
	
	
	
	
	
	if(removenull(tranwidnum)!="")
	{
		
		for(var i=0;i<tranwidnum;i++)
		{
			var str="tran_wid_flag"+i;
			if(i==0)
			{
				str2+='"tranprice['+i+'].warehouseId":"'+param+'"';
			}
			else
			{
				str2+=',"tranprice['+i+'].warehouseId":"'+param+'"';
			}
			str2+=',"tranprice['+i+'].tranwarehouseId":"'+$("#"+str).find("td[id='tran_wid_id']").html()+'"';
			str2+=',"tranprice['+i+'].cost":"'+$("#"+str).find(":text[id='tran_wid_cost']").val()+'"';
			str2+=',"tranprice['+i+'].price":"'+$("#"+str).find(":text[id='tran_wid_price']").val()+'"';
			str2+=',"tranprice['+i+'].selfPrice":"'+$("#"+str).find(":text[id='tran_wid_selfPrice']").val()+'"';
			
		}
	}
	
	//alert(str2);
	
	$(":hidden[name='widtype1']").val(widtype);
	if (!checkWarehouseName(param1)) {
		alert("仓库名称格式不对，仓库名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseCompany(param2)) {
		alert("所属公司格式不对，公司名称最大长度为40个字符，请重新输入！");
	} else if (!checkWarehouseCountry(param3)) {
		alert("国家格式不对，国家名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseProvince(param4)) {
		alert("州格式不对，州名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseCity(param5)) {
		alert("市格式不对，市名称必须由1到20个字符组成，请重新输入！");
	} else if (!checkWarehouseAddress(param6)) {
		alert("街道地址格式不对，地址信息必须由1到100个字符组成，请重新输入！");
	} else if (!checkWarehouseZipCode(param7)) {
		alert("邮编格式不对，邮编地址必须由2到20个字符组成，请重新输入！");
	} else if (!checkWarehouseSerialNo(param8)) {
		alert("仓库排序号格式不对，仓库排序号必须是数字，请重新输入！");
	} else if (!checkWarehouseContactName(param9)) {
		alert("联系人姓名格式不对，联系人姓名最长长度为20个字符，请重新输入！");
	} else if (!checkWarehouseTelephone(param10)) {
		alert("联系人电话格式不对，联系人电话号码最长长度为20个字符，请重新输入！");
	} else if (!checkWarehouseRemark(param11)) {
		alert("备注信息格式不对，备注信息最长为200个字符，请重新输入！");
	} else {
		
		//判断是否包含上传图片
		var param14 = $(":file[name='file']").val();
		var logo = $(":file[name='filelogo']").val();
		//alert(param14);
		if ((param14 != null && param14 != '')||(logo != null && logo != ''))
		{
			modifyWarehousehavepic();//有图片，要单独提交
			return false;
		}
		else
		{
			param14=$(":text[name='print2codepic']").val();
			logo=$(":text[name='printlogopic']").val();
		}
		//alert("55555");
		if(removenull(callOrderCity)!="")
		{
			callOrderCity = callOrderCity.replace(/\r\n/g, ",").replace(/\r/g, ",").replace(/\n/g, ",");
		}
		if(removenull(str2)!="")
		{
		str1=str2+',"id":"'+param+'",'+'"name":"'+param1+'",'+'"company":"'+param2+'",'+'"country":"'+param3+'",'+'"province":"'+param4+'",'+'"city":"'+param5+'",'+'"address":"'+param6+'",'+'"zipCode":"'+param7+'",';
		str1+='"serialNo":"'+param8+'",'+'"contactName":"'+param9+'",'+'"telephone":"'+param10+'",'+'"remark":"'+param11+'",';
		str1+='"printPhoneCN":"'+param12+'",'+'"printPhoneUSA":"'+param13+'",'+'"printLogo":"'+logo+'",'+'"print2Code":"'+param14+'",'+'"type":"'+widtype+'",';
		str1+='"callOrderAvailable":"'+callOrderAvailable+'",'+'"callOrderCity":"'+callOrderCity+'",'+'"printWidCode":"'+printWidCode+'",'+'"printUrl":"'+printwidurl+'"';
		}
		else
		{
			str1='"id":"'+param+'",'+'"name":"'+param1+'",'+'"company":"'+param2+'",'+'"country":"'+param3+'",'+'"province":"'+param4+'",'+'"city":"'+param5+'",'+'"address":"'+param6+'",'+'"zipCode":"'+param7+'",';
			str1+='"serialNo":"'+param8+'",'+'"contactName":"'+param9+'",'+'"telephone":"'+param10+'",'+'"remark":"'+param11+'",';
			str1+='"printPhoneCN":"'+param12+'",'+'"printPhoneUSA":"'+param13+'",'+'"printLogo":"'+logo+'",'+'"print2Code":"'+param14+'",'+'"type":"'+widtype+'",';
			str1+='"callOrderAvailable":"'+callOrderAvailable+'",'+'"callOrderCity":"'+callOrderCity+'",'+'"printWidCode":"'+printWidCode+'",'+'"printUrl":"'+printwidurl+'"';
		
		}
		var obj = $.parseJSON("{" + str1 + "}");
		//alert(obj);
		$.ajax({
			type : "post",
			url : admin_modify_warehouse_url,
			data : {
				id : param,
				name : param1,
				company : param2,
				country : param3,
				province : param4,
				city : param5,
				address : param6,
				zipCode : param7,
				serialNo : param8,
				contactName : param9,
				telephone : param10,
				remark : param11,
				printPhoneCN : param12,
				printPhoneUSA : param13,
				printLogo : logo,
				print2Code : param14,
				type : widtype,
				callOrderAvailable : callOrderAvailable,
				callOrderCity : callOrderCity
				
			},
			data:obj,
			success : function(response) {
				var code = response.code;
				if (code == "200") {
					alert("修改成功");
					// $("#nav53").click();
					nav53Click();
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("修改失败，失败原因是:" + response.message);
				}
			}
		});
	}
	return false;
}


function modifyWarehousehavepic() {
	$("#modify_warehouse").ajaxSubmit(
			{
				type : "post",
				url : admin_warehouse_modifyhavepic_url,
				success : function(data) {
					// alert(data);
					$("#tmpmsgdiv1").html(data);
					var str = $("#tmpmsgdiv1 pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					if (code == "200") {
						alert("修改成功");
						// $("#nav53").click();
						nav53Click();
					} else if (code == "607") {
						alert("重新过期，请重新登录");
						window.location.href = "login.jsp";
					} else {
						alert("修改失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("操作失败");
					return false;
				}
			});
}

function loadmsaddpageurl()
{
	$("#main-content").load(admin_msj_order_add_page_url);
}
function loadNav54Data() {
	loadMsjOrderList("1");
	$("#a_add_msj_order_link").click(function() {
		$("#main-content").load(admin_msj_order_add_page_url);
		return false;
	});

	$("#a_delete_order_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的门店运单！");
		} else {
			if (confirm("您是否确认要删除门店运单信息?删除的运单是无法找回的！")) {
				$.ajax({
					type : "post",
					url : admin_msg_order_delete_url,
					data : $.param({
						"oid" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							// $("#nav54").click();
							nav54Click()
						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除转运单失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#o_del_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});
}

function loadMsjOrderList(pn) {
	$.ajax({
		type : "get",
		url : admin_msj_order_list_url,
		data : {
			"pageIndex" : pn
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					showMsjOrderList(null);
					showMsjOrderLink(null);
				} else {
					showMsjOrderList(response.data.datas);
					showMsjOrderLink(response.data);
				}
				afterLoadMsjOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;获取仓库列表信息失败,!</span></td>";
				$("#tab1 table tbody").html(info);
			}
		}
	});
}

function showMsjOrderList(list) {
	var str = "";
	if (list != null) {
		$
				.each(
						list,
						function() {
							str += '<tr id="' + this.id + '">';
							if (this.state == "1") {
								str += '<td><input type="checkbox" name="del_id" value="'
										+ this.orderId + '"/></td>';
							} else {
								str += "<td>&nbsp;</td>";
							}
							str += '<td>' + this.orderId + '</td>';

							var pm = "";
							$.each(this.details, function() {
								pm += this.ctype + ":" + this.quantity + ";";
							});
							str += '<td title="' + pm + '">' + pm + '</td>';
							//str += '<td>' + this.user.phone + '</td>';
							
							if((this.user==null)||(this.user=="null")||(this.user=="")||(this.user=="undefined"))
							{
								str += '<td>' + "&nbsp;" + '</td>';
							}
							else
							{
								if((this.user.phone==null)||(this.user.phone=="null")||(this.user.phone=="")||(this.user.phone=="undefined"))
								{
									if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
									{
										str += '<td>' + "&nbsp;" + '</td>';
									}
									else
									{
										str += '<td>' + this.user.email + '</td>';
									}
									
								}
								else
								{
									var tempstr=this.user.phone;
									
									if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
									{
										
									}
									else
									{
										tempstr=tempstr+"/"+this.user.email;
										
									}
									str += '<td>' + tempstr + '</td>';
								}
								
							}
							
							
							
							str += '<td>' + this.cName + '</td>';
							str += '<td>' + this.stateStr + '</td>';
							str += '<td>' + this.createDate + '</td>';
							if (this.state == "1") {
								str += '<td><a href="#" name="a_msj_order_pay_link">付款</a></td></tr>';
							} else {
								str += '<td id='
										+ this.orderId
										+ '><a href="" name="a_print_link">热敏(4x6)</a> | <a href="" name="a_order_print_a4_link">A4打印</a></td></tr>';
							}
						});
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='8'>"
					+ "<span>&nbsp;&nbsp;对不起，没有您对应门店的运单数据!</span></td>";
		}
	}
	$("#tab1 table tbody").html(str);
}
function showMsjOrderLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			loadMsjOrderList(pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					loadMsjOrderList(pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadMsjOrderList() {
	$("a[name='a_msj_order_pay_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		var url = admin_msg_order_pay_page_url + "?id=" + id;
		$("#main-content").load(url);
		return false;
	});

	$("a[name='a_print_link']").click(function() {
		var id = $(this).parent().parent().attr("id");
		var orderId = $(this).parent().attr("id");
		var url = admin_print_page_url + "?id=" + id + "&orderId=" + orderId;
		$("#my_print_div").load(url);
		return false;
	});
	$("a[name='a_order_print_a4_link']").click(function() {

		
		var id = "";
		var orderId = $(this).parent().attr("id");

		var url = admin_print_A4_page_url + "?id=" + id + "&orderId=" + orderId;

		$("#my_print_div").load(url);
		return false;
	});
}
// ////////////////////////////////////////////////
function loadNav542Data() {

	// 设置点击跳转的事件
	getglobalargs_commrate();
	$("#sjdztable tfoot a").click(function() {
		// 跳页
		var pn = $(this).attr("href");
		loadconsigneeinfo($(":radio[name='userId']:checked").val(), pn);
		return false;
	});

	$("#sjdztable tfoot input").keydown(
			function(event) {
				if (event.which == 13) {
					var pn = $(this).val();
					if (/^\d*$/.test(pn)) {
						loadconsigneeinfo($(":radio[name='userId']:checked")
								.val(), pn);
					} else {
						alert("只能输入数字");
					}
					$(this).blur();
				}
			});
	
	/*
	 * kai 20151026
	 * 添加禁用省请市区事件
	 * */
	$("#use_pct").click(function() {
		
		if($("#use_pct").is(':checked')==true)
		{
			$("#loc_province").attr("disabled","disabled");
			$("#loc_city").attr("disabled","disabled");
			$("#loc_town").attr("disabled","disabled");
			
		}
		else
		{
			$("#loc_province").removeAttr("disabled");
			$("#loc_city").removeAttr("disabled");
			$("#loc_town").removeAttr("disabled");
		}
	});
	
	
//alert("8888");
	loadChannelSelectOption();
	findEmptyStoragePosition();

	loadMsjFirstUserList();
	$("#a_back_msj_order_list_link").click(function() {
		nav54Click();
		return false;
	});
	$(":text[name='from_user_name']").change(function() {
		$(":radio[name='userId']").attr("checked", false);
		$(":radio[name='consigneeId']").attr("checked", false);
	});
	$(":text[name='premiumtotal']").change(countpremiummoney);
	
	$(":text[name='jwweight']").change(msOrderCalcFreight);
	
	$(":text[name='weight']").change(msOrderCalcFreight);
	$(":text[name='tariff']").change(msOrderCalcFreight);
	$(":text[name='other']").change(msOrderCalcFreight);
	$(":text[name='premium']").change(msOrderCalcFreight);
	$("select[name='commodityName']").change(msOrderCalcFreight);
	$(":text[name='length']").change(msOrderCalcFreight);
	$(":text[name='width']").change(msOrderCalcFreight);
	$(":text[name='height']").change(msOrderCalcFreight);
	$(":text[name='sjweight']").change(msOrderCalcFreight);

	$("#searchBt").click(function() {
		var key = $(":text[name='key']").val();
		$(":text[name='from_user_name']").val("");
		$(":text[name='from_user_real_name']").val("");
		loadMsjUserList(key);
		return false;
	});

	//获取保险的比例额度
	//var flags="print_order_hit,print_site_url";//获取logo图片,包裹提示,网站的url
	var flags="premium_rate";//
	 $.ajax({
			type : "post",
			url : admin_globalargs_getcontents_url,
			data : {
				"flags" : flags
			},
			success : function(response) {
				var code = response.code;

				//alert(code);
				if ("200" == code) {
					//alert(response.data[0]);
					$(":hidden[name='premiumratevalue']").val(response.data[0]);
				}
				else
				{
					$(":hidden[name='premiumratevalue']").val("0");
				}
			}
	 });
	
	// kai 20150912 添加重量改变onChange="msOrderCalcFreight()"
	$("#a_add_commodify_info")
			.click(
					function() {
						var commodity = $("select[name='commodityName']")
								.html();
						var str = '<p>'
								+ '<label style="display: inline;">商品类型：</label>'
								+ '<select name="commodityName" onChange="msOrderCalcFreight()" style="width: 100px; margin-right: 20px;" class="text-input">'
								+ commodity
								+

								'</select>&nbsp;商品数量：<input  name="commodifyQuantity" type="text" value="1" style="width:70px"class="text-input" />&nbsp;包裹信息：'
								+ '<input type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:120px"class="text-input" />'
								+'&nbsp;&nbsp; 品牌:<input type="text" name="commodifybrands" placeholder="填写具体物品品牌" style="width:120px" class="text-input">'
								+ '&nbsp;&nbsp; 实际重量:<input name="jwweight" onChange="msOrderCalcFreight()" placeholder="不为空" type="text" style="width:70px" class="text-input" value="0"/>'
								+ '&nbsp;&nbsp; 计费重量:<input name="sjweight" onChange="msOrderCalcFreight()" readonly="readonly" type="text" style="width:70px" class="text-input" value="0"/>'
								+
								// '&nbsp;计费重量：<input name="jfweight"
								// placeholder="不为空"style="width:70px"
								// class="text-input"/>'+
								'&nbsp;&nbsp;<a href="#" name="a_delete_commodify_info">删除</a></p>';
						$("#commodify_infos").append(str);
						$("a[name='a_delete_commodify_info']").click(
								function() {
									$(this).parent().remove();
									msOrderCalcFreight();
									return false;
								});
						return false;
					});

	$("a[name='a_delete_commodify_info']").click(function() {
		$(this).parent().remove();
		return false;
	});

	$("#add_msj_order_bt")
			.click(
					function() {

						var userId = $(":radio[name='userId']:checked").val();
						var orderId = $(":text[name='orderId']").val();
						
						if(removenull(orderId)!="")
						{
							orderId=orderId.toUpperCase();//所有小写字母变为大写字母
						}
						var fromUserName = $(":text[name='from_user_name']")
								.val();
						var fromUserRealName = $(
								":text[name='from_user_real_name']").val();
						var cName = $(":text[name='cName']").val();
						var cProvince="";
						var cCity="";
						var cDistrict="";
						var validate = true;
						if($("#use_pct").is(':checked')==true)//禁止使用
						{
						
						}
						else
						{
							cProvince = $("#loc_province option:checked")
							.text();
							cCity = $("#loc_city option:checked").text();
							cDistrict = $("#loc_town option:checked").text();
							
							
							
							if (cProvince == "省份") {
								$("#loc_province").css({
									"border-color" : "red"
								});
								$("#loc_province").change(function() {
									if ($("#loc_province").val() != null)
										$("#loc_province").css({
											"border-color" : ""
										});
								});
								validate = false;
								cProvince="";
							}
							if (cCity == "地级市") {
								$("#loc_city").css({
									"border-color" : "red"
								});
								$("#loc_city").change(function() {
									if ($("#loc_city").val() != null)
										$("#loc_city").css({
											"border-color" : ""
										});
								});
								validate = false;
								cCity="";
							}
							if (cDistrict == "市、县、区") {
								$("#loc_town").css({
									"border-color" : "red"
								});
								$("#loc_town").change(function() {
									if ($("#loc_town").val() != null)
										$("#loc_town").css({
											"border-color" : ""
										});
								});
								validate = false;
								
							}
							
							
						}
						
						var cid = $("select[name='cid']").val();// 通道号

						// kai 20150912 modify 把参数先保存到隐藏位置，在提交图片等信息时会提取

						
						$(":hidden[name='cUserId']").val(userId);
						$(":hidden[name='channelidname']").val(cid);

						var cStreetAddress = $(":text[name='cStreetAddress']")
								.val();
						var cZipCode = $(":text[name='cZipCode']").val();
						var cPhone = $(":text[name='cPhone']").val();

						var weight = $(":text[name='weight']").val();
						var sum_weight = $(":text[name='sum_weight']").val();
						var weightKg = $(":text[name='weightKg']").val();
						// alert(weightKg);
						var tariff = $(":text[name='tariff']").val();
						// var or = $(":text[name='or']").val();
						var other = $(":text[name='other']").val();
						var mail = $("select[name='mail']").val();
						var premium = $(":text[name='premium']").val();
						// var premium="0";o_del_check_all
						var remark = $("textarea[name='remark']").val();
						// var xiangqing=
						// $(":text[name='commodifyxiangqing']").val();

						var length = $(":text[name='length']").val();
						var width = $(":text[name='width']").val();
						var height = $(":text[name='height']").val();
						var parceValue = $(":text[name='parceValue']").val();
						var cardid = $(":text[name='cardidname']").val();
						var cardurl = $(":text[name='idurlcard']").val();
						cardurl = encodeURI(cardurl);
						var cardurlother = $(":text[name='idurlcardother']").val();
						cardurlother = encodeURI(cardurlother);
						var cardurltogether= $(":text[name='idurlcardtogether']").val();
						cardurltogether = encodeURI(cardurltogether);
						
						//alert(cardurlother);
						//alert(cardurltogether);
						
						
						
						
						

						if (cid == null || cid == "-1") {
							$("select[name='cid']").css({
								"border-color" : "red"
							});
							$("select[name='cid']")
									.change(
											function() {
												if ($("select[name='cid']")
														.val() != null
														&& !$(
																"select[name='cid']")
																.val() == "-1")
													$("select[name='cid']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						/*
						 * if (typeof(userId) == "undefined") {
						 * $("#u5402").css({ "border-color": "red" });
						 * $(":radio[name='userId']").change(function(){
						 * $("#u5402").css({ "border-color": "" }); }); validate =
						 * false; }
						 */
						if (fromUserName == "" || fromUserName == null) {
							$(":text[name='fromUserName']").css({
								"border-color" : "red"
							});
							$(":text[name='fromUserName']").change(
									function() {
										if ($(":text[name='fromUserName']")
												.val() != null)
											$(":text[name='fromUserName']")
													.css({
														"border-color" : ""
													});
									});
							validate = false;
						}

						if (cName == "" || cName == null) {
							$(":text[name='cName']").css({
								"border-color" : "red"
							});
							$(":text[name='cName']").change(function() {
								if ($(":text[name='cName']").val() != null)
									$(":text[name='cName']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}

						if (cProvince == "省份") {
							/*$("#loc_province").css({
								"border-color" : "red"
							});
							$("#loc_province").change(function() {
								if ($("#loc_province").val() != null)
									$("#loc_province").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cProvince="";
						}
						if (cCity == "地级市") {
							/*$("#loc_city").css({
								"border-color" : "red"
							});
							$("#loc_city").change(function() {
								if ($("#loc_city").val() != null)
									$("#loc_city").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cCity="";
						}
						if (cDistrict == "市、县、区") {
							/*$("#loc_town").css({
								"border-color" : "red"
							});
							$("#loc_town").change(function() {
								if ($("#loc_town").val() != null)
									$("#loc_town").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cDistrict="";
						}
						$(":hidden[name='cProvince']").val(cProvince);
						$(":hidden[name='cCity']").val(cCity);
						$(":hidden[name='cDistrict']").val(cDistrict);
						if (cStreetAddress == "" || cStreetAddress == null) {
							$(":text[name='cStreetAddress']").css({
								"border-color" : "red"
							});
							$(":text[name='cStreetAddress']").change(
									function() {
										if ($(":text[name='cStreetAddress']")
												.val() != null)
											$(":text[name='cStreetAddress']")
													.css({
														"border-color" : ""
													});
									});
							validate = false;
						}
//邮编不是必填
						/*if (cZipCode == "" || cZipCode == null) {
							$(":text[name='cZipCode']").css({
								"border-color" : "red"
							});
							$(":text[name='cZipCode']").change(function() {
								if ($(":text[name='cZipCode']").val() != null)
									$(":text[name='cZipCode']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}*/
						if (cPhone == "" || cPhone == null) {
							$(":text[name='cPhone']").css({
								"border-color" : "red"
							});
							$(":text[name='cPhone']").change(function() {
								if ($(":text[name='cPhone']").val() != null)
									$(":text[name='cPhone']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}

						if (weight == "" || weight == null || isNaN(weight)
								|| weight == "0") {
							$(":text[name='weight']").css({
								"border-color" : "red"
							});
							$(":text[name='weight']")
									.change(
											function() {
												if ($(":text[name='weight']")
														.val() != null
														&& !isNaN($(
																":text[name='weight']")
																.val())
														&& $(
																":text[name='weight']")
																.val() > 0)
													$(":text[name='weight']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (length == "" || length == null || isNaN(length)) {
							$(":text[name='length']").css({
								"border-color" : "red"
							});
							$(":text[name='length']")
									.change(
											function() {
												if ($(":text[name='length']")
														.val() != null
														&& !isNaN($(
																":text[name='length']")
																.val()))
													$(":text[name='length']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (width == "" || width == null || isNaN(width)) {
							$(":text[name='width']").css({
								"border-color" : "red"
							});
							$(":text[name='width']")
									.change(
											function() {
												if ($(":text[name='width']")
														.val() != null
														&& !isNaN($(
																":text[name='width']")
																.val()))
													$(":text[name='width']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (height == "" || height == null || isNaN(height)) {
							$(":text[name='height']").css({
								"border-color" : "red"
							});
							$(":text[name='height']")
									.change(
											function() {
												if ($(":text[name='height']")
														.val() != null
														&& !isNaN($(
																":text[name='height']")
																.val()))
													$(":text[name='height']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (isNaN(parceValue)) {
							$(":text[name='parceValue']").css({
								"border-color" : "red"
							});
							$(":text[name='parceValue']")
									.change(
											function() {
												if (!isNaN($(
														":text[name='parceValue']")
														.val()))
													$(
															":text[name='parceValue']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						var details = [];
						var i = 0;
						$("select[name='commodityName']")
								.each(
										function() {
											var detail = [];
											detail[0] = $(this).val();
											var cxiangqingObj = $(this)
													.parent()
													.find(
															":input[name='commodifyxiangqing']");
											var cquantityObj = $(this)
													.parent()
													.find(
															":input[name='commodifyQuantity']");

											detail[1] = cquantityObj.val();
											detail[2] = cxiangqingObj.val();
											detail[3] = $(this).parent().find(
													":input[name='sjweight']")
													.val();
											detail[4] = $(this).parent().find(
											":input[name='commodifybrands']")
											.val();
											
											detail[5] = $(this).parent().find(
											":input[name='jwweight']")
											.val();
											
											// detail[4] =
											// $(this).parent().find(":input[name='jfweight']").val();

											var cxiangqing = cxiangqingObj
													.val();
											var cquantity = cquantityObj.val();

											if (cquantity == ""
													|| cquantity == null
													|| isNaN(cquantityObj.val())) {
												cquantityObj.css({
													"border-color" : "red"
												});
												cquantityObj
														.change(function() {
															if (cquantityObj
																	.val() != null
																	&& !isNaN(cquantityObj
																			.val()))
																cquantityObj
																		.css({
																			"border-color" : ""
																		});
														});
												validate = false;
											}
											if (cxiangqing == ""
													|| cxiangqing == null) {
												cxiangqingObj.css({
													"border-color" : "red"
												});
												cxiangqingObj
														.change(function() {
															if (cxiangqingObj
																	.val() != null)
																cxiangqingObj
																		.css({
																			"border-color" : ""
																		});
														});
												validate = false;
											}

											details[i] = detail;
											i = i + 1;
										});

						if (i == 0) {
							alert("运单商品不能为空，请按添加商品按钮，填写商品信息!");
							return false;
						}
						if (!validate) {
							alert("红色框中的信息必须正确填写，才可以提交！");
							return false;
						}

						
						var totalmoney=$(":text[name='totalmoney']").val();
						var totalp = parseFloat(totalmoney);
						if (totalp == "NaN") {
						alert("计算总价钱出错，请检查格式!");
						return false;
						}
						if(totalp<0)
						{
							alert("总价钱不能小于0!");
							return false;
						}
						
						var file = $(":file[name='file']").val();
						//kai 20150921
						var fileother = $(":file[name='fileother']").val();
						// alert(file);
						if ((file != null && file != '')||(fileother != null && fileother != '')) {

							addorderhavepic_ms();
							return false;
						}

						//alert(cardurlother);
						//alert(cardurltogether);
						
						if (typeof (userId) == "undefined") {

							$
									.ajax({
										type : "post",
										url : admin_msj_order_add_no_userid_url,
										data : $.param({
											userId : fromUserName, // 暂时这样处理
											orderId : orderId,
											userName : fromUserRealName,
											cName : cName,
											cProvince : cProvince,
											cCity : cCity,
											cDistrict : cDistrict,
											cStreetAddress : cStreetAddress,
											cZipCode : cZipCode,
											cPhone : cPhone,
											weight : weight,
											jwweight : sum_weight,
											tariff : tariff,
											or : "0",
											other : other,
											mail : mail,
											premium : premium,
											remark : remark,
											orderCommoditys : details,
											length : length,
											width : width,
											height : height,
											parceValue : parceValue,
											channelId : cid,
											cardid : cardid,
											cardurl : cardurl,
											weightKg : weightKg,
											cardurlother : cardurlother,
											cardurltogether : cardurltogether
											}, true),
										success : function(response) {
											var code = response.code;
											if ("200" == code) {
												/*var url = admin_msg_order_pay_page_url
														+ "?id="
														+ response.data["id"]
														+ "&oid="
														+ response.data["orderId"];
												$("#main-content").load(url);*/
												var printtype=document.getElementById("paysuccessprint").checked;
												
												
												if(document.getElementById("submitopentype").checked){
													var url = "../admin/index.jsp"
														+ "?id="
														+ response.data["id"]
														+ "&oid="
														+ response.data["orderId"]
														+ "&locationid=1"
														+ "&printtype="
														+ printtype;
												        window.open(url);//在新窗口中打开
												}
												else
												{
													var url = admin_msg_order_pay_page_url
													+ "?id="
													+ response.data["id"]
													+ "&oid="
													+ response.data["orderId"]
													+ "&printtype="
													+ printtype;
											        $("#main-content").load(url);//在原有窗口中打开
												}
											} else {
												alert("操作失败，失败原因是:"
														+ response.message);
											}
										}
									});
						} else {
							//alert(fromUserRealName);
							$
									.ajax({
										type : "post",
										url : admin_msj_order_add_url,
										data : $.param({
											userId : userId,
											orderId : orderId,
											cName : cName,
											cProvince : cProvince,
											cCity : cCity,
											cDistrict : cDistrict,
											cStreetAddress : cStreetAddress,
											cZipCode : cZipCode,
											cPhone : cPhone,
											weight : weight,
											jwweight : sum_weight,
											tariff : tariff,
											or : "0",
											other : other,
											mail : mail,
											premium : premium,
											remark : remark,
											orderCommoditys : details,
											length : length,
											width : width,
											height : height,
											parceValue : parceValue,
											channelId : cid,
											cardid : cardid,
											cardurl : cardurl,
											weightKg : weightKg,
											cardurlother : cardurlother,
											cardurltogether : cardurltogether,
											senduserName : fromUserRealName,
											"storagePosition.id" : document.getElementById("storagePositionId").value
										}, true),
										success : function(response) {
											var code = response.code;
											if ("200" == code) {
												/*var url = admin_msg_order_pay_page_url
														+ "?id="
														+ response.data["id"]
														+ "&oid="
														+ response.data["orderId"];*/
												   //$("#main-content").load(url);
												var printtype=document.getElementById("paysuccessprint").checked;
												if(document.getElementById("submitopentype").checked){
													var url = "../admin/index.jsp"
														+ "?id="
														+ response.data["id"]
														+ "&oid="
														+ response.data["orderId"]
														+ "&locationid=1"
														+ "&printtype="
														+ printtype;
												        window.open(url);//在新窗口中打开
												}
												else
												{
													var url = admin_msg_order_pay_page_url
													+ "?id="
													+ response.data["id"]
													+ "&oid="
													+ response.data["orderId"]
													+ "&printtype="
													+ printtype;
											        $("#main-content").load(url);//在原有窗口中打开
												}
												
												
														
												
											} else {
												alert("操作失败，失败原因是:"
														+ response.message);
											}
										}
									});
						}

						return false;
					});
}

function countpremiummoney()
{
	var rate=$(":hidden[name='premiumratevalue']").val();
	if((rate=="0")||(rate==null))
	{
		return false;
	}
	var rate = parseFloat(rate);
	if (isNaN(rate))
	{
		return false;
	}
	var premium=parseFloat(rate*parseFloat($(":text[name='premiumtotal']").val()));
	if (isNaN(premium))
	{
		return false;
	}
	$(":text[name='premium']").val(premium);
	msOrderCalcFreight();
}

//门市包含图片处理函数
function addorderhavepic_ms() {
	// alert("开始提交有图片订单");
	$("#add_form").ajaxSubmit(
			{
				type : "post",
				// url : "../consignee/add",//admin/consignee/add
				// url : "consignee/add",
				// url : "../admin/msjorder_pic/submit",
				url : "../admin/msjorder_pic/submit",
				success : function(data) {
					// alert(data);
					$("#tmpmsgdiv1").html(data);
					//alert(data);
					var str = $("#tmpmsgdiv1 pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					var response=obj;
					if (code == "200") {
						/*var url = admin_msg_order_pay_page_url + "?id="
								+ obj.data["id"] + "&oid="
								+ obj.data["orderId"];
						$("#main-content").load(url);*/
						var printtype=document.getElementById("paysuccessprint").checked;
						if(document.getElementById("submitopentype").checked){
							var url = "../admin/index.jsp"
								+ "?id="
								+ response.data["id"]
								+ "&oid="
								+ response.data["orderId"]
								+ "&locationid=1"
								+ "&printtype="
								+ printtype;
						        window.open(url);//在新窗口中打开
						}
						else
						{
							var url = admin_msg_order_pay_page_url
							+ "?id="
							+ response.data["id"]
							+ "&oid="
							+ response.data["orderId"]
							+ "&printtype="
							+ printtype;
					        $("#main-content").load(url);//在原有窗口中打开
						}
						
					} else if (code == "607") {
						alert("重新过期，请重新登录");
						window.location.href = "login.jsp";
					} else {
						alert("添加运单失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("操作失败");
					return false;
				}
			});
}






// kai 20160121 修改空运单提交图片

function addorderhavepic() {
	$("#modify_form").ajaxSubmit(
			{
				type : "post",
				url : "../admin/emptyorder_pic/submit",
				success : function(data) {
					// alert(data);
					$("#tmpmsgdiv1").html(data);
					//alert(data);
					var str = $("#tmpmsgdiv1 pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					var response=obj;
					if (code == "200") {
						/*var url = admin_msg_order_pay_page_url + "?id="
								+ obj.data["id"] + "&oid="
								+ obj.data["orderId"];
						$("#main-content").load(url);*/
						var printtype=document.getElementById("paysuccessprint").checked;
						if(document.getElementById("submitopentype").checked){
							var url = "../admin/index.jsp"
								+ "?id="
								+ response.data["id"]
								+ "&oid="
								+ response.data["orderId"]
								+ "&locationid=1"
								+ "&printtype="
								+ printtype;
						        window.open(url);//在新窗口中打开
						}
						else
						{
							var url = admin_msg_order_pay_page_url
							+ "?id="
							+ response.data["id"]
							+ "&oid="
							+ response.data["orderId"]
							+ "&printtype="
							+ printtype;
					        $("#main-content").load(url);//在原有窗口中打开
						}
						
					} else if (code == "607") {
						alert("重新过期，请重新登录");
						window.location.href = "login.jsp";
					} else {
						alert("添加运单失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("操作失败");
					return false;
				}
			});
}

function loadChannelSelectOption() {
	
	$.ajax({
		post : "get",
		url : admin_channel_list_url,
		success : function(response) {
			var code = response.code;
			if ("200" == code) {

				// showCommodityList(response.data);;
				var str = "";
				$.each(response.data, function() {
					str += "<option value='" + this.id + "'  price='"
							+ this.price + "' msPrice='" + this.msPrice
							+ "' vipOnePrice='" + this.vipOnePrice
							+ "' vipTwoPrice='" + this.vipTwoPrice		
							+ "' additivePrice='" + this.additivePrice	
							+ "' vipThreePrice='" + this.vipThreePrice + "'>"
							+ this.name + "</option>";
				});
				$("select[name='cid']").html(str);
				loadCommoditySelectOption();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}
function loadEmptyStoragePosition(){
	$.ajax({
		post : "get",
		url : "../admin/storagePosition/findEmptyStoragePositionByOrderType",
		data : {
			typeRelateId : $("select[name='cid']").val()
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if(response.data == null){
					document.getElementById("storagePositionId").value = "";
				}else{
					document.getElementById("storagePositionId").value = response.data.id;
					document.getElementById("storageName").value = response.data.storageName;
					document.getElementById("storagePositionColNumber").value = response.data.colNumber;
					document.getElementById("storagePositionRowNumber").value = response.data.rowNumber;
				}
				return false;
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			};
		}
	});
}
function loadStoragePositionByUser(){
	$.ajax({
		post : "get",
		url : "../admin/storagePosition/findStoragePosition4UserByOrderType",
		data : {
			userId : $(":radio:checked").val(),
			typeRelateId : $("select[name='cid']").val()
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if(null != response.data){
					document.getElementById("storagePositionId").value = response.data.id;
					document.getElementById("storageName").value = response.data.storageName;
					document.getElementById("storagePositionColNumber").value = response.data.colNumber;
					document.getElementById("storagePositionRowNumber").value = response.data.rowNumber;
					if(response.data.userId != null && response.data.userId != ""){
						document.getElementById("storageName").readOnly = true;
						document.getElementById("storagePositionColNumber").readOnly = true;
						document.getElementById("storagePositionRowNumber").readOnly = true;
						document.getElementById("storagePositionSuggestion").innerHTML = "用户已有仓位";
					}else{
						document.getElementById("storageName").readOnly = false;
						document.getElementById("storagePositionColNumber").readOnly = false;
						document.getElementById("storagePositionRowNumber").readOnly = false;
						ment.getElementById("storagePositionSuggestion").innerHTML = "";
					}
				}else{
					document.getElementById("storagePositionId").value = "";
					document.getElementById("storageName").value = "";
					document.getElementById("storagePositionColNumber").value = 0;
					document.getElementById("storagePositionRowNumber").value = 0;
					document.getElementById("storageName").readOnly = true;
					document.getElementById("storagePositionColNumber").readOnly = true;
					document.getElementById("storagePositionRowNumber").readOnly = true;
					document.getElementById("storagePositionSuggestion").innerHTML = "已无多余仓位";
				}
				return false;
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
				return false;
			};
		}
	});
}
function checkStoragePositionByUser(){
	$.ajax({
		post : "get",
		url : "../admin/storagePosition/checkStoragePositionByUser",
		data : {
			userId : $(":radio:checked").val(),
			storageName :  $("#storageName").val(),
			colNumber :  $("#storagePositionColNumber").val(),
			rowNumber :  $("#storagePositionRowNumber").val(),
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if(!response.data){//false, 不可以使用
					document.getElementById("storageName").style.background = "#f77";
					document.getElementById("storagePositionColNumber").style.backgroundColor = "#f77";
					document.getElementById("storagePositionRowNumber").style.backgroundColor = "#f77";
					document.getElementById("storagePositionId").value = "";
					$.ajax({
						post : "get",
						url : "../admin/storagePosition/findEmptyStoragePosition",
						success : function(response) {
							var code = response.code;
							if ("200" == code) {
								if(response.data == null){
									alert(response.message);
								}else{
									document.getElementById("storagePositionSuggestion").innerHTML = "建议位置：" + response.data.storageName + "/" + response.data.rowNumber + "/" + response.data.colNumber;
								}
								return false;
							};
						}
					});
				}else{
					document.getElementById("storageName").style.background = "inherit";
					document.getElementById("storagePositionColNumber").style.backgroundColor = "inherit";
					document.getElementById("storagePositionRowNumber").style.backgroundColor = "inherit";
					document.getElementById("storagePositionId").value = response.data;
				}
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			};
		}
	});
}
function loadCommoditySelectOption() {
	findEmptyStoragePosition();
	$("select[name='commodityName']").html("");
	var cid = $("select[name='cid']").val();
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	$.ajax({
		post : "get",
		url : admin_commodity_list_url,
		data : {
			"cid" : cid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {

				// showCommodityList(response.data);;
				var str = "";
				$.each(response.data, function() {
					str += "<option value='" + this.id + "'  price='"
							+ this.price + "' msPrice='" + this.msPrice
							+ "' vipOnePrice='" + this.vipOnePrice
							+ "' vipTwoPrice='" + this.vipTwoPrice
							+ "' vipThreePrice='" + this.vipThreePrice + "'>"
							+ this.name + "</option>";
				});
				$("select[name='commodityName']").html(str);
				msOrderCalcFreight();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

function loadMsjFirstUserList() {
	loadMsjUserList("", null);
}

function loadMsjUserList(key, id) {
	$.ajax({
		type : "get",
		url : admin_user_all,
		data : {
			key : key
		},
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				var str = "";
				$("#user_info_table tbody").html("");
				if (response.data != null) {
					$.each(response.data.datas, function() {
						str += '<tr id="' + this.phone + '"><td id="'
								+ this.type
								+ '"><input type="radio" name="userId" value="'
								+ this.id + '"/></td>';
						if(removenull(this.phone)=="")
						{
							str += '<td>' + this.email + '</td>';
						}
						else
						{
							str += '<td>' + this.phone + '</td>';
						}
						str += '<td>' + this.realName + '</td>';
						var rmb = "0";
						if (this.rmbBalance != null) {
							rmb = this.rmbBalance;
						}
						var usd = "0";
						if (this.usdBalance != null) {
							usd = this.usdBalance;
						}
						str += '<td>' + rmb + '&nbsp;&nbsp;/&nbsp;&nbsp;' + usd
								+ '</td>';
					});
					$("#user_info_table tbody").html(str);
					$(":radio[name='userId']").click(
							function() {
								$(":hidden[name='userType']").val(
										$(this).parent().attr("id"));
								var phone = $(this).parent().parent()
										.attr("id");
								var name = $(this).parent().next().next()
										.text();
								$(":text[name='from_user_name']").val(phone);
								$(":text[name='from_user_real_name']")
										.val(name);
								loadconsigneeinfo($(this).val(), 1);
								msOrderCalcFreight();
								findStorage4User();
							});
					/*
					 * if (id != null && id != '') { $(":radio[value='" + id +
					 * "']").click(); }
					 */
				} else {
					addUserDlg(key);
				}

			} else {
				alert("获取会员信息失败");
				// $("#nav54").click();
				nav54Click();
			}
		}
	});
}
function loadconsigneeinfo(userId, pn) {
	$.ajax({
		type : "get",
		url : admin_consignee_search_by_emp,
		data : {
			"id" : userId,
			"pageIndex" : pn

		},
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				if (response.data != null) {
					showsjrdzlist(response.data.datas);
					showpagesplit(response.data);
				} else {
					showsjrdzlist(null);
					showpagesplit(null);
				}
				// aftershow();
			} else if ("607" == code) {
				window.location.href = "login.jsp";
			} else {
				// 失败
				alert("获取会员信息失败，原因是:" + response.message);
			}
		}
	});
}

function showsjrdzlist(list) {
	$("#sjdztable tbody").html("");
	if (list != null && list.length > 0) {
		$.each(list, function() {
			var str = "<tr id='" + this.id + "'>";
			str += "<td><input type='radio' name='consigneeId' value='"
					+ this.id + "'/></td>";
			str += "<td><a title='" + this.name + "' name='conName'>"
					+ this.name + "</a></td>";
			str += "<td><a title='" + this.phone + "' name='conPhone'>"
					+ this.phone + "</a></td>";
			str += "<td><a title='" + this.province + "/" + this.city + "/"
					+ this.district + "'>" + this.province + "/" + this.city
					+ "/" + this.district + "</a></td>";
			str += "<td><a title='" + this.streetAddress
					+ "' name='conStreetAddress'>" + this.streetAddress
					+ "</a></td>";
			str += "<td><a title='" + this.zipCode + "' name='conZipCode'>"
					+ this.zipCode + "</a></td>";

			str += "<td style='display:none' name='conProvince'>"
					+ this.province + "</td>";
			str += "<td style='display:none' name='conCity'>" + this.city
					+ "</td>";
			str += "<td style='display:none' name='conDistrict'>"
					+ this.district + "</td>";
			str += "<td style='display:none' name='conCardId'>" + this.cardId
					+ "</td>";
			str += "<td style='display:none' name='conCardUrl'>" + this.cardUrl
					+ "</td>";
			
			str += "<td style='display:none' name='conCardUrlother'>" + this.cardurlother
			+ "</td>";
			str += "<td style='display:none' name='conCardUrltogether'>" + this.cardurltogether
			+ "</td>";
			$("#sjdztable tbody").append(str);
		});
	}
	$(":radio[name='consigneeId']").click(
			function() {

				$(":text[name='cName']").val(
						$(this).parent().parent().find("a[name='conName']")
								.html());
				var province1=$(this).parent().parent().find("td[name='conProvince']").html();
				
				if((province1==null)||(province1=="")||(province1=="undefined"))
				{
					//$("select[name='loc_province']").val("");
					//$("#loc_province").val("省份");
					//$("#loc_city").val("");
					//$("#loc_town").val("");
					//$('#loc_province option[value=""]').attr("selected",true);
					
					var a = document.getElementById("loc_province");
					a.options[0].selected = true;
					a = document.getElementById("loc_city");
					a.options[0].selected = true;
					a = document.getElementById("loc_town");
					a.options[0].selected = true;
				}
				else
				{	
					$(
							"#loc_province option[name="
									+ $(this).parent().parent().find(
											"td[name='conProvince']").html()).attr(
							'selected', true);
	
					var loc = new Location();
					var title = [ '省份', '地级市', '市、县、区' ];
					$.each(title, function(k, v) {
						title[k] = '<option value="">' + v + '</option>';
					});
					$('#loc_city').empty();
					$('#loc_city').append(title[1]);
					loc.fillOption('loc_city', '0,' + $('#loc_province').val());
					$('#loc_town').empty();
					$('#loc_town').append(title[2]);
	
					$(
							"#loc_city option[name="
									+ $(this).parent().parent().find(
											"td[name='conCity']").html()).attr(
							'selected', true);
					$('#loc_town').empty();
					$('#loc_town').append(title[2]);
					loc.fillOption('loc_town', '0,' + $('#loc_province').val()
							+ ',' + $('#loc_city').val());
					$(
							"#loc_town option[name="
									+ $(this).parent().parent().find(
											"td[name='conDistrict']").html()).attr(
							'selected', true);
				}
				

				$(":text[name='cStreetAddress']").val(
						$(this).parent().parent().find(
								"a[name='conStreetAddress']").html());
				$(":text[name='cZipCode']").val(
						$(this).parent().parent().find("a[name='conZipCode']")
								.html());
				$(":text[name='cPhone']").val(
						$(this).parent().parent().find("a[name='conPhone']")
								.html());
				// $(":text[name='cid']").val(
				// $(this).parent().parent().find(
				// "td[name='conCardId']").html());
				// kai 20150912
				$(":text[name='cardidname']").val(
						$(this).parent().parent().find("td[name='conCardId']")
								.html());
				// $(":text[name='cPhone']").val($(this).parent().parent().find("td[name='conPhone']").html());
				var str = '';
				var url = $(this).parent().parent().find(
						"td[name='conCardUrl']").html();
				if (url == null || url == '' || url == "null") {
					// no pic, ignore
					$("#showcardpicid").attr("style", "display:none");

					$(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
				} else {
					/*
					 * $(":hidden[name='old_file']").val(url); url = baseUrl +
					 * url; str += "<br/><a href='" + url + "'
					 * target='_blank'><img width='30px' height='30px' src='" +
					 * url + "'/></a>";
					 */
					// alert(cardurl1);
					$("#showcardpicid").attr("style", "display:block;");
					$(":text[name='idurlcard']").val(url);// 保存现有的图片路径
					
					url = getRootPath() + url;
					$("#imacardurlid").attr("href", url);
					$("#imacardurlid img").attr("src", url);

					//$(":text[name='cardpicid']").val(url);// 清空控件的原来文件
				}
				url = $(this).parent().parent().find(
				"td[name='conCardUrlother']").html();
				if (url == null || url == '' || url == "null") {
					// no pic, ignore
					$("#showcardpicidother").attr("style", "display:none");

					$(":text[name='idurlcardother']").val("");// 已经重新上传，清空原有的图片
				} else {
					/*
					 * $(":hidden[name='old_file']").val(url); url = baseUrl +
					 * url; str += "<br/><a href='" + url + "'
					 * target='_blank'><img width='30px' height='30px' src='" +
					 * url + "'/></a>";
					 */
					// alert(cardurl1);
					$("#showcardpicidother").attr("style", "display:block;");
					$(":text[name='idurlcardother']").val(url);// 保存现有的图片路径
					url = getRootPath() + url;
					$("#imacardurlidother").attr("href", url);
					$("#imacardurlidother img").attr("src", url);

					//$(":text[name='cardpicidother']").val(url);// 清空控件的原来文件
				}
				
				url = $(this).parent().parent().find(
				"td[name='conCardUrltogether']").html();
				if (url == null || url == '' || url == "null") {


					$(":text[name='idurlcardtogether']").val("");// 已经重新上传，清空原有的图片
				} else {
					$(":text[name='idurlcardtogether']").val(url);// 已经重新上传，清空原有的图片
				}
				
				
				
				// $("#card_file").html(str);

				if ($(":text[name='cName']").val() != null) {
					$(":text[name='cName']").css({
						"border-color" : ""
					});
				}
				if ($("#loc_province").val() != null) {
					$("#loc_province").css({
						"border-color" : ""
					});
				}
				if ($("#loc_city").val() != null) {
					$("#loc_city").css({
						"border-color" : ""
					});
				}
				if ($("#loc_town").val() != null) {
					$("#loc_town").css({
						"border-color" : ""
					});
				}
				if ($(":text[name='cZipCode']").val() != null) {
					$(":text[name='cZipCode']").css({
						"border-color" : ""
					});
				}
				if ($(":text[name='cStreetAddress']").val() != null) {
					$(":text[name='cStreetAddress']").css({
						"border-color" : ""
					});
				}
				if ($(":text[name='cPhone']").val() != null) {
					$(":text[name='cPhone']").css({
						"border-color" : ""
					});
				}

				$(":file[name='file']").val("");// 清空原来选择过上传的图片
				$(":file[name='fileother']").val("");// 清空原来选择过上传的图片

				// 当上传图片时，用于实时隐藏原地址薄中的图片
				$("#cardpicid").on("change", function() {
					var picValue = $(":file[name='file']").val();
					if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
						$("#showcardpicid").attr("style", "display:none");
						//$(":text[name='idurlcard']").val("");// 已经重新上传，清空原有的图片
					}
					else
					{
						var url2=$(":text[name='idurlcard']").val();
						if((url2!=null)&&(url2!="")&&(url2!="null"))
						{
							$("#showcardpicid").attr("style", "display:block;");
							var cardurl1 = getRootPath() + url2;
							$("#imacardurlid").attr("href", cardurl1);
							$("#imacardurlid img").attr("src", cardurl1);
							
						}
					}

				});
				$("#cardpicidother").on("change", function() {
					var picValue = $(":file[name='fileother']").val();
					if ((picValue != null) && ("" != picValue)) {// 如果有图片,更新图片
						$("#showcardpicidother").attr("style", "display:none");
						//$(":text[name='idurlcardother']").val("");// 已经重新上传，清空原有的图片
					}
					else
					{
						var url2=$(":text[name='idurlcardother']").val();
						if((url2!=null)&&(url2!="")&&(url2!="null"))
						{
							$("#showcardpicidother").attr("style", "display:block;");
							var cardurl1 = getRootPath() + url2;
							$("#imacardurlidother").attr("href", cardurl1);
							$("#imacardurlidother img").attr("src", cardurl1);
							
						}
					}

				});

			});
}

function showpagesplit(pageSplit) {
	var rowCount = 0;
	var pageSize = 0;
	var pageNow = 0;
	var pageCount = 0;
	if (pageSplit != null) {
		rowCount = pageSplit.rowCount;
		pageSize = pageSplit.pageSize;
		pageNow = pageSplit.pageNow;
		pageCount = pageSplit.pageCount;
	}
	$("#trsize").html(rowCount);
	$("#tpsize").html(pageCount);
	$("#first_page").attr("href", "1");
	$("#pre_page").attr("href", pageNow - 1);
	$("#next_page").attr("href", pageNow + 1);
	$("#last_page").attr("href", pageCount);
}

function loadNav543Data() {
	$("#a_back_msj_order_list_link").click(function() {
		nav54Click();
		return false;
	});
	$("#bt_back_msj_order_list").click(function() {
		nav54Click();
	});
	$("#bt_back_add_msj_order_list").click(function() {
		$("#main-content").load(admin_msj_order_add_page_url, {
			"username" : $("#pay_nick_name").html(),
			"realname" : $("#real_name").html()
		});
	});

	$("#print_order").click(
			function() {
				alert($(":hidden[name='oid']").val());
				var url = admin_print_page_url + "?id="
						+ $(":hidden[name='id']").val() + "&orderId="
						+ $(":hidden[name='oid']").val();
				$("#my_print_div").load(url);
			});

	$("#print_empty_order").click(
			function() {
				
				var url = admin_print_page_url + "?id="
						+ $(":hidden[name='id']").val() + "&orderId="
						+ $(":hidden[name='oid']").val();
				$("#my_print_div").load(url);
			});
	
	$("#print_a4_order").click(
			function() {
				//alert($(":hidden[name='id']").val());
				//alert($(":hidden[name='oid']").val());
				var url = admin_print_A4_page_url + "?id="
						+ $(":hidden[name='id']").val() + "&orderId="
						+ $(":hidden[name='oid']").val();
				$("#my_print_div").load(url);
				
	});
	$("#bt_back_empty_order_list").click(function() {
		nav59Click();
	});
	//alert($(":hidden[name='printtype']").val());
	if($(":hidden[name='printtype']").val()=="true")
	{
		//alert("asdf");
		
		$("#print_order").hide();
		if ($(":hidden[name='type']").val() == "emptyOrder") {
			$("#p_print_empty_order").show();
		} else {
			$("#p_print_order").show();
		}
	}
	

	$.ajax({
		type : "get",
		url : admin_order_get_one_url,
		data : {
			"id" : $(":hidden[name='id']").val()
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				var phone = response.data.user.phone;
				var rmb = response.data.user.rmbBalance;
				var usd = response.data.user.usdBalance;
				var totalMoney = response.data.totalMoney;
				var realName = response.data.user.realName;
				$("#pay_nick_name").html(phone);
				$("#real_name").html(realName);

				$("#oid").html(response.data.orderId);
				$("#pay_balance").html(
						"￥" + rmb + "&nbsp;&nbsp;/&nbsp;&nbsp;$" + usd);
				//$("#pay_total_money").html("$" + totalMoney);
				var totalMoney_str="$" + totalMoney;
				
				
				if(isNaN(cur_usa_cn))
				{
					
				}
				else
				{
					var totalMoney1=parseFloat(totalMoney)*parseFloat(cur_usa_cn);
					if(isNaN(totalMoney1))
					{
						
					}
					else
					{
						totalMoney_str=totalMoney_str+" / ￥"+totalMoney1;
					}
				}
				
				$("#pay_total_money").html( totalMoney_str);
			} else {
				// $("#nav54").click();
				nav54Click();
			}
			return false;
		}
	});

	$("#pay_submit").click(function() {
		$.ajax({
			type : "post",
			url : admin_msg_order_pay_url,
			data : {
				id : $(":hidden[name='id']").val(),
				type : $("select[name='type']").val()
			},
			success : function(response) {
				var code = response.code;
				if (code == "200") {
					//alert("支付成功");
					$("#p_pay_balance").hide();
					$("#p_pay_total").hide();
					$("#p_pay_way").hide();
					$("#p_pay_submit").hide();
					$("#print_order").show();
					if ($(":hidden[name='type']").val() == "emptyOrder") {
						$("#p_print_empty_order").show();
					} else {
						$("#p_print_order").show();
					}
					//alert($(":hidden[name='id']").val());
					//alert($(":hidden[name='oid']").val());
					if($(":hidden[name='printtype']").val()=="true")
					{
						var url = admin_print_page_url + "?id="
						+ $(":hidden[name='id']").val() + "&orderId="
						+ $(":hidden[name='oid']").val();
				        $("#my_print_div").load(url);
					}
					// var url = admin_print_page_url + "?id=" +
					// $(":hidden[name='id']").val()+"&orderId="+$(":hidden[name='oid']").val();
					// $("#my_print_div").load(url);
					// nav54Click();
				} else {
					alert("支付失败，失败原因是:" + response.message);
				}
			}

		});
		return false;
	});
}

function loadNav55Data() {
	loadFirstRouteOrderList();

	$(":submit[name='searchSub']").click(function() {
		var oid = $(":text[name='oid']").val();
		var sdate = $(":text[name='sdate']").val();
		var edate = $(":text[name='edate']").val();
		var key = $(":text[name='key']").val();
		var type = $("select[name='type']").val();
		var state = $("select[name='state']").val();
		var typekey = $("select[name='typekey']").val();

		if (oid != null && oid != '') {
			 sdate = '';
			$(":text[name='sdate']").val('');
			 edate = '';
			$(":text[name='edate']").val('');
			 key = '';
			$(":text[name='key']").val('');
			 type = '';
			$("select[name='type']").val('');
			 state = '';
			$("select[name='state']").val('');
			typekey='';
			 $("select[name='typekey']").val('');
		}

		loadRouteOrderList(oid, key, type, state,typekey, sdate, edate, "1");
		return false;
	});

	$("#a_delete_route_order_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的运单！");
		} else {
			if (confirm("您是否确认要删除运单信息?")) {
				$.ajax({
					type : "post",
					url : admin_route_order_delete_url,
					data : $.param({
						"oid" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							// $("#nav55").click();
							nav55Click();
						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除运单失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#o_del_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});

	$("#a_route_export_out_link").click(function() {
		$("#main-content").load(admin_route_export_out_page_url);
		return false;
	});
	$("#a_route_export_in_link").click(function() {
		$("#main-content").load(admin_route_export_in_page_url);
		return false;
	});
	$("#a_batch_modify_state_link").click(function() {
		$("#main-content").load(arbms_page_url);
		return false;
	});
}

function loadFirstRouteOrderList() {
	loadRouteOrderList("", "", "", "", "","", "", "1");
}

function loadRouteOrderList(oid, key, type, state,typekey, sdate, edate, pn) {
	$(":hidden[name='oid']").val(oid);
	$(":hidden[name='key']").val(key);
	$(":hidden[name='type']").val(type);
	$(":hidden[name='state']").val(state);
	$(":hidden[name='sdate']").val(sdate);
	$(":hidden[name='edate']").val(edate);
	$(":hidden[name='pn']").val(pn);
	$(":hidden[name='typekey']").val(typekey);

	$.ajax({
		type : "get",
		url : admin_route_list_url,
		data : {
			oid : oid,
			key : key,
			type : type,
			state : state,
			typekey:typekey,
			sd : sdate,
			ed : edate,
			pageIndex : pn
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					showRouteOrderList(null);
					showRouteOrderLink(null);
				} else {
					showRouteOrderList(response.data.datas);
					showRouteOrderLink(response.data);
				}
				afterLoadRouteOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='12'>"
						+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}
	});
}

function showRouteOrderList(list) {
	var str = "";
	$("#tab1 table tbody").html(str);
	if (list != null) {
		var stateStr = '<select   name="newstate"><option value="0">等待审核</option>'
				+ '<option value="1">未付款</option><option value="2">已入库</option><option value="3">送往集散中心</option>'
				+ '<option value="4">集散中心已入库</option><option value="5">送往机场</option><option value="6">空运中</option>'
				+ '<option value="7">海关清关</option><option value="8">目的地第三方快递</option><option value="9">收件人已接收</option></select>';
		var flightStr = '<input name="newflight" type="text" class="text-input" style="width:100px;font-size:12px;"/>';
		var thirdPartyExpressCompany = '<input name="thridcompany"type="text" class="text-input" style="width:100px;font-size:12px;" value='
				+ this.thirdPNS + '/></br>'
		var thirdPartyExpress = '<input name="thridpartyexpress"type="text" class="text-input" style="width:100px;font-size:12px;"value='
				+ this.thirdNo + '/></br>'
		$
				.each(
						list,
						function() {
							str = "<tr id='" + this.id + "' name='"
									+ this.orderId + "'>";
							if (this.state == "9") {
								str += "<td><input type='checkbox' name='del_id' value='"
										+ this.orderId + "'/></td>";
							} else {
								str += "<td>&nbsp;</td>";
							}
							str += '<td><a href="' + this.orderId
									+ '" name="a_order_route_detail_link">'
									+ this.orderId + '</a></td>';
							if((this.user==null)||(this.user=="null")||(this.user=="")||(this.user=="undefined"))
							{
								str += '<td>' + "&nbsp;" + '</td>';
							}
							else
							{
								if((this.user.phone==null)||(this.user.phone=="null")||(this.user.phone=="")||(this.user.phone=="undefined"))
								{
									if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
									{
										str += '<td>' + "&nbsp;" + '</td>';
									}
									else
									{
										str += '<td>' + this.user.email + '</td>';
									}
									
								}
								else
								{
									var tempstr=this.user.phone;
									
									if((this.user.email==null)||(this.user.email=="null")||(this.user.email=="")||(this.user.email=="undefined"))
									{
										
									}
									else
									{
										tempstr=tempstr+"/"+this.user.email;
										
									}
									str += '<td>' + tempstr + '</td>';
								}
								
							}
							
							str += '<td>' + this.cName + '</td>';
							var pm = "";
							$.each(this.details, function() {
								pm += this.xiangqing + ":" + this.quantity
										+ ";";
							});
							// str += '<td title="' + pm + '">' + pm + '</td>';
							str += '<td>' + this.totalMoney + '</td>';
							// str += '<td title="' + this.stateStr + '">' +
							// this.stateStr +'</td>';
						
							/*
									$.each(this.routes, function() {
										pm += this.xiangqing + ":" + this.quantity
												+ ";";
									});
							str += '<td>' + this.stateRemark + '</td>';
							*/
							
							
							
							if (this.state == '9') {
								str += '<td title="' + this.stateStr + '">'
										+ this.stateStr + '</td>';
							} else {
								str += '<td title="' + this.stateStr + '">'
										+ stateStr + '</td>';
							}
							if (this.state == "6" || this.state == "5") {
								str += '<td title="' + this.flight + '">'
										+ flightStr + '</td>';
							} else {
								if (this.flight != null) {
									str += '<td title="' + this.flight + '">'
											+ this.flight + '</td>';
								} else {
									str += '<td>&nbsp;</td>';
								}
							}
							
						
							
							if (this.state == "8" || this.state == "7") {

								// str+='<td title="'+this.thirdNo+'"><input
								// name="thridcompany"type="text"
								// class="text-input"
								// style="width:100px;font-size:12px;"value="'+this.thirdPNS
								// +'"/></br>'
								// +'<input name="thridpartyexpress"type="text"
								// class="text-input"
								// style="width:100px;font-size:12px;"value="'+this.thirdNo
								// +'"/></td>';

									if((this.thirdPNS==null||this.thirdPNS=="null"||this.thirdPNS=="")||(this.thirdNo==null||this.thirdNo=="null"||this.thirdNo==""))
									{
										str += '<td ><input name="thridcompany" type="text" value="'
												+ this.thirdPNS
												+ '" /><br><input name="thridpartyexpress" type="text" value="'
												+ this.thirdNo + '" /></td>';
									}
									else
									{
										str += '<td >快递代码:'+ this.thirdPNS+'<br><input name="thridcompany" type="text" value="'
											+ this.thirdPNS
											+ '" /><br>快递号：'+this.thirdNo+'<br><input name="thridpartyexpress" type="text" value="'
											+ this.thirdNo + '" /></td>';
									}
							} else {
								if (this.thirdPNS != null
										&& this.thirdNo != null) {
									str += '<td title="' + this.thirdNo + '">'
											+ this.thirdPNS + '</br>'
											+ this.thirdNo + '</td>';
								}
							}
							if (this.state == "9") {
								str += '<td>&nbsp;</td>';
							} else {
								str += '<td><input type="button" class="button" value="修改" name="modify_state_bt"/></td>';
							}
							str += "<td>" + this.createDate + "</td>";
							if (this.state > 2) {
								str += "<td id="
										+ this.orderId
										+ "><a href='#' name='a_print_link'>热敏(4x6)</a> | <a href='#' name='a_print_a4_link'>A4打印</a></td>";
							} else {
								str += "<td>&nbsp;</td>";
							}
							str += "</tr>";
							$("#tab1 table tbody").append(str);
							$("#" + this.id).find("select[name='newstate']")
									.val(this.state);
							$("#" + this.id).find(":text[name='newflight']")
									.val(this.flight);
							$("#" + this.id).find(":text[name='thridcompany']")
									.val(this.third_pns);
							$("#" + this.id).find(
									":text[name='thridpartyexpress']").val(
									this.third_no);
							$("#" + this.id)
									.find("a[name='a_print_link']")
									.click(
											function() {
												var id = $(this).parent()
														.parent().attr("id");
												var orderId = $(this).parent()
														.attr("id");
												var url = admin_print_page_url
														+ "?id=" + id
														+ "&orderId=" + orderId;
												$("#my_print_div").load(url);
												return false;
											});
							
							$("#" + this.id)
							.find("a[name='a_print_a4_link']")
							.click(
									function() {
										var id = $(this).parent()
												.parent().attr("id");
										var orderId = $(this).parent()
												.attr("id");
										var url = admin_print_A4_page_url
												+ "?id=" + id
												+ "&orderId=" + orderId;
										$("#my_print_div").load(url);
										return false;
									});

							$("#" + this.id)
									.find(":button[name='modify_state_bt']")
									.click(
											function() {
												var el = $(this).parent()
														.parent();
												var state = el
														.find(
																"select[name='newstate']")
														.first().val();
												var id = el.attr("name");
												var flight = el
														.find(
																":text[name='newflight']")
														.val();
												var thridpns = el
														.find(
																":text[name='thridcompany']")
														.val();
												var thridno = el
														.find(
																":text[name='thridpartyexpress']")
														.val();
												if (typeof (flight) == 'undefined') {
													flight = '';
												}
												$
														.ajax({
															type : "post",
															url : admin_route_modify_state_url,
															data : {
																orderId : id,
																state : state,
																flight : flight,
																thridpns : thridpns,
																thridno : thridno
															},

															success : function(
																	response) {
																var code = response.code;
																if (code == "200") {
																	alert("修改运单状态成功");
																	nav55Click();
																} else {
																	alert("修改运单状态失败，失败原因是："
																			+ response.message);
																}
																$("#nav55")
																		.click();
															}
														});

												return false;
											});
						});
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='12'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的运单信息!</span></td>";
		}
		$("#tab1 table tbody").html(str);
	}
}

function showRouteOrderLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			var key = $(":hidden[name='key']").val();
			var type = $(":hidden[name='type']").val();
			var state = $(":hidden[name='state']").val();
			var sdate = $(":hidden[name='sdate']").val();
			var edate = $(":hidden[name='edate']").val();
			var typekey=$(":hidden[name='typekey']").val();
			
			loadRouteOrderList("", key, type, state,typekey, sdate, edate, pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					var key = $(":hidden[name='key']").val();
					var type = $(":hidden[name='type']").val();
					var state = $(":hidden[name='state']").val();
					var sdate = $(":hidden[name='sdate']").val();
					var edate = $(":hidden[name='edate']").val();
					var typekey=$(":hidden[name='typekey']").val();
					loadRouteOrderList("", key, type, state,typekey, sdate, edate, pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadRouteOrderList() {
	$("a[name='a_order_route_detail_link']").click(function() {
		var oid = $(this).attr("href");
		var url = admin_route_order_detail_page_url + "?oid=" + oid;
		$("#main-content").load(url);
		return false;
	});
}

// /////////////////////////////////////////////////
function loadNav551Data() {
	$("#a_back_route_list_link").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */
		// $("#nav55").click();
		nav55Click();
		return false;
	});
}
// ////////////////////////////////////////////////////
function loadNav552Data() {
	$("#a_back_route_list_link").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */
		// $("#nav55").click();
		nav55Click();
		return false;
	});

	$("#import_order_state_bt").click(function() {
		$("#import_weiyistate_form").ajaxSubmit({
			type : 'post',
			timeout : 600000,
			//url : admin_import_order_state_url,
			url : admin_import_order_weiyi_state_url,
			success : function(data) {
				//alert(data);
				//alert(data.code);
				
				
				$("#tmpmsgdiv").html('' + data);
				var str = $("#tmpmsgdiv pre").html();
				var obj = $.parseJSON(str);
				var code = obj.code;
				if (code == "200") {
					alert("操作完成");
					// $("#nav55").click();
					nav55Click();
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("导入运单失败，原因是:" + obj.message);
				}
				return false;
				
				
			
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}
		});
		return false;
	});
	
	
	
	$("#import_order_state_seatax1_bt").click(function() {
		$("#import_seantax_state_form1").ajaxSubmit({
			type : 'post',
			timeout : 600000,
			//url : admin_import_order_state_url,
			url : "../admin/order/import_order_to_seatax1",
			success : function(data) {
				//alert(data);
				//alert(data.code);
				
				
				$("#tmpmsgdiv").html('' + data);
				var str = $("#tmpmsgdiv pre").html();
				var obj = $.parseJSON(str);
				var code = obj.code;
				if (code == "200") {
					alert("操作完成");
					// $("#nav55").click();
					nav55Click();
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("导入运单失败，原因是:" + obj.message);
				}
				return false;
				
				
			
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}
		});
		return false;
	});
	
	$("#import_order_state_seatax2_bt").click(function() {
		$("#import_seantax_state_form2").ajaxSubmit({
			type : 'post',
			timeout : 600000,
			//url : admin_import_order_state_url,
			url : "../admin/order/import_order_to_seatax2",
			success : function(data) {
				//alert(data);
				//alert(data.code);
				
				
				$("#tmpmsgdiv").html('' + data);
				var str = $("#tmpmsgdiv pre").html();
				var obj = $.parseJSON(str);
				var code = obj.code;
				if (code == "200") {
					alert("操作完成");
					// $("#nav55").click();
					nav55Click();
				} else if (code == "607") {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("导入运单失败，原因是:" + obj.message);
				}
				return false;
				
				
			
			},
			error : function(XmlHttpRequest, textStatus, errorThrown) {
				alert("操作失败");
				return false;
			}
		});
		return false;
	});
}

// ////////////////////////////////////////////////////////////////
function loadNav553Data() {
	$("#a_back_route_list_link").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */
		// $("#nav55").click();
		nav55Click();
		return false;
	});

	
	
	
	
	
	var oid = $(":hidden[name='oid']").val();
	$
			.ajax({
				type : "get",
				url : admin_order_route_search_url,
				data : {
					"oid" : oid
				},
				success : function(response) {
					var code = response.code;
					if (code == "200" && response.data != null) {
						str = "<table><col width='100px'/><col width='120px'/><col width='200px'/><tr><th>状态</th><th>状态说明</th><th>时间</th><th>备注</th></tr>";
						for ( var key in response.data) {
							var value = response.data[key];
							$.each(value, function() {
								str += "<tr>";
								str += "<td>" +this.state  + "</td>";
								str += "<td>" + this.stateRemark + "</td>";
								str += "<td>" + this.date + "</td>";
								str += "<td>" + this.remark + "</td>";
								str += "</tr>";
							});
						}
						str += "</table>";
						$("#route_info").html(str);
					} else {
					}
				}
			});

	$.ajax({
		type : "get",
		url : admin_order_get_one_url,
		data : {
			"oid" : oid
		},
		success : function(response) {
			var code = response.code;
			if (code == "200" && response.data != null) {
				var str = "";
				if((response.data.user!=null)&&(response.data.user!="null")&&(response.data.user!="")&&(response.data.user!="undefined"))
				{
					str += response.data.user.id;
					str += "&nbsp;&nbsp;";
					str += response.data.user.nickName;
					str += "&nbsp;&nbsp;";
					str += response.data.user.realName;
					str += "&nbsp;&nbsp;";
					str += response.data.user.phone;
					
					
					$("#from_user_info").html(str);
				}
				else
				{
					
					str += response.data.senduserName;
					str += "&nbsp;&nbsp;";
					str += response.data.senduserphone;
					str=str+"<br>&nbsp;&nbsp;";
					str=str+"发件人地址:"+response.data.senduserAddress;
					str=str+"&nbsp;&nbsp;";
					str=str+response.data.senduserCity;
					str=str+"&nbsp;&nbsp;";
					str=str+response.data.senduserState;
					str=str+"&nbsp;&nbsp;";
					str=str+response.data.senduserZipcode;
					$("#from_user_info").html(str);
				}
				str = "";
				str += response.data.cName;
				str += "&nbsp;&nbsp;";
				str += response.data.cPhone;
				str += "&nbsp;&nbsp;";
				str += response.data.cZipCode;
				str += "&nbsp;&nbsp;&nbsp;";
				str += response.data.cProvince;
				str += "&nbsp;&nbsp;";
				str += response.data.cCity;
				str += "&nbsp;&nbsp;";
				str += response.data.cDistrict;
				str += "&nbsp;&nbsp;";
				str += response.data.cStreetAddress;
				$("#to_user_info").html(str);

				str = "";
				var str1="";
				if((response.data.commodityThirdList!=null)&&(response.data.commodityThirdList!="undefined")&&(response.data.type=="7"))
				{
					str=response.data.commodityThirdList;
					str1=response.data.thirdBrands;
					
				}
				else
				{
					$.each(response.data.details, function() {
						str += this.ctype + ":" + this.quantity + ";";
					});
				}
				$("#commodify_info").html(str);
				$("#commodify_brands").html(str1);

				str = "";
				str += "重量(lb):" + response.data.weight;
				str += "&nbsp;&nbsp;重量(KG):" + response.data.weightKg;
				str += "&nbsp;&nbsp;关税:" + response.data.tariff;
				str += "&nbsp;&nbsp;OR:" + response.data.or;
				str += "&nbsp;&nbsp;其他费用:" + response.data.other;
				str += "&nbsp;&nbsp;保险金:" + response.data.premium;
				
				if((response.data.commodityThirdList!=null)&&(response.data.commodityThirdList!="undefined")&&(response.data.type=="7"))
				{
					str += "&nbsp;&nbsp;基本费用:" + response.data.baseMoney;
				}
				str += "&nbsp;&nbsp;总费用：" + response.data.totalMoney;
				$("#money_info").html(str);
				
				str="";
				
				if((response.data.commodityThirdList!=null)&&(response.data.commodityThirdList!="undefined")&&(response.data.type=="7"))
				{
					str="收件日期："+response.data.thirdCreateDate+"&nbsp;&nbsp;"+"航班号："+response.data.flight+"&nbsp;&nbsp;"+"装箱号："+response.data.boxNo
					+"&nbsp;&nbsp;"+"是否付款:";
					if(response.data.payOrNot=="1")//已付
					{
						str=str+"已付";
					}
					else if(response.data.payOrNot=="0")
					{
						str=str+"未付";
					}
					else
					{
						str=str+"不确定("+response.data.payOrNot+")";
					}
					
					str=str+"&nbsp;&nbsp;";
					str=str+"发件人:"+response.data.senduserName;
					str=str+"&nbsp;&nbsp;";
					str=str+"快递公司:"+response.data.expressName;
					str=str+"&nbsp;&nbsp;";
					str=str+"收件人拼音:"+response.data.NamePinyi;
					str=str+"&nbsp;&nbsp;";
					str=str+"是否有身份证:"+response.data.cardOrNot;
					str=str+"&nbsp;&nbsp;";
					str=str+"导入备注:"+response.data.importRemark;
					
					
				
					
					$("#otherall_info").html(str);
				}
				else
				{
					str="航班号："+response.data.flight;
					str=str+"&nbsp;&nbsp;";
					str=str+"快递公司:"+response.data.expressName;
					str=str+"&nbsp;&nbsp;";
					str=str+"收件人拼音:"+response.data.NamePinyi;
					

					
					$("#otherall_info").html(str);
				}
				$("#otherall_info").html(response.data.remark);
				
				if(response.data.type=="7")
				{
					$("#u_ordertype").html("第三方运单");
				}
				else
				{
					$("#u_ordertype").html("系统运单");
				}
				
				
				str = "";
				if (response.data.mail == "0") {
					str = "邮包";
				} else if (response.data.mail == "1") {
					str = "电商";
				} else if (response.data.mail == "2") {
					str = "快件";
				} else {
					str = this.mail;
				}
				$("#mail_info").html(str);

			} else {
				alert("获取运单详细信息失败，原因是:" + response.message);
			}
		}
	});
}


function getorderstate(no)
{

	alert(no);
	var str="";
	if(no=="-10")
	{
		str="网上置单";
	}
	else if(no=="0")
	{
		str="等待审核";
	}
	else if(no=="1")
	{
		str="未付款";
	}
	else if(no=="2")
	{
		str="已入库";
	}
	else if(no=="3")
	{
		str="送往集散中心";
	}
	else if(no=="4")
	{
		str="集散中心已入库";
	}
	else if(no=="5")
	{
		str="送往机场";
	}
	else if(no=="6")
	{
		str="空运中";
	}
	else if(no=="7")
	{
		str="海关清关";
	}
	else if(no=="8")
	{
		str="目的地第三方快递";
	}
	else if(no=="9")
	{
		str="收件人已接收";
	}
	else if(no=="-1")
	{
		str="未定";
	}
	else
	{
		str="未知";
	}
	return str;
}





function loadNav554Data() {
	$("select[name='oldState']").val("");
	$(":text[name='oldFlight']").val("");
	$("select[name='newState']").val("");
	$(":text[name='newFlight']").val("");
	$("div[name='modify_state_div554']").hide();

	$("a[name='a_clean_input_link']").click(
			function() {
				$("select[name='oldState']").val("");
				$(":text[name='oldFlight']").val("");
				$("select[name='newState']").val("");
				$(":text[name='newFlight']").val("");
				$('#o_batch_order_check_all').removeAttr("checked");
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;请先获取要修改的数据，在提交修改信息!</span></td>";
				$("#tab1 table tbody").html(info);
				$("div[name='modify_state_div554']").hide();
				$("#batch_order_info554").html("&nbsp;");
				return false;
			});

	$("#a_back_route_list_link_554").click(function() {
		/*
		 * if (!$("#nav5").hasClass("current")) { $("#nav5").click(); }
		 */
		// $("#nav55").click();
		nav55Click();
		return false;
	});

	$("#o_batch_order_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="modify_id"]').attr("checked", 'true');
		} else {
			$('input[name="modify_id"]').removeAttr("checked");
		}
	});

	$(":button[name='searchBt554']")
			.click(
					function() {
						var state = $("select[name='oldState']").val();
						var flight = $(":text[name='oldFlight']").val();
						if (flight != null && flight != '') {
							// 如果有航班信息，那么状态必须为空运中
							state = "6";
							$("select[name='oldState'] option[value='6']")
									.attr("selected", true);
						}
						$("div[name='modify_state_div554']").hide();
						$
								.ajax({
									type : "get",
									url : arbms_url,
									data : {
										state : state,
										flight : flight
									},
									success : function(response) {
										var code = response.code;
										if ("200" == code) {
											showBatchRouteOrderList(response.data);
										} else if ("607" == code) {
											alert("您尚未登录或登录已失效！");
											logout();
										} else {
											var info = "<td style='text-align: left;' colspan='8'>"
													+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
											$("#tab1 table tbody").html(info);
										}
										return false;
									}
								});
						return false;
					});

	$(":button[name='modifyBt554']")
			.click(
					function() {
						var chk_value = [];
						var id_arr = [];
						$('input[name="modify_id"]:checked').each(function() {
							chk_value.push($(this).val());
							id_arr.push($(this).attr("id"));
						});
						if (chk_value.length == 0) {
							alert("您还没有选择要修改的运单！");
						} else {
							var state = $("select[name='newState']").val();
							var flight = $(":text[name='newFlight']").val();
							if (flight != null && flight != '') {
								// 如果有航班信息，那么状态必须为空运中
								state = "6";
								$("select[name='newState'] option[value='6']")
										.attr("selected", true);
							}

							var msg = "您是否确认修改运单信息？";
							if (state == "6"
									&& (flight == null || flight == '')) {
								msg = "您修改运单状态为空运中，但是没有给定对应的航班信息，是否确认修改？";
							}

							if (confirm(msg)) {
								$(":button[name='modifyBt554']").attr(
										"disabled", true);
								$.ajax({
									type : "post",
									url : arbmm_url,
									data : $.param({
										"oid" : chk_value,
										"state" : state,
										"flight" : flight
									}, true),
									success : function(response) {
										$(":button[name='modifyBt554']").attr(
												"disabled", false);
										var code = response.code;
										if ("200" == code) {
											alert("修改状态成功");
										} else if ("607" == code) {
											alert("您尚未登录或登录已失效！");
											logout();
										} else {
											alert("修改状态失败，原因是:"
													+ response.message);
										}
										// 重新加载原来的信息
										afterBatchModifyOrderState(id_arr,
												state, flight);
										return false;
									}
								});
							}
						}
						return false;
					});
}

function showBatchRouteOrderList(list) {
	if (list != null && list.length > 0) {
		$("div[name='modify_state_div554']").show();
		$("#tab1 table tbody").html('');
		var count = 0;
		$.each(list, function() {
			count = count + 1;
			str = "<tr>";
			str += "<td><input type='checkbox' name='modify_id' id='" + this.id
					+ "' value='" + this.orderId + "'/></td>";
			str += '<td>' + this.orderId + '</td>';
			str += '<td>' + this.user.nickName + '</td>';
			str += '<td>' + this.cName + '</td>';
			var pm = "";
			$.each(this.details, function() {
				pm += this.ctype + ":" + this.quantity + ";";
			});
			str += '<td title="' + pm + '">' + pm + '</td>';
			str += '<td>' + this.totalMoney + '</td>';
			str += '<td title="' + this.stateStr + '">' + this.stateStr
					+ '</td>';
			if (this.flight != null) {
				str += '<td title="' + this.flight + '">' + this.flight
						+ '</td>';
			} else {
				str += '<td>&nbsp;</td>';
			}
			str += "</tr>";
			$("#tab1 table tbody").append(str);
		});
		$("#batch_order_info554").html("总共：" + count + "条运单数据");
	} else {
		var info = "<td style='text-align: left;' colspan='8'>"
				+ "<span>&nbsp;&nbsp;对不起，没有符合您要求的运单数据!</span></td>";
		$("#batch_order_info554").html("总共：0条运单数据");
		$("#tab1 table tbody").html(info);
	}
}

function afterBatchModifyOrderState(arrs, state, flight) {
	// 重新加载
	$("div[name='modify_state_div554']").hide();
	$('#o_batch_order_check_all').removeAttr("checked");
	$("select[name='oldState'] option[value='" + state + "']").attr("selected",
			true);
	$(":text[name='oldFlight']").val(flight);
	$("select[name='newState']").val("");
	$(":text[name='newFlight']").val("");
	$.ajax({
		type : "get",
		url : admin_order_search_by_ids_url,
		data : $.param({
			"id" : arrs
		}, true),
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				showBatchRouteOrderList(response.data);
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}
	});
}

function loadNav56Data() {
	showRetailOrderCount();
	showRetailOrder("", "");

	// 文件导入
	$("#bt_import_rlorder").click(function() {
		var file = $("#import_form :file[name='file']").val();
		if (file != null && file != '') {
			$("#import_form").ajaxSubmit({
				type : 'post',
				url : admin_retail_order_import_url,
				success : function(data) {
					$("#tmpmsgdiv").html('' + data);
					var str = $("#tmpmsgdiv pre").html();
					var obj = $.parseJSON(str);
					var code = obj.code;
					if (code == "200") {
						alert("导入成功");
						// $("#nav56").click();
						nav56Click();
					} else if (code == "607") {
						alert("您尚未登录或登录已失效！");
						logout();
					} else {
						alert("导入运单失败，原因是:" + obj.message);
					}
					return false;
				},
				error : function(XmlHttpRequest, textStatus, errorThrown) {
					alert("导入运单请求失败！");
					return false;
				}
			});
		} else {
			alert("请选择要导入的文件！");
		}
		return false;
	});

	// 旧运单查询
	$("#bt_old_empty_order").click(function() {
		var soid = $(":text[name='soid']").val();
		var eoid = $(":text[name='eoid']").val();
		showRetailOrder(soid, eoid);
		return false;
	});

	// 打印旧运单
	$("#bt_batch_print_old_empty_order").click(function() {
		var chk_value = [];
		$('input[name="retail_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("请选择要打印的运单！不知道要打印什么运单！");
		} else {
			$(":hidden[name='print_retail_e_oid']").val(chk_value);
			var url = admin_print_empty_order_page_url;
			$("#my_print_div").load(url);
		}
		return false;
	});

	// 删除旧运单
	$("#bt_batch_delete_old_empty_order").click(function() {
		var chk_value = [];
		$('input[name="retail_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("请选择要删除的运单！");
		} else {
			if (confirm("您是否确认要删除空运单信息?")) {
				deleteRetailOrder(chk_value);
			}
		}
		return false;
	});

	// 导出新运单
	// $("#bt_export_output_empty_order").click(function(){
	// alert("你好");
	// $(this).attr("disabled",true);
	// return true;
	// });

	// 打印新运单
	$("#bt_batch_print_empty_order").click(function() {
		$(this).attr("disabled", true);
		var size = $(":text[name='size']").val();
		if (/^([1-9]\d{0,2})|([1-9]\d?)$/.test(size)) {
			$.ajax({
				type : "post",
				url : admin_retail_order_create_url,
				data : {
					"size" : size
				},
				success : function(response) {
					var code = response.code;
					if ("200" == code) {
						var list = response.data;
						var oid = [];
						$.each(list, function() {
							oid.push(this["orderId"]);
						});
						$(":hidden[name='print_retail_e_oid']").val(oid);
						var url = admin_print_empty_order_page_url;
						$("#my_print_div").load(url);
						showRetailOrderCount();
					} else if ("607" == code) {
						alert("您尚未登录或登录已失效！");
						logout();
					} else {
						alert("创建空运单失败，原因是：" + response.message);
					}
					$("#bt_batch_print_empty_order").attr("disabled", false);
					return false;
				}
			});
		} else {
			alert("打印数量输入错误，一次只能打印1到500个空运单，请重新输入！");
			$(":text[name='size']").val('');
			$(":text[name='size']").focus();
			$(this).attr("disabled", false);
		}
		return false;
	});
}

function showRetailOrderCount() {
	$.ajax({
		type : "get",
		url : admin_retail_order_count_url,
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				var count = response.data["count"];
				$("strong[name='count_rlorder']").html(count);
			} else if ("607" == code) {
				// alert("您没有权限进行此操作，请重新登录!");
				// logout();
			} else {
				alert("获取空运单数目失败，原因是：" + response.message);
			}
			return false;
		}
	});
}

function showRetailOrder(soid, eoid) {
	$.ajax({
		type : "get",
		url : admin_retail_order_get_url,
		data : {
			"soid" : soid,
			"eoid" : eoid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				showRetailOrderList(response.data);
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("获取空运单数据失败，原因是：" + response.message);
			}
			return false;
		}
	});
}

function showRetailOrderList(list) {
	$("#show_div")
			.html(
					'<table id="r_o_table" style="width:100%"><col width="85"><col><col width="100px"><thead><tr><th><label><input type="checkbox" name="ro_check_all" id="ro_check_all">全选</label></th><th id="o_id">运单号</th><th>操作</th></tr></thead><tbody><tr><td style="text-align:left" colspan="3"><span>&nbsp;&nbsp;对不起，现在还没有空运单信息!</span></td></tr></tbody></table>');
	$("#ro_check_all").removeAttr("checked");
	$("#ro_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="retail_id"]').attr("checked", 'true');
		} else {
			$('input[name="retail_id"]').removeAttr("checked");
		}
	});
	if (list != null && list.length > 0) {
		$("#bt_batch_delete_old_empty_order").removeClass('displaynone');
		$("#bt_batch_print_old_empty_order").removeClass('displaynone');
		var el = $("#r_o_table tbody");
		el.html("");
		var str = '';
		var orderId = '';
		$.each(list, function() {
			orderId = this["orderId"];
			str = "<tr>";
			str += "<td><input type='checkbox' name='retail_id' value='"
					+ orderId + "'/></td>";
			str += "<td>" + orderId + "</td>";
			str += "<td><a href='" + orderId
					+ "' name='a_delete_ro_link'>删除</a></td>";
			str += "</tr>";
			el.append(str);
		});

		el.find("a[name='a_delete_ro_link']").click(function() {
			if (confirm("您是否确认要删除空运单信息?")) {
				var orderId = $(this).attr("href");
				var chk_value = [];
				chk_value.push(orderId);
				deleteRetailOrder(chk_value);
			}
			return false;
		});
	} else {
		$("#bt_batch_delete_old_empty_order").addClass('displaynone');
		$("#bt_batch_print_old_empty_order").addClass('displaynone');
		var info = "<td style='text-align: left;' colspan='3'>"
				+ "<span>&nbsp;&nbsp;对不起，没有符合您要求的空运单数据!</span></td>";
		$("#r_o_table tbody").html(info);
	}
}

function deleteRetailOrder(arr) {
	$.ajax({
		type : "post",
		url : admin_retail_order_delete_url,
		data : $.param({
			"oid" : arr,
		}, true),
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				alert("删除成功");
				// $("#nav56").click();
				nav56Click();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("删除运单失败，原因是:" + response.message);
			}
			return false;
		}
	});
}

function loadNav57Data() {
	loadFirstWszjOrderList();

	$(":submit[name='searchSub']").click(function() {
		var oid = $(":text[name='search_order_no']").val();
		if (oid == null || oid == '') {
			alert("请输入运单号");
			return false;
		}

		loadWszjOrderList(oid, "1");

		return false;
	});

	$("#a_delete_order_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的运单！");
		} else {
			if (confirm("您是否确认要删除运单信息?")) {
				$.ajax({
					type : "post",
					url : admin_detail_order_delete_url,
					data : $.param({
						"oid" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							$("#nav52").click();

						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除运单失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#o_del_check_all").click(function() {

		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});
}

function loadFirstWszjOrderList() {
	loadWszjOrderList("", "1");
}

function loadWszjOrderList(oid, pn) {

	$(":hidden[name='pn']").val(pn);

	$.ajax({
		type : "get",
		url : admin_order_list_url,
		data : {
			oid : oid,
			pageIndex : pn
		},
		success : function(response) {
			var code = response.code;

			if ("200" == code) {
				if (response.data == null) {
					showWhzjOrderList(null);
					showWhzjOrderLink(null);
				} else {

					showWhzjOrderList(response.data.datas);
					showWhzjOrderLink(response.data);
				}
				afterLoadWhzjOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='8'>"
						+ "<span>&nbsp;&nbsp;获取运单列表信息失败!</span></td>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}

	});
}

function showWhzjOrderList(list) {

	var str = "";
	if (list != null) {

		$.each(list, function() {

			str += "<tr id='" + this.id + "'>";
			if (this.state == "0") {
				str += "<td><input type='checkbox' name='del_id' value='"
						+ this.orderId + "'/></td>";
			} else {
				str += "<td>&nbsp;</td>";
			}
			str += "<td >" + this.orderId + "</td>";
			var tc = "";

			/*
			 * $.each(this.id, function(){
			 * 
			 * tc += this; });
			 */

			str += "<td>" + this.warehouseId + "</td>";
			str += "<td>" + this.user.email + "</td>";
			str += "<td>" + this.cName + "</td>";
			str += "<td>" + this.stateStr + "</td>";
			str += "<td>" + this.createDate + "</td>";
			if (this.state == "0" || this.state == "1") {
				str += "<td><a href='" + this.orderId
						+ "' name='a_order_modify_link'>修改</a></td>";
			} else {
				str += "<td id='" + this.orderId + "'><a href='" + this.orderId
						+ "' name='a_order_print_a4_link'>A4打印</a> | <a href='" + this.orderId
						+ "' name='a_order_print_link'>热敏(4x6)</a></td>";
			}
			str += "</tr>";
		});

	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='8'>"
					+ "<span>&nbsp;&nbsp;没有符合您查找要求的运单信息!</span></td>";
		}
	}

	$("#tab1 table tbody").html(str);
}

function showWhzjOrderLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");

			loadWszjOrderList("", pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					loadOrderList("", pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadWhzjOrderList() {
	$("a[name='a_order_modify_link']").click(function() {
		var id = $(this).attr("href");
		var url = admin_order_modify_page_url + "?orderId=" + id;
		$("#main-content").load(url);
		return false;
	});

	$("a[name='a_order_print_link']").click(function() {

		var id = $(this).parent().parent().attr("id");
		var orderId = $(this).parent().attr("id");

		var url = admin_print_page_url + "?id=" + id + "&orderId=" + orderId;

		$("#my_print_div").load(url);
		return false;
	});
	$("a[name='a_order_print_a4_link']").click(function() {

		var id = $(this).parent().parent().attr("id");
		var orderId = $(this).parent().attr("id");

		var url = admin_print_A4_page_url + "?id=" + id + "&orderId=" + orderId;

		$("#my_print_div").load(url);
		return false;
	});
	
}

// ////////////////////////
function loadNav58Data() {
	loadCallOrderList();
}
function loadCallOrderList() {
	$.ajax({
		type : "get",
		url : admin_call_order_list_url,

		success : function(response) {
			var code = response.code;

			if ("200" == code) {
				if (response.data == null) {
					showCallOrderList(null);
				} else {

					showCallOrderList(response.data);
				}
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<tr><td style='text-align: left;' colspan='10'>"
						+ "<span>&nbsp;&nbsp;上门取件列表信息失败!</span></td></tr>";
				$("#tab1 table tbody").html(info);
			}
			return false;
		}

	});
}

function showCallOrderList(list) {

	var str = "";
	if (list != null) {

		$
				.each(
						list,
						function() {

							str += "<tr id='" + this.id + "'>";
							str += "<td >" + this.sName + "</td>";
							str += "<td >" + this.sProvince + "</td>";
							str += "<td >" + this.sStreetAddress + "</td>";
							str += "<td >" + this.sZipCode + "</td>";
							str += "<td >" + this.sPhone + "</td>";
							str += "<td >" + this.quantity + "</td>";
							str += "<td >" + this.weight + "</td>";
							str += "<td >" + this.createDate + "</td>";
							str += "<td >" + this.modifyDate + "</td>";
							
							if (this.state == "1") {
								str += "<td ><select id='state_"
										+ this.id
										+ "' onchange='callmodifychange("+this.id+")'><option value='1' selected>还没处理</option><option value='2'>处理中</option><option value='3'>处理完成</option></select></td>";
							} else if (this.state == "2") {
								str += "<td ><select id='state_"
										+ this.id
										+ "' onchange='callmodifychange("+this.id+")'><option value='1' >还没处理</option><option value='2' selected>处理中</option><option value='3'>处理完成</option></select></td>";
							} else if (this.state == "3") {
								str += "<td ><select id='state_"
										+ this.id
										+ "' onchange='callmodifychange("+this.id+")'><option value='1' >还没处理</option><option value='2'>处理中</option><option value='3' selected>处理完成</option></select></td>";
							}
							// $("#state_"+this.id).val(this.state);
							str += "</tr>";
						});

	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='9'>"
					+ "<span>&nbsp;&nbsp;没有上门取件信息!</span></td>";
		}
	}

	$("#tab1 table tbody").html(str);
}

function callmodifychange(id)
{
	var str="state_"+id;
	var state=$("#"+str).val();
	//alert(id);
	$.ajax({
		type : "post",
		url : admin_call_order_modify_url,
		data : {
			id : id,
			state : state
		},
		success : function(response) {
			var code = response.code;
			if (code == "200") {
				alert("修改成功");
				nav58Click();
			} else if (code == "607") {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("修改失败，失败原因是:" + response.message);
			}
		}
	});
}

// ////////////////////////////////////////////////////////
function loadNav59Data() {
	$(":button[name='searchSub']").click(function() {
		var oid = $(":text[name='search_order_no']").val();
		if (oid == null || oid == '') {
			alert("请输入运单号");
			return false;
		}
		loadEmptyOrderList(oid, "1");
		return false;
	});
	loadEmptyOrderList(null, "1");
	$("#a_add_empty_order_link").click(function() {
		$.ajax({
			type : "post",
			url : admin_empty_order_add_url,
			success : function(response) {
				var code = response.code;
				if ("200" == code) {
					alert("添加空运单成功，运单号是：" + response.data["orderId"]);
					nav59Click();
				} else if ("607" == code) {
					alert("您尚未登录或登录已失效！");
					logout();
				} else {
					alert("添加空运单失败，原因是:" + response.message);
				}
				return false;
			}

		});
		return false;
	});

	$("#a_delete_order_link").click(function() {
		var chk_value = [];
		$('input[name="del_id"]:checked').each(function() {
			chk_value.push($(this).val());
		});
		if (chk_value.length == 0) {
			alert("您还没有选择要删除的空运单！");
		} else {
			if (confirm("您是否确认要删除空运单信息?删除的运单是无法找回的！")) {
				$.ajax({
					type : "post",
					url : admin_empty_order_delete_url,
					data : $.param({
						"oid" : chk_value,
					}, true),
					success : function(response) {
						var code = response.code;
						if ("200" == code) {
							alert("删除成功");
							// $("#nav54").click();
							nav59Click()
						} else if ("607" == code) {
							alert("您尚未登录或登录已失效！");
							logout();
						} else {
							alert("删除转运单失败，原因是:" + response.message);
						}
						return false;
					}
				});
			}
		}
		return false;
	});

	$("#o_del_check_all").click(function() {
		if ($(this).is(':checked')) {
			$('input[name="del_id"]').attr("checked", 'true');
		} else {
			$('input[name="del_id"]').removeAttr("checked");
		}
	});

}

function loadEmptyOrderList(key, pn) {
	$(":hidden[name='key']").val(key);
	$.ajax({
		type : "get",
		url : admin_empty_order_list_url,
		data : {
			"key" : key,
			"pageIndex" : pn
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					showEmptyOrderList(null);
					showEmptyOrderLink(null);
				} else {
					showEmptyOrderList(response.data.datas);
					showEmptyOrderLink(response.data);
				}
				afterLoadEmptyOrderList();
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				var info = "<td style='text-align: left;' colspan='5'>"
						+ "<span>&nbsp;&nbsp;门店空运单列表信息失败,!</span></td>";
				$("#tab1 table tbody").html(info);
			}
		}
	});
}

function showEmptyOrderList(list) {
	var str = "";
	if (list != null) {
		$
				.each(
						list,
						function() {
							str += '<tr id="' + this.id + '">';
							str += '<td><input type="checkbox" name="del_id" value="'
									+ this.orderId + '"/></td>';
							str += '<td>' + this.orderId + '</td>';
							str += '<td>' + this.stateStr + '</td>';
							str += '<td>' + this.createDate + '</td>';

							str += '<td id='
									+ this.orderId
									+ '><a href="" name="a_modify_link">修改</a>&nbsp;&nbsp;<a href="" name="a_print_link">打印</a></td></tr>';
						});
	} else {
		if (str == null || str == '') {
			str = "<td style='text-align: left;' colspan='5'>"
					+ "<span>&nbsp;&nbsp;对不起，没有您门店的空运单数据!</span></td>";
		}
	}
	$("#tab1 table tbody").html(str);
}
function showEmptyOrderLink(pageSplit) {
	if (pageSplit != null) {
		var rowCount = pageSplit.rowCount;
		var pageSize = pageSplit.pageSize;
		var pageNow = pageSplit.pageNow;
		var pageCount = pageSplit.pageCount;
		$("tfoot .bulk-actions").show();
		$("tfoot .pagination")
				.html(
						createPaginationHtmlStr(rowCount, pageSize, pageNow,
								pageCount));

		$("tfoot .pagination a").click(function() {
			var pn = $(this).attr("href");
			var key = $(":hidden[name='key']").val();
			loadEmptyOrderList(key, pn);
			return false;
		});

		$("tfoot .pagination input").keydown(function(event) {
			if (event.which == 13) {
				var pn = $(this).val();
				if (/^\d*$/.test(pn)) {
					var key = $(":hidden[name='key']").val();
					loadEmptyOrderList(key, pn);
				} else {
					alert("只能输入数字");
				}
				$(this).blur();
			}
		});
	} else {
		$("tfoot .bulk-actions").hide();
		$("tfoot .pagination").html("");
	}
}

function afterLoadEmptyOrderList() {
	$("a[name='a_modify_link']").click(
			function() {
				var id = $(this).parent().parent().attr("id");
				var orderId = $(this).parent().attr("id");
				var url = admin_empty_order_modify_page_url + "?id=" + id
						+ "&oid=" + orderId;
				$("#main-content").load(url);
				return false;
			});

	$("a[name='a_print_link']").click(
			function() {
				var id = $(this).parent().parent().attr("id");
				var orderId = $(this).parent().attr("id");
				var url = admin_print_empty_order_page_url + "?id=" + id
						+ "&orderId=" + orderId;
				$("#my_print_div").load(url);
				return false;
			});
}

// ///////////////////////////////////////////////////////////



function loadNav591Data() {
	// 设置点击跳转的事件
	getglobalargs_commrate();
	$("#sjdztable tfoot a").click(function() {
		// 跳页
		var pn = $(this).attr("href");
		loadconsigneeinfo($(":radio[name='userId']:checked").val(), pn);
		return false;
	});

	$("#sjdztable tfoot input").keydown(
			function(event) {
				if (event.which == 13) {
					var pn = $(this).val();
					if (/^\d*$/.test(pn)) {
						loadconsigneeinfo($(":radio[name='userId']:checked")
								.val(), pn);
					} else {
						alert("只能输入数字");
					}
					$(this).blur();
				}
			});
	
	/*
	 * kai 20151026
	 * 添加禁用省请市区事件
	 * */
	$("#use_pct").click(function() {
		
		if($("#use_pct").is(':checked')==true)
		{
			$("#loc_province").attr("disabled","disabled");
			$("#loc_city").attr("disabled","disabled");
			$("#loc_town").attr("disabled","disabled");
			
		}
		else
		{
			$("#loc_province").removeAttr("disabled");
			$("#loc_city").removeAttr("disabled");
			$("#loc_town").removeAttr("disabled");
		}
	});
	
	
//alert("8888");
	loadChannelSelectOption();
	findEmptyStoragePosition();

	loadMsjFirstUserList();
	$("#a_back_empty_order_list_link").click(function() {
		nav59Click();
		return false;
	});
	$(":text[name='from_user_name']").change(function() {
		$(":radio[name='userId']").attr("checked", false);
		$(":radio[name='consigneeId']").attr("checked", false);
	});
	$(":text[name='premiumtotal']").change(countpremiummoney);
	
	$(":text[name='jwweight']").change(msOrderCalcFreight);
	
	$(":text[name='weight']").change(msOrderCalcFreight);
	$(":text[name='tariff']").change(msOrderCalcFreight);
	$(":text[name='other']").change(msOrderCalcFreight);
	$(":text[name='premium']").change(msOrderCalcFreight);
	$("select[name='commodityName']").change(msOrderCalcFreight);
	$(":text[name='length']").change(msOrderCalcFreight);
	$(":text[name='width']").change(msOrderCalcFreight);
	$(":text[name='height']").change(msOrderCalcFreight);
	$(":text[name='sjweight']").change(msOrderCalcFreight);

	$("#searchBt").click(function() {
		var key = $(":text[name='key']").val();
		$(":text[name='from_user_name']").val("");
		$(":text[name='from_user_real_name']").val("");
		loadMsjUserList(key);
		return false;
	});

	//获取保险的比例额度
	//var flags="print_order_hit,print_site_url";//获取logo图片,包裹提示,网站的url
	var flags="premium_rate";//
	 $.ajax({
			type : "post",
			url : admin_globalargs_getcontents_url,
			data : {
				"flags" : flags
			},
			success : function(response) {
				var code = response.code;

				//alert(code);
				if ("200" == code) {
					//alert(response.data[0]);
					$(":hidden[name='premiumratevalue']").val(response.data[0]);
				}
				else
				{
					$(":hidden[name='premiumratevalue']").val("0");
				}
			}
	 });
	
	// kai 20150912 添加重量改变onChange="msOrderCalcFreight()"
	$("#a_add_commodify_info")
			.click(
					function() {
						var commodity = $("select[name='commodityName']")
								.html();
						var str = '<p>'
								+ '<label style="display: inline;">商品类型：</label>'
								+ '<select name="commodityName" onChange="msOrderCalcFreight()" style="width: 100px; margin-right: 20px;" class="text-input">'
								+ commodity
								+

								'</select>&nbsp;商品数量：<input  name="commodifyQuantity" type="text" value="1" style="width:70px"class="text-input" />&nbsp;包裹信息：'
								+ '<input type="text" name="commodifyxiangqing" placeholder="填写具体物品信息"style="width:120px"class="text-input" />'
								+'&nbsp;&nbsp; 品牌:<input type="text" name="commodifybrands" placeholder="填写具体物品品牌" style="width:120px" class="text-input">'
								+ '&nbsp;&nbsp; 实际重量:<input name="jwweight" onChange="msOrderCalcFreight()" placeholder="不为空" type="text" style="width:70px" class="text-input" value="0"/>'
								+ '&nbsp;&nbsp; 计费重量:<input name="sjweight" onChange="msOrderCalcFreight()" readonly="readonly" type="text" style="width:70px" class="text-input" value="0"/>'
								+
								// '&nbsp;计费重量：<input name="jfweight"
								// placeholder="不为空"style="width:70px"
								// class="text-input"/>'+
								'&nbsp;&nbsp;<a href="#" name="a_delete_commodify_info">删除</a></p>';
						$("#commodify_infos").append(str);
						$("a[name='a_delete_commodify_info']").click(
								function() {
									$(this).parent().remove();
									msOrderCalcFreight();
									return false;
								});
						return false;
					});

	$("a[name='a_delete_commodify_info']").click(function() {
		$(this).parent().remove();
		return false;
	});

	$("#modify_empty_order_bt")
			.click(
					function() {
						var id = $(":hidden[name=id]").val();
						var userId = $(":radio[name='userId']:checked").val();
						var orderId =  $(":hidden[name=oid]").val();
						
						
						var fromUserName = $(":text[name='from_user_name']")
								.val();
						var fromUserRealName = $(
								":text[name='from_user_real_name']").val();
						var cName = $(":text[name='cName']").val();
						var cProvince="";
						var cCity="";
						var cDistrict="";
						var validate = true;
						if($("#use_pct").is(':checked')==true)//禁止使用
						{
						
						}
						else
						{
							cProvince = $("#loc_province option:checked")
							.text();
							cCity = $("#loc_city option:checked").text();
							cDistrict = $("#loc_town option:checked").text();
							
							
							
							if (cProvince == "省份") {
								$("#loc_province").css({
									"border-color" : "red"
								});
								$("#loc_province").change(function() {
									if ($("#loc_province").val() != null)
										$("#loc_province").css({
											"border-color" : ""
										});
								});
								validate = false;
								cProvince="";
							}
							if (cCity == "地级市") {
								$("#loc_city").css({
									"border-color" : "red"
								});
								$("#loc_city").change(function() {
									if ($("#loc_city").val() != null)
										$("#loc_city").css({
											"border-color" : ""
										});
								});
								validate = false;
								cCity="";
							}
							if (cDistrict == "市、县、区") {
								$("#loc_town").css({
									"border-color" : "red"
								});
								$("#loc_town").change(function() {
									if ($("#loc_town").val() != null)
										$("#loc_town").css({
											"border-color" : ""
										});
								});
								validate = false;
								
							}
							
							
						}
						
						var cid = $("select[name='cid']").val();// 通道号

						// kai 20150912 modify 把参数先保存到隐藏位置，在提交图片等信息时会提取

						
						$(":hidden[name='cUserId']").val(userId);
						$(":hidden[name='channelidname']").val(cid);

						var cStreetAddress = $(":text[name='cStreetAddress']")
								.val();
						var cZipCode = $(":text[name='cZipCode']").val();
						var cPhone = $(":text[name='cPhone']").val();

						var weight = $(":text[name='weight']").val();
						var sum_weight = $(":text[name='sum_weight']").val();
						var weightKg = $(":text[name='weightKg']").val();
						// alert(weightKg);
						var tariff = $(":text[name='tariff']").val();
						// var or = $(":text[name='or']").val();
						var other = $(":text[name='other']").val();
						var mail = $("select[name='mail']").val();
						var premium = $(":text[name='premium']").val();
						// var premium="0";o_del_check_all
						var remark = $("textarea[name='remark']").val();
						// var xiangqing=
						// $(":text[name='commodifyxiangqing']").val();

						var length = $(":text[name='length']").val();
						var width = $(":text[name='width']").val();
						var height = $(":text[name='height']").val();
						var parceValue = $(":text[name='parceValue']").val();
						var cardid = $(":text[name='cardidname']").val();
						var cardurl = $(":text[name='idurlcard']").val();
						cardurl = encodeURI(cardurl);
						var cardurlother = $(":text[name='idurlcardother']").val();
						cardurlother = encodeURI(cardurlother);
						var cardurltogether= $(":text[name='idurlcardtogether']").val();
						cardurltogether = encodeURI(cardurltogether);
						
						//alert(cardurlother);
						//alert(cardurltogether);
						
						
						
						
						

						if (cid == null || cid == "-1") {
							$("select[name='cid']").css({
								"border-color" : "red"
							});
							$("select[name='cid']")
									.change(
											function() {
												if ($("select[name='cid']")
														.val() != null
														&& !$(
																"select[name='cid']")
																.val() == "-1")
													$("select[name='cid']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						/*
						 * if (typeof(userId) == "undefined") {
						 * $("#u5402").css({ "border-color": "red" });
						 * $(":radio[name='userId']").change(function(){
						 * $("#u5402").css({ "border-color": "" }); }); validate =
						 * false; }
						 */
						if (fromUserName == "" || fromUserName == null) {
							$(":text[name='fromUserName']").css({
								"border-color" : "red"
							});
							$(":text[name='fromUserName']").change(
									function() {
										if ($(":text[name='fromUserName']")
												.val() != null)
											$(":text[name='fromUserName']")
													.css({
														"border-color" : ""
													});
									});
							validate = false;
						}

						if (cName == "" || cName == null) {
							$(":text[name='cName']").css({
								"border-color" : "red"
							});
							$(":text[name='cName']").change(function() {
								if ($(":text[name='cName']").val() != null)
									$(":text[name='cName']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}

						if (cProvince == "省份") {
							/*$("#loc_province").css({
								"border-color" : "red"
							});
							$("#loc_province").change(function() {
								if ($("#loc_province").val() != null)
									$("#loc_province").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cProvince="";
						}
						if (cCity == "地级市") {
							/*$("#loc_city").css({
								"border-color" : "red"
							});
							$("#loc_city").change(function() {
								if ($("#loc_city").val() != null)
									$("#loc_city").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cCity="";
						}
						if (cDistrict == "市、县、区") {
							/*$("#loc_town").css({
								"border-color" : "red"
							});
							$("#loc_town").change(function() {
								if ($("#loc_town").val() != null)
									$("#loc_town").css({
										"border-color" : ""
									});
							});
							validate = false;*/
							cDistrict="";
						}
						$(":hidden[name='cProvince']").val(cProvince);
						$(":hidden[name='cCity']").val(cCity);
						$(":hidden[name='cDistrict']").val(cDistrict);
						if (cStreetAddress == "" || cStreetAddress == null) {
							$(":text[name='cStreetAddress']").css({
								"border-color" : "red"
							});
							$(":text[name='cStreetAddress']").change(
									function() {
										if ($(":text[name='cStreetAddress']")
												.val() != null)
											$(":text[name='cStreetAddress']")
													.css({
														"border-color" : ""
													});
									});
							validate = false;
						}

						if (cZipCode == "" || cZipCode == null) {
							$(":text[name='cZipCode']").css({
								"border-color" : "red"
							});
							$(":text[name='cZipCode']").change(function() {
								if ($(":text[name='cZipCode']").val() != null)
									$(":text[name='cZipCode']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}
						if (cPhone == "" || cPhone == null) {
							$(":text[name='cPhone']").css({
								"border-color" : "red"
							});
							$(":text[name='cPhone']").change(function() {
								if ($(":text[name='cPhone']").val() != null)
									$(":text[name='cPhone']").css({
										"border-color" : ""
									});
							});
							validate = false;
						}

						if (weight == "" || weight == null || isNaN(weight)
								|| weight == "0") {
							$(":text[name='weight']").css({
								"border-color" : "red"
							});
							$(":text[name='weight']")
									.change(
											function() {
												if ($(":text[name='weight']")
														.val() != null
														&& !isNaN($(
																":text[name='weight']")
																.val())
														&& $(
																":text[name='weight']")
																.val() > 0)
													$(":text[name='weight']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (length == "" || length == null || isNaN(length)) {
							$(":text[name='length']").css({
								"border-color" : "red"
							});
							$(":text[name='length']")
									.change(
											function() {
												if ($(":text[name='length']")
														.val() != null
														&& !isNaN($(
																":text[name='length']")
																.val()))
													$(":text[name='length']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (width == "" || width == null || isNaN(width)) {
							$(":text[name='width']").css({
								"border-color" : "red"
							});
							$(":text[name='width']")
									.change(
											function() {
												if ($(":text[name='width']")
														.val() != null
														&& !isNaN($(
																":text[name='width']")
																.val()))
													$(":text[name='width']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (height == "" || height == null || isNaN(height)) {
							$(":text[name='height']").css({
								"border-color" : "red"
							});
							$(":text[name='height']")
									.change(
											function() {
												if ($(":text[name='height']")
														.val() != null
														&& !isNaN($(
																":text[name='height']")
																.val()))
													$(":text[name='height']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						if (isNaN(parceValue)) {
							$(":text[name='parceValue']").css({
								"border-color" : "red"
							});
							$(":text[name='parceValue']")
									.change(
											function() {
												if (!isNaN($(
														":text[name='parceValue']")
														.val()))
													$(
															":text[name='parceValue']")
															.css(
																	{
																		"border-color" : ""
																	});
											});
							validate = false;
						}

						var details = [];
						var i = 0;
						$("select[name='commodityName']")
								.each(
										function() {
											var detail = [];
											detail[0] = $(this).val();
											var cxiangqingObj = $(this)
													.parent()
													.find(
															":input[name='commodifyxiangqing']");
											var cquantityObj = $(this)
													.parent()
													.find(
															":input[name='commodifyQuantity']");

											detail[1] = cquantityObj.val();
											detail[2] = cxiangqingObj.val();
											detail[3] = $(this).parent().find(
													":input[name='sjweight']")
													.val();
											detail[4] = $(this).parent().find(
											":input[name='commodifybrands']")
											.val();
											
											detail[5] = $(this).parent().find(
											":input[name='jwweight']")
											.val();
											
											// detail[4] =
											// $(this).parent().find(":input[name='jfweight']").val();

											var cxiangqing = cxiangqingObj
													.val();
											var cquantity = cquantityObj.val();

											if (cquantity == ""
													|| cquantity == null
													|| isNaN(cquantityObj.val())) {
												cquantityObj.css({
													"border-color" : "red"
												});
												cquantityObj
														.change(function() {
															if (cquantityObj
																	.val() != null
																	&& !isNaN(cquantityObj
																			.val()))
																cquantityObj
																		.css({
																			"border-color" : ""
																		});
														});
												validate = false;
											}
											if (cxiangqing == ""
													|| cxiangqing == null) {
												cxiangqingObj.css({
													"border-color" : "red"
												});
												cxiangqingObj
														.change(function() {
															if (cxiangqingObj
																	.val() != null)
																cxiangqingObj
																		.css({
																			"border-color" : ""
																		});
														});
												validate = false;
											}

											details[i] = detail;
											i = i + 1;
										});

						if (i == 0) {
							alert("运单商品不能为空，请按添加商品按钮，填写商品信息!");
							return false;
						}
						if (!validate) {
							alert("红色框中的信息必须正确填写，才可以提交！");
							return false;
						}

						
						var totalmoney=$(":text[name='totalmoney']").val();
						var totalp = parseFloat(totalmoney);
						if (totalp == "NaN") {
						alert("计算总价钱出错，请检查格式!");
						return false;
						}
						if(totalp<0)
						{
							alert("总价钱不能小于0!");
							return false;
						}
						
						var file = $(":file[name='file']").val();
						//kai 20150921
						var fileother = $(":file[name='fileother']").val();
						// alert(file);
						if ((file != null && file != '')||(fileother != null && fileother != '')) {

							addorderhavepic();
							return false;
						}

						//alert(cardurlother);
						//alert(cardurltogether);

						if (typeof (userId) == "undefined") {
							$
									.ajax({
										type : "post",
										url : "../admin/emptyorder_no_userid/modify_submit",
										data : $.param({
											id : id,
											userId : fromUserName, // 暂时这样处理
											orderId : orderId,
											userName : fromUserRealName,
											cName : cName,
											cProvince : cProvince,
											cCity : cCity,
											cDistrict : cDistrict,
											cStreetAddress : cStreetAddress,
											cZipCode : cZipCode,
											cPhone : cPhone,
											weight : weight,
											jwweight : sum_weight,
											tariff : tariff,
											or : "0",
											other : other,
											mail : mail,
											premium : premium,
											remark : remark,
											orderCommoditys : details,
											length : length,
											width : width,
											height : height,
											parceValue : parceValue,
											channelId : cid,
											cardid : cardid,
											cardurl : cardurl,
											weightKg : weightKg,
											cardurlother : cardurlother,
											cardurltogether : cardurltogether,
											senduserName:fromUserRealName,
											senduserphone:fromUserName,
											"storagePosition.id" : document.getElementById("storagePositionId").value
											}, true),
										success : function(response) {
											var code = response.code;
											if ("200" == code) {
												/*var url = admin_msg_order_pay_page_url
														+ "?id="
														+ response.data["id"]
														+ "&oid="
														+ response.data["orderId"];
												$("#main-content").load(url);*/
												var printtype=document.getElementById("paysuccessprint").checked;
												
												
												if(document.getElementById("submitopentype").checked){
													var url = "../admin/index.jsp"
														+ "?id="
														+ id
														+ "&oid="
														+ orderId
														+ "&locationid=1"
														+ "&printtype="
														+ printtype;
												        window.open(url);//在新窗口中打开
												}
												else
												{
													var url = admin_msg_order_pay_page_url
													+ "?id="
													+ id
													+ "&oid="
													+ orderId
													+ "&printtype="
													+ printtype;
											        $("#main-content").load(url);//在原有窗口中打开
												}
											} else {
												alert("操作失败，失败原因是:"
														+ response.message);
											}
										}
									});
						} else {
							$
							.ajax({
								type : "post",
								url : "../admin/emptyorder/submit_haveuserid",
								data : $.param({
									userId : userId,
									orderId : orderId,
									cName : cName,
									cProvince : cProvince,
									cCity : cCity,
									cDistrict : cDistrict,
									cStreetAddress : cStreetAddress,
									cZipCode : cZipCode,
									cPhone : cPhone,
									weight : weight,
									jwweight : sum_weight,
									tariff : tariff,
									or : "0",
									other : other,
									mail : mail,
									premium : premium,
									remark : remark,
									orderCommoditys : details,
									length : length,
									width : width,
									height : height,
									parceValue : parceValue,
									channelId : cid,
									cardid : cardid,
									cardurl : cardurl,
									weightKg : weightKg,
									cardurlother : cardurlother,
									cardurltogether : cardurltogether,
									senduserName : fromUserRealName,
									senduserphone:fromUserName,
									"storagePosition.id" : document.getElementById("storagePositionId").value
								}, true),
								success : function(response) {
									var code = response.code;
									if ("200" == code) {
										/*var url = admin_msg_order_pay_page_url
												+ "?id="
												+ response.data["id"]
												+ "&oid="
												+ response.data["orderId"];*/
										   //$("#main-content").load(url);
										var printtype=document.getElementById("paysuccessprint").checked;
										if(document.getElementById("submitopentype").checked){
											var url = "../admin/index.jsp"
												+ "?id="
												+ id
												+ "&oid="
												+ orderId
												+ "&locationid=1"
												+ "&printtype="
												+ printtype;
										        window.open(url);//在新窗口中打开
										}
										else
										{
											var url = admin_msg_order_pay_page_url
											+ "?id="
											+ id
											+ "&oid="
											+ orderId
											+ "&printtype="
											+ printtype;
									        $("#main-content").load(url);//在原有窗口中打开
										}
										
										
												
										
									} else {
										alert("操作失败，失败原因是:"
												+ response.message);
									}
								}
							});
						}

						return false;
					});
	
}

// kai 20150919-1 //装载仓库及相关联的数据
function loadconinfo_wsjd() {
	$.ajax({
		type : "get",
		async : true,
		url : "../user/warehouse/all",
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					var str = "";
					$.each(response.data, function() {
						str += "<option value='" + this.id + "'>" + this.name
								+ "</option>";
					});
					$("select[name='wid']").html(str);
					showChannelTable_wsjd();

					// showChannelTableInTM();

					$("select[name='wid']").change(showChannelTable_wsjd);
					// loadCommoditySelectOption1();
				}
			}
		}
	});
}

function showChannelTable_wsjd() {

	var wid = $("select[name='wid']").val();
	// alert(wid);
	// $("select[name='cid']").html("<option >请选择渠道</option>");
	$.ajax({
		post : "get",
		url : "../channel/all",
		data : {
			"wid" : wid
		},
		success : function(response) {
			var code = response.code;
			if ("200" == code) {
				if (response.data == null) {
					alert("门店中没有该运单的渠道，请联系系统管理员！");
				} else {
					// var str = "<option>请选择渠道</option>";
					var str = "";
					$.each(response.data, function() {
						str += '<option value="' + this.id + '">' + this.name
								+ '</option>';
					});
					$("select[name='cid']").html(str);
					// showCommodityTableInTM();
					// alert("77777");
					loadCommoditySelectOption1();
					$("select[name='cid']").change(loadCommoditySelectOption1);

				}

			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

function loadCommoditySelectOption1() {

	var wid = $("select[name='wid']").val();
	var cid = $("select[name='cid']").val();
	// alert(cid);
	var additivePrice=$("select[name='cid']").find("option:selected").attr("additivePrice");
	$(":text[name='addtivePrice']").val(additivePrice);
	

	$("a[name='a_delete_commodify_info']").parent().parent().remove();// 删除所有已经存在的商品列表
	// alert("7888");
	// 添加商品头
	var str_temp = "";
	str_temp += '<tr>';

	str_temp += '<td>商品类别： <select name="commodityName"';
	str_temp += 'style="width:100px"></select> &nbsp;包裹详情：<input type="text"';
	str_temp += 'name="commodifyxiangqing" placeholder="填写具体物品信息"';
	str_temp += 'style="width:120px" /> &nbsp;商品数量：<input type="text"';
	str_temp += 'name="commodifyQuantity" style="width:100px" maxlength="5" />';
	str_temp += '<a href="#" name="a_delete_commodify_info">删除</a></td>';
	str_temp += '</tr>';
	$("#ttable tbody").html(str_temp);
	// alert("9999");

	// alert("8888");
	$.ajax({
		post : "get",
		// url : commodity_all_url,
		url : "../commodity/all",
		data : {
			"wid" : wid,
			"cid" : cid
		// 设置渠道
		},
		success : function(response) {

			var code = response.code;
			if ("200" == code) {
				// showCommodityList(response.data);;

				var str = "";
				// alert("5555");
				$.each(response.data, function() {
					str += "<option value='" + this.id + "'  price='"
							+ this.price + "' msPrice='" + this.msPrice + "' >"
							+ this.name + "</option>";
				});
				// alert(str);
				$("select[name='commodityName']").html(str);
			} else if ("607" == code) {
				alert("您尚未登录或登录已失效！");
				logout();
			}
		}
	});
}

// kai 20150914 在线置单时，分箱html模板，num是进行拆分的第几个
function add_online_order_html(num) {

}
function showTranshipInfo(tranship) {
	
	var str_temp = "";
	if (tranship.transitType == 0) {
		str_temp = "普通转运";

	} else if (tranship.transitType == 1) {
		str_temp = "极速转运";
		
	} else if (tranship.transitType == 2) {
		str_temp = "购物转运";
		
	} else {
		str_temp = "未知类型";
	}
	
	
	$("#u_ordertype").html(str_temp);
	$("#from_user_info").html(tranship.userRealName+"/"+tranship.userName+"/id:"+tranship.userId+"/唯一标识:"+tranship.useralias+" - "+tranship.usercode);
	$("#to_user_info").html(tranship.cName+" "+tranship.cPhone+" "+tranship.cProvince+" "+tranship.cCity+" "+tranship.cDistrict+" "+tranship.cStreetAddress+" "+tranship.cZipCode);
	$("#u_transitNo").html(tranship.transitNo);
	$("#u_orderId").html(tranship.orderId);
	str_temp="";
	$
	.each(
			tranship.commoditys,
			function() {
				
				str_temp+="名称："+this.commodityName+";数量："+this.quantity+";重量："+this.sjweight+";sku:"+this.commoditySku+";归属包裹："+this.transitNo+";转运仓库号:"+this.tranWarehouseId+"<br/>";
			});
	
	
	$("#commodify_info").html(str_temp);
	
	
	
	str_temp="";
	str_temp+="转运费用:"+tranship.or;
	str_temp+=";其它费用:"+tranship.other;
	str_temp+=";总费用:"+tranship.totalMoney;
	
	$("#money_info").html(str_temp);
	str_temp="<span style='color:red;'>"+tranship.wrongRemark+"</span>";
	$("#otherall_info").html(str_temp);
	
	$("#remark_info").html(tranship.remark);
	
	
	

}
function nav516_Data()
{
	//alert("5566");
	//loadNav553Data();
	$("#a_back_tran_route_list_link").click(function() {
		nav51Click();
		return false;
	});
	
	$.ajax({
		type : "get",
		url : admin_tranship_show_one_url,
		data : {
			id : $(":hidden[name='oid']").val()
		},
		success : function(response) {
			var code = response.code;
			if (code == '200') {
				if (response.data != null) {
					// alert("asdfaf");
					showTranshipInfo(response.data);
					// afterShowModifyTranshipInfo(response.data.commoditys);
				} else {
					alert("数据库中没有对应id的转运单信息.");
					// $("#nav51").click();
					nav51Click();
				}
			} else if (code == '607') {
				alert("您尚未登录或登录已失效！");
				logout();
			} else {
				alert("根据id获取转运单信息失败,失败原因是：" + response.message);
				// $("#nav51").click();
				nav51Click();
			}
		}
	});
}

